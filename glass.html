<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PHM">
    <link rel="apple-touch-icon" href="loading-logo.gif">
    <link rel="apple-touch-icon" sizes="180x180" href="light_mode_logo.png">
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAMklEQVR42u3MMQ0AIAzDsP6v7SPl8gWQEG1zkRCX9PqygwAAAADgMfhWcAAAgIADwDfAV71YqyCAAAAAElFTkSuQmCC">
    <title>PHM - Population Health Management</title>
    <!-- Supabase JS from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow: hidden;
            /* Account for safe areas (browser UI bars) - with fallback values */
            padding-top: env(safe-area-inset-top, 0);
            padding-bottom: env(safe-area-inset-bottom, 0);
            padding-left: env(safe-area-inset-left, 0);
            padding-right: env(safe-area-inset-right, 0);
        }


        header {
            background: #ffffff;
            border-bottom: 1px solid #e0e0e0;
            padding: 12px 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        header h1 {
            font-size: 20px;
            font-weight: 700;
            color: #1a1a1a;
            text-align: left;
            margin: 0;
        }

        .header-brand {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 12px;
        }

        .header-logo {
            width: 72px;
            height: 72px;
            object-fit: contain;
        }

        .header-title {
            font-size: 20px;
            font-weight: 700;
            color: #1a1a1a;
            line-height: 1.1;
            white-space: nowrap;
        }

        .header-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .error-banner {
            display: none;
            align-items: center;
            padding: 10px 16px;
            background: #ffe8e6;
            color: #8a1f1f;
            border-bottom: 1px solid #f5c1bc;
            font-size: 13px;
            gap: 8px;
        }

        .error-banner.active {
            display: flex;
        }

        .dark-mode .error-banner {
            background: #2a1b1b;
            color: #f6d7d4;
            border-bottom-color: #4a2a2a;
        }

        .header-meta {
            display: flex;
            flex-direction: column;
            gap: 2px;
            align-items: flex-start;
            flex-wrap: nowrap;
            font-size: 11px;
            color: #666;
        }

        header .subtitle {
            font-size: 11px;
            color: #555;
            text-align: left;
            margin: 0;
            font-weight: 400;
            white-space: nowrap;
            line-height: 1.3;
        }

        .last-updated {
            font-size: 11px;
            color: #666;
            margin: 0;
            white-space: nowrap;
            line-height: 1.3;
        }

        .last-updated-date {
            color: #f6a623;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theme-toggle {
            position: relative;
            width: 52px;
            height: 28px;
            border: 1px solid #dcdcdc;
            background: #e9e9e9;
            border-radius: 999px;
            cursor: pointer;
            padding: 0;
            transition: background 0.2s ease, border-color 0.2s ease;
            font-size: 0;
            line-height: 0;
        }

        .theme-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: #ffffff;
            border-radius: 50%;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, background 0.2s ease, box-shadow 0.2s ease;
        }

        .theme-toggle:hover {
            background: #f1f1f1;
            border-color: #cfcfcf;
        }

        .dark-mode .theme-toggle {
            background: #2a323d;
            border-color: #3a4351;
        }

        .dark-mode .theme-toggle::after {
            transform: translateX(24px);
            background: #0f1115;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.35);
        }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        .dark-mode {
            background: #0f1115;
            color: #e8e8e8;
        }

        .dark-mode header {
            background: #161a20;
            border-bottom-color: #262c36;
            box-shadow: 0 1px 6px rgba(0, 0, 0, 0.4);
        }

        .dark-mode .header-title,
        .dark-mode header h1,
        .dark-mode .subtitle,
        .dark-mode .last-updated {
            color: #e8e8e8;
        }

        .dark-mode .last-updated-date {
            color: #f6a623;
        }

        .dark-mode .theme-toggle {
            background: #161a20;
            color: #e8e8e8;
            border-color: #2a323d;
        }

        .dark-mode .theme-toggle:hover {
            background: #1d222b;
        }

        .dark-mode footer {
            background: #161a20;
            border-top-color: #262c36;
        }

        .dark-mode footer p {
            color: #bfc7d1;
        }


        .dark-mode .card {
            background: rgba(24, 28, 36, 0.9);
            border: 1px solid #2a323d;
            color: #e8e8e8;
        }

        .dark-mode .template-header h2,
        .dark-mode .dm-template h2,
        .dark-mode .predm-template h2 {
            color: #e8e8e8;
        }

        .dark-mode .subtitle {
            color: #bfc7d1;
        }

        .dark-mode .metric-label,
        .dark-mode .dm-metric-label,
        .dark-mode .predm-metric-label {
            color: #d3d8df;
        }

        /* Dark mode text for metric values */
        .dark-mode .metric-value,
        .dark-mode .dm-metric-value,
        .dark-mode .dm-value,
        .dark-mode .predm-metric-value,
        .dark-mode .predm-value,
        .dark-mode .predm-normal-value,
        .dark-mode .predm-nofollowup-value {
            color: #e8e8e8;
        }

        .dark-mode .zones-title {
            color: #e0e6ee;
        }

        .dark-mode .zone-item {
            background: #1d222b;
            border-left-color: #007aff;
            color: #e8e8e8;
        }

        .dark-mode .zone-header {
            background: #1d222b;
            color: #d8deea;
            border: 1px solid #2a323d;
        }

        .dark-mode .zones-title {
            color: #e8e8e8;
        }

        .dark-mode .zone-name {
            color: #e8e8e8;
        }

        .dark-mode .zone-name-text {
            color: #f2f4f8;
            font-weight: 600;
        }

        .dark-mode .zone-value {
            color: #f6c37f;
        }

        .dark-mode #zoneDetailTitle {
            color: #f2f4f8 !important;
        }

        footer {
            background: #ffffff;
            border-top: 1px solid #e0e0e0;
            padding: 12px 20px;
            box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.05);
            z-index: 10;
        }

        footer p {
            font-size: 12px;
            color: #888;
            text-align: center;
        }

        .container {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: stretch;
            padding: 10px;
            min-height: 0;
        }

        .container > .main-view {
            width: 100%;
            height: 100%;
        }

.carousel-wrapper {
            display: flex;
            flex-direction: column;
    width: 100%;
    height: 100%;
            position: relative;
    overflow: hidden;
    padding: 0 8px;
    box-sizing: border-box;
}

.carousel-dots {
    display: flex;
    justify-content: center;
    gap: 8px;
    padding: 8px 0 12px 0;
    position: relative;
    flex-shrink: 0;
    z-index: 5;
}

.carousel-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    border: none;
    background: #d0d0d0;
    transition: width 0.2s ease, background 0.2s ease;
}

.carousel-dot.active {
    width: 20px;
    border-radius: 999px;
    background: #666;
}

.dark-mode .carousel-dot {
    background: #3a4250;
}

.dark-mode .carousel-dot.active {
    background: #007aff;
}

.dark-mode .container,
.dark-mode .carousel-wrapper,
.dark-mode .carousel {
    background: #0f1115;
}


.carousel {
    display: flex;
    width: 100%;
    flex: 1;
    min-height: 0;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    gap: 12px;
    touch-action: pan-x;
    scrollbar-width: none;
    align-items: flex-start;
}

.carousel-wrapper {
    display: flex;
    flex-direction: column;
}
.carousel::-webkit-scrollbar {
            display: none;
}

        .card {
            background: #ffffff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e8e8e8;
            flex: 0 0 100%;
            width: 100%;
            height: auto;
            display: flex;
            flex-direction: column;
            min-height: 0;
            margin: 0;
            box-sizing: border-box;
            max-height: none;
            overflow: visible;
            scroll-snap-align: start;
        }

        /* Set fixed height for all cards (but cluster and zone views override this) */
        .carousel .card {
            height: 700px;
            max-height: 700px;
        }

        /* Cluster cards (main carousel) - 20% smaller */
        #carousel .card {
            height: auto !important;
            max-height: calc(100vh - 200px) !important;
            padding: 16px;
            padding-bottom: 32px;
            border-radius: 9.6px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        #carousel .screen-count-template,
        #carousel .dm-template,
        #carousel .predm-template {
            gap: 12.8px;
            flex: 0 1 auto;
            min-height: 0;
        }

        #carousel .template-header {
            padding-bottom: 6.4px;
            padding-top: 4px;
            position: sticky;
            top: 0;
            background: #ffffff;
            z-index: 10;
            transition: all 0.2s ease;
            margin-top: -16px;
            margin-left: -16px;
            margin-right: -16px;
            padding-left: 16px;
            padding-right: 16px;
            padding-top: 16px;
            border-radius: 9.6px 9.6px 0 0;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .dark-mode #carousel .template-header {
            background: rgba(24, 28, 36, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #carousel .template-header h2 {
            font-size: 13.6px;
            margin-bottom: 3.2px;
            transition: font-size 0.2s ease, margin-bottom 0.2s ease;
        }

        #carousel .template-header .subtitle {
            font-size: 8.8px;
            transition: font-size 0.2s ease;
        }

        #carousel .metrics-section {
            gap: 9.6px;
        }

        #carousel .metric-row {
            padding: 6.4px 0;
        }

        #carousel .metric-label {
            font-size: 12.8px;
        }

        #carousel .metric-value {
            font-size: 16px;
        }

        #carousel .metric-percent {
            font-size: 9.6px;
            margin-right: 4.8px;
        }

        #carousel .metric-count {
            font-size: 14.4px;
        }

        #carousel .zones-ranking {
            gap: 8px;
            padding-bottom: 16px;
        }

        #carousel .zones-title {
            font-size: 12.8px;
            margin-bottom: 4.8px;
        }

        #carousel .zone-header {
            gap: 9.6px;
            padding: 6.4px 8px;
            margin-bottom: 6.4px;
            margin-top: -12.8px;
            font-size: 10.4px;
        }

        #carousel .zone-item {
            padding: 6.4px 8px;
            border-radius: 4.8px;
            gap: 9.6px;
        }

        #carousel .zone-rank {
            font-size: 12.8px;
            min-width: 24px;
        }

        #carousel .zone-name {
            font-size: 12px;
        }

        #carousel .zone-value {
            font-size: 12.8px;
        }

        #carousel .dm-template {
            gap: 12.8px;
        }

        #carousel .dm-metric-row {
            padding: 8px 0;
        }

        #carousel .dm-metric-label {
            font-size: 12.8px;
        }

        #carousel .dm-metric-value {
            font-size: 16px;
        }

        #carousel .dm-metric-value.dm-percent {
            font-size: 9.6px;
        }

        #carousel .dm-metric-value-container {
            gap: 3.2px;
        }

        #carousel .predm-template {
            gap: 12.8px;
        }

        #carousel .predm-metric-row {
            padding: 8px 0;
        }

        #carousel .predm-metric-label {
            font-size: 12.8px;
        }

        #carousel .predm-metric-value {
            font-size: 16px;
        }

        /* Zone detail cards should be 620px */
        /* Zone detail cards - 20% smaller */
        #zoneDetailCarousel .card {
            height: auto !important;
            max-height: calc(100vh - 200px) !important;
            padding: 16px;
            padding-bottom: 32px;
            border-radius: 9.6px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        #zoneDetailCarousel .screen-count-template,
        #zoneDetailCarousel .dm-template,
        #zoneDetailCarousel .predm-template {
            gap: 12.8px;
            overflow: visible;
            flex: 0 1 auto;
            min-height: 0;
        }

        #zoneDetailCarousel .template-header {
            padding-bottom: 6.4px;
            padding-top: 4px;
            position: sticky;
            top: 0;
            background: #ffffff;
            z-index: 10;
            transition: all 0.2s ease;
            margin-top: -16px;
            margin-left: -16px;
            margin-right: -16px;
            padding-left: 16px;
            padding-right: 16px;
            padding-top: 16px;
            border-radius: 9.6px 9.6px 0 0;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .dark-mode #zoneDetailCarousel .template-header {
            background: rgba(24, 28, 36, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #zoneDetailCarousel .template-header h2 {
            font-size: 13.6px;
            margin-bottom: 3.2px;
            transition: font-size 0.2s ease, margin-bottom 0.2s ease;
        }

        #zoneDetailCarousel .template-header .subtitle {
            font-size: 8.8px;
            transition: font-size 0.2s ease;
        }

        #zoneDetailCarousel .metrics-section {
            gap: 9.6px;
        }

        #zoneDetailCarousel .metric-row {
            padding: 6.4px 0;
        }

        #zoneDetailCarousel .metric-label {
            font-size: 12.8px;
        }

        #zoneDetailCarousel .metric-value {
            font-size: 16px;
        }

        #zoneDetailCarousel .metric-percent {
            font-size: 9.6px;
            margin-right: 4.8px;
        }

        #zoneDetailCarousel .metric-count {
            font-size: 14.4px;
        }

        #zoneDetailCarousel .zones-ranking {
            gap: 8px;
            padding-bottom: 16px;
        }

        #zoneDetailCarousel .zones-title {
            font-size: 12.8px;
            margin-bottom: 4.8px;
        }

        #zoneDetailCarousel .zone-header {
            gap: 9.6px;
            padding: 6.4px 8px;
            margin-bottom: 6.4px;
            margin-top: -12.8px;
            font-size: 10.4px;
        }

        #zoneDetailCarousel .zone-item {
            padding: 6.4px 8px;
            border-radius: 4.8px;
            gap: 9.6px;
        }

        #zoneDetailCarousel .zone-rank {
            font-size: 12.8px;
            min-width: 24px;
        }

        #zoneDetailCarousel .zone-name {
            font-size: 12px;
        }

        #zoneDetailCarousel .zone-value {
            font-size: 12.8px;
        }

        #zoneDetailCarousel .dm-template {
            gap: 12.8px;
        }

        #zoneDetailCarousel .dm-metric-row {
            padding: 8px 0;
        }

        #zoneDetailCarousel .dm-metric-label {
            font-size: 12.8px;
        }

        #zoneDetailCarousel .dm-metric-value {
            font-size: 16px;
        }

        #zoneDetailCarousel .dm-metric-value.dm-percent {
            font-size: 9.6px;
        }

        #zoneDetailCarousel .dm-metric-value-container {
            gap: 3.2px;
        }

        #zoneDetailCarousel .predm-template {
            gap: 12.8px;
        }

        #zoneDetailCarousel .predm-metric-row {
            padding: 8px 0;
        }

        #zoneDetailCarousel .predm-metric-label {
            font-size: 12.8px;
        }

        #zoneDetailCarousel .predm-metric-value {
            font-size: 16px;
        }

        .card-content {
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        /* Allow card-content to expand naturally in cluster/zone views */
        #carousel .card-content,
        #zoneDetailCarousel .card-content {
            flex: 0 1 auto;
            overflow: visible;
            min-height: 0;
        }

        /* Screen Count Template Styles */
        .screen-count-template {
            display: flex;
            flex-direction: column;
            flex: 1;
            gap: 16px;
            min-height: 0;
            overflow: visible;
        }

        .template-header {
            text-align: center;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
            flex-shrink: 0;
        }
        
        .template-header h2 {
            font-size: 17px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .template-header .subtitle {
            font-size: 11px;
            color: #888;
        }

        .metrics-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex-shrink: 0;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .metric-label {
            font-size: 16px;
            color: #666;
            font-weight: 500;
        }

        .metric-value {
            font-size: 20px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .metric-percent {
            font-size: 12px;
            font-weight: 600;
            color: #777;
            margin-right: 6px;
        }

        .metric-count {
            font-size: 18px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .dark-mode .metric-percent {
            color: #bfc7d1;
        }

        .dark-mode .metric-count {
            color: #e8e8e8;
        }

        /* Loading Overlay Styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .loading-logo {
            width: 324px;
            height: 324px;
            object-fit: contain;
        }

        .loading-text {
            margin: 0;
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }

        .dark-mode .loading-text {
            color: #e8e8e8;
        }

        .target-value {
            color: #555;
        }

        .percentage-value {
            color: #333;
        }

        /* Pre-DM percentage displays */
        #preDMToNormalPercent,
        #zoneDetailPreDMToNormalPercent {
            display: inline;
            margin-right: 6px;
            font-size: 13px;
            font-weight: 500;
            color: #666;
        }

        #preDMNoFollowupPercent,
        #zoneDetailPreDMNoFollowupPercent {
            display: inline;
            margin-right: 6px;
            font-size: 13px;
            font-weight: 500;
            color: #666;
        }

        .dark-mode #preDMToNormalPercent,
        .dark-mode #zoneDetailPreDMToNormalPercent {
            color: #bfc7d1;
        }

        .dark-mode #preDMNoFollowupPercent,
        .dark-mode #zoneDetailPreDMNoFollowupPercent {
            color: #bfc7d1;
        }

        .indicator-positive {
            color: #4a9e5f;
        }

        .indicator-negative {
            color: #c85a5a;
        }

        .indicator-icon {
            font-size: 20px;
        }

        .zones-ranking {
            flex: 0 1 auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow: visible;
            padding-top: 0;
            padding-bottom: 16px;
            min-height: 0;
            position: relative;
        }

        .zones-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 6px;
            flex-shrink: 0;
        }

        .zone-header {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            padding: 8px 10px;
            background: #ffffff;
            border-radius: 0;
            margin-bottom: 8px;
            margin-top: -16px;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 5;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
        }

        .zone-header--predm {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .zone-header-item {
            text-align: center;
        }

        .zone-header-item:first-child {
            text-align: left;
        }

        .zone-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            background: #fafafa;
            border-radius: 6px;
            border-left: 2px solid #999;
            flex-shrink: 0;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease;
        }

        .zone-item:hover {
            background: #f0f0f0;
            transform: translateX(2px);
        }

        .zone-item:active {
            transform: translateX(0);
            background: #e8e8e8;
        }

        /* Ensure zone items and headers follow dark-mode background */
        .dark-mode .zone-item {
            background: #1d222b;
            border-left-color: #007aff;
        }

        .dark-mode .zone-item:hover {
            background: #252b35;
        }

        .dark-mode .zone-item:active {
            background: #1d222b;
        }

        .dark-mode .zone-header {
            background: #1d222b;
            border: 1px solid #2a323d;
            color: #d8deea;
            z-index: 5;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.25);
        }

        .zone-rank {
            font-size: 16px;
            font-weight: 600;
            color: #666;
            min-width: 30px;
        }

        .zone-name {
            flex: 1;
            font-size: 14px;
            color: #1a1a1a;
            min-width: 60px;
            position: relative;
        }
        
        .zone-value {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            min-width: 70px;
            text-align: center;
            flex: 0 0 90px;
        }

        .zone-7d-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 30px;
        }

        .zone-item--screening {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }

        .zone-item--screening .zone-name {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 0;
            min-width: calc(11ch + 24px); /* Enough for 11 letters + padding */
        }

        .zone-item--screening .zone-name-text {
            flex: 1;
            min-width: 0;
            color: #007aff;
            font-weight: 600;
            text-decoration: underline;
            text-underline-offset: 3px;
            transition: all 0.2s ease;
        }
        
        .zone-item--screening:hover .zone-name-text {
            color: #0051d5;
        }
        
        
        .dark-mode .zone-item--screening .zone-name-text {
            color: #5ac8fa;
        }
        
        .dark-mode .zone-item--screening:hover .zone-name-text {
            color: #7dd3fc;
        }

        .zone-item--screening .zone-rank {
            min-width: 24px;
        }

        .zone-item--screening .zone-value {
            flex: initial;
            min-width: 0;
            text-align: center;
        }

        .zone-item--screening .zone-7d-indicator {
            justify-content: center;
        }

        /* DM zone rows with three columns: Zone | Controlled | Uncontrolled */
        .zone-item--dm {
            display: grid;
            grid-template-columns: 1.2fr 1fr 1fr;
            gap: 12px;
        }

        .zone-item--dm .zone-name {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 0;
            min-width: calc(11ch + 24px); /* Enough for 11 letters + padding */
        }

        .zone-item--dm .zone-name-text {
            flex: 1;
            min-width: 0;
            color: #007aff;
            font-weight: 600;
            text-decoration: underline;
            text-underline-offset: 3px;
            transition: all 0.2s ease;
        }
        
        .zone-item--dm:hover .zone-name-text {
            color: #0051d5;
        }
        
        
        .dark-mode .zone-item--dm .zone-name-text {
            color: #5ac8fa;
        }
        
        .dark-mode .zone-item--dm:hover .zone-name-text {
            color: #7dd3fc;
        }

        .zone-item--dm .zone-value {
            text-align: center;
        }

        /* DM headers: 3 columns aligned with rows */
        .zone-header--dm {
            display: grid;
            grid-template-columns: 1.2fr 1fr 1fr;
            gap: 12px;
            align-items: center;
        }

        .zone-header--dm .zone-header-item {
            text-align: center;
        }

        .zone-header--dm .zone-header-item:first-child {
            text-align: left;
        }

        .zone-item--predm {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }

        .zone-item--predm .zone-name {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 0;
            min-width: calc(11ch + 24px); /* Enough for 11 letters + padding */
        }

        .zone-item--predm .zone-name-text {
            flex: 1;
            min-width: 0;
            color: #007aff;
            font-weight: 600;
            text-decoration: underline;
            text-underline-offset: 3px;
            transition: all 0.2s ease;
        }
        
        .zone-item--predm:hover .zone-name-text {
            color: #0051d5;
        }
        
        
        .dark-mode .zone-item--predm .zone-name-text {
            color: #5ac8fa;
        }
        
        .dark-mode .zone-item--predm:hover .zone-name-text {
            color: #7dd3fc;
        }

        /* Appointment Count Badge */
        .phc-appointment-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 18px;
            height: 18px;
            padding: 0 6px;
            background: #9C27B0;
            color: #ffffff;
            border-radius: 9px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
            line-height: 1;
        }

        .dark-mode .phc-appointment-badge {
            background: #BA68C8;
            color: #ffffff;
        }

        .phc-appointment-badge.zero {
            display: none; /* Hide badge if count is 0 */
        }

        .zone-item--predm .zone-rank {
            min-width: 24px;
        }

        .zone-item--predm .zone-value {
            flex: initial;
            min-width: 0;
            text-align: center;
        }

        .zone-item--predm .zone-7d-indicator {
            justify-content: center;
        }

        .zone-arrow {
            font-size: 18px;
            font-weight: bold;
            line-height: 1;
        }

        .zone-arrow-up {
            color: #4a9e5f;
        }

        .zone-arrow-down {
            color: #c85a5a;
        }

        .zone-arrow-neutral {
            color: #999;
        }

        /* Zone Detail Page Styles */
        .zone-detail-page {
            display: none;
            flex-direction: column;
            height: 100%;
            gap: 16px;
            min-height: 0;
        }

        .zone-detail-page.active {
            display: flex;
        }

        .zone-detail-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e0e0e0;
            flex-shrink: 0;
        }

        .back-button {
            background: transparent;
            border: none;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: opacity 0.2s ease;
            flex-shrink: 0;
            -webkit-tap-highlight-color: transparent;
            position: relative;
            color: #666;
            font-size: 18px;
            line-height: 1;
        }

        .back-button::before {
            content: '←';
            font-weight: 400;
        }

        .back-button:hover {
            opacity: 0.7;
        }

        .back-button:active {
            opacity: 0.5;
        }

        .dark-mode .back-button {
            color: #999;
        }

        /* Zone detail header (light and dark) */
        #zoneDetailView .zone-detail-header {
            background: #ffffff;
            border-bottom: 1px solid #e0e0e0;
        }

        .dark-mode #zoneDetailView .zone-detail-header {
            background: #161a20 !important;
            border-bottom-color: #262c36 !important;
        }

        .zone-detail-title {
            flex: 1;
        }

        .zone-detail-title h2 {
            font-size: 22px;
            font-weight: 700;
            color: #333;
            margin: 0;
        }

        .zone-detail-title .subtitle {
            font-size: 13px;
            color: #666;
            margin-top: 4px;
        }

        .zone-detail-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
        }

        .zone-detail-metrics {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        .zone-detail-metric {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 12px;
            border-left: 2px solid #667eea;
        }

        .zone-detail-metric-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
        }

        .zone-detail-metric-value {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .main-view {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        .main-view.hidden {
            display: none;
        }

        #zoneDetailView {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 20;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        #zoneDetailView .zone-detail-header {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #zoneDetailView .carousel-wrapper {
            flex: 1;
            min-height: 0;
            padding-top: 10px;
        }

        /* DM Patients Template Styles */
        .dm-template {
            display: flex;
            flex-direction: column;
            flex: 1;
            gap: 16px;
            min-height: 0;
            overflow: visible;
        }

        .dm-metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            flex-wrap: wrap;
        }

        .dm-metric-value-container {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Minimal percent styling (neutral color, lighter weight) */
        .dm-metric-value.dm-percent {
            font-size: 12px;
            font-weight: 400;
            color: #888 !important;
            order: 1;
        }

        .dark-mode .dm-metric-value.dm-percent {
            color: #a8b3c3 !important;
        }

        .dm-count {
            order: 2;
        }

        .dm-metric-label {
            font-size: 16px;
            color: #555;
            font-weight: 500;
        }
        
        .dm-metric-label-orange {
            font-size: 16px;
            color: #ff9800;
            font-weight: 600;
        }
        
        .dark-mode .dm-metric-label-orange {
            color: #ff9800;
        }

        .dm-metric-value {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .dm-value {
            color: #333;
        }

        .controlled-value {
            color: #333;
        }

        .uncontrolled-value {
            color: #333;
        }

        .dm-week-indicator {
            display: flex;
            align-items: center;
                gap: 6px;
            font-size: 16px;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Pre-DM Template Styles */
        .predm-template {
            display: flex;
            flex-direction: column;
            flex: 1;
            gap: 16px;
            min-height: 0;
            overflow: visible;
            overflow: visible;
        }

        .predm-metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            flex-wrap: wrap;
        }

        .predm-metric-label {
            font-size: 16px;
            color: #555;
            font-weight: 500;
        }
        
        .predm-metric-label-orange {
            font-size: 16px;
            color: #ff9800;
            font-weight: 600;
        }
        
        .dark-mode .predm-metric-label-orange {
            color: #ff9800;
        }

        .predm-metric-value {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .predm-value {
            color: #333;
        }

        .predm-normal-value {
            color: #333;
        }

        .predm-nofollowup-value {
            color: #333;
        }

        .predm-week-indicator {
            display: flex;
            align-items: center;
                gap: 6px;
            font-size: 16px;
            font-weight: 600;
            margin-left: 8px;
        }

        /* PHC Detail Dashboard Styles */
        .phc-dashboard-card {
            background: #ffffff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e8e8e8;
        }
        
        .dark-mode .phc-dashboard-card {
            background: rgba(24, 28, 36, 0.9);
            border: 1px solid #2a323d;
            color: #e8e8e8;
        }
        
        .phc-dashboard-header {
            margin-bottom: 24px;
        }
        
        .phc-dashboard-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0;
        }
        
        .dark-mode .phc-dashboard-header h3 {
            color: #e8e8e8;
        }
        
        .phc-dashboard-main-metric {
            text-align: center;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid #e8e8e8;
        }
        
        .dark-mode .phc-dashboard-main-metric {
            border-bottom-color: #2a323d;
        }
        
        .phc-metric-category {
            font-size: 14px;
            color: #666;
            font-weight: 500;
            margin-bottom: 12px;
        }
        
        .dark-mode .phc-metric-category {
            color: #bfc7d1;
        }
        
        .phc-metric-value-large {
            font-size: 56px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 8px;
            line-height: 1;
        }
        
        .dark-mode .phc-metric-value-large {
            color: #e8e8e8;
        }
        
        .phc-metric-percentage {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        
        .dark-mode .phc-metric-percentage {
            color: #bfc7d1;
        }
        
        .phc-dashboard-metrics-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .phc-dashboard-metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: transparent;
            border-radius: 8px;
        }
        
        .phc-dashboard-metric-item-orange {
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid rgba(255, 152, 0, 0.3);
        }
        
        .dark-mode .phc-dashboard-metric-item-orange {
            background: rgba(255, 152, 0, 0.15);
            border: 1px solid rgba(255, 152, 0, 0.4);
        }
        
        .phc-metric-label {
            font-size: 16px;
            color: #666;
            font-weight: 500;
            flex: 1;
        }
        
        .dark-mode .phc-metric-label {
            color: #bfc7d1;
        }
        
        .phc-metric-label-orange {
            font-size: 16px;
            color: #ff9800;
            font-weight: 600;
            flex: 1;
        }
        
        .phc-metric-value {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
        }
        
        .dark-mode .phc-metric-value {
            color: #e8e8e8;
        }
        
        #phcDetailView {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 30;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            padding: 0;
        }
        
        .dark-mode #phcDetailView {
            background: #0f1115;
        }
        
        .dark-mode #phcDetailView .zone-detail-header {
            background: #161a20 !important;
            border-bottom-color: #262c36 !important;
        }
        
        .dark-mode #phcDetailView .zone-detail-title h2 {
            color: #f2f4f8 !important;
        }
        
        #phcDetailView .carousel-wrapper {
            flex: 1;
            min-height: 0;
            padding-top: 10px;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        #phcDetailCarousel .card {
            height: 200px;
            max-height: 200px;
            flex: 0 0 auto;
            position: relative;
        }

        /* PHC detail cards - 20% smaller */
        #phcDetailCarousel .card {
            height: 160px;
            max-height: 160px;
            padding: 12.8px;
            border-radius: 9.6px;
            overflow: hidden;
        }
        
        #phcDetailCarousel .phc-card-appointments {
            transition: max-height 0.3s ease;
        }
        
        #phcDetailCarousel .phc-card-appointments.expanded {
            max-height: 500px;
            height: auto;
        }

        #phcDetailCarousel .phc-watch-dashboard {
            padding: 6.4px 11.2px;
            gap: 4.8px;
        }

        #phcDetailCarousel .phc-card-screening .phc-watch-dashboard,
        #phcDetailCarousel .phc-card-predm .phc-watch-dashboard,
        #phcDetailCarousel .phc-card-dm .phc-watch-dashboard {
            padding-left: 12.8px;
        }

        #phcDetailCarousel .phc-watch-header {
            margin-bottom: 4.8px;
            padding-bottom: 4.8px;
        }

        #phcDetailCarousel .phc-watch-header h2 {
            font-size: 10.4px;
        }

        #phcDetailCarousel .phc-watch-metrics {
            gap: 4.8px;
        }

        #phcDetailCarousel .phc-watch-metrics-row {
            gap: 9.6px;
        }

        #phcDetailCarousel .phc-watch-metric-large {
            padding: 3.2px 0;
        }

        #phcDetailCarousel .phc-watch-label {
            font-size: 7.2px;
            margin-bottom: 2.4px;
            letter-spacing: 0.24px;
        }

        #phcDetailCarousel .phc-watch-value {
            font-size: 22.4px;
            margin-bottom: 1.6px;
        }

        #phcDetailCarousel .phc-watch-percent {
            font-size: 8px;
            letter-spacing: 0.16px;
        }

        /* Support for combined percentage and count format in PHC view */
        #phcDetailCarousel .phc-watch-value .metric-percent {
            font-size: 9.6px;
            margin-right: 4.8px;
            font-weight: 600;
            color: #666;
        }

        #phcDetailCarousel .phc-watch-value .metric-count {
            font-size: 14.4px;
            font-weight: 700;
        }

        .dark-mode #phcDetailCarousel .phc-watch-value .metric-percent {
            color: #bfc7d1;
        }

        .dark-mode #phcDetailCarousel .phc-watch-value .metric-count {
            color: #ffffff;
        }

        #phcDetailCarousel .phc-watch-metric-small {
            padding: 4px 8px;
            border-radius: 6.4px;
        }

        #phcDetailCarousel .phc-watch-label-small {
            font-size: 6.4px;
            margin-bottom: 2.4px;
            letter-spacing: 0.24px;
        }

        #phcDetailCarousel .phc-watch-value-small {
            font-size: 12.8px;
        }
        
        /* شريط جانبي أزرق مات - Screening (نفس لون الشعار) */
        .phc-card-screening {
            border-left: 2px solid #6B9EF5; /* أزرق أفتح */
        }
        
        .dark-mode .phc-card-screening {
            border-left-color: #6B9EF5; /* أزرق أفتح قليلاً في الوضع الداكن */
        }
        
        /* شريط جانبي أخضر مات - Pre-DM (مناسب للمنصة الصحية) */
        .phc-card-predm {
            border-left: 2px solid #6BC86C; /* أخضر أفتح */
        }
        
        .dark-mode .phc-card-predm {
            border-left-color: #6BC86C; /* أخضر أفتح قليلاً في الوضع الداكن */
        }
        
        /* شريط جانبي برتقالي مات - DM (موشر انتباه رسمي وهادئ) */
        .phc-card-dm {
            border-left: 2px solid #FF9800; /* برتقالي أفتح */
        }
        
        .dark-mode .phc-card-dm {
            border-left-color: #FF9800; /* برتقالي أفتح قليلاً في الوضع الداكن */
        }
        
        /* شريط جانبي بنفسجي - Upcoming Appointments */
        .phc-card-appointments {
            border-left: 2px solid #BA68C8; /* بنفسجي أفتح */
        }
        
        .dark-mode .phc-card-appointments {
            border-left-color: #BA68C8; /* بنفسجي أفتح قليلاً في الوضع الداكن */
        }

        #phcDetailCarousel .phc-card-appointments {
            transition: max-height 0.3s ease;
            overflow: visible;
        }

        #phcDetailCarousel .phc-card-appointments.expanded {
            max-height: 500px;
        }
        
        #phcDetailCarousel .phc-card-appointments.expanded .card-content {
            overflow-y: auto;
        }
        
        /* Calendar Container */
        .phc-calendar-container {
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            width: 100%;
            min-height: 0;
        }

        /* Calendar Week View - 3 rows layout */
        .phc-calendar-week {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 4px 0;
            flex: 1;
        }

        .phc-calendar-row {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .phc-calendar-day {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px 2px;
            border-radius: 6px;
            background: rgba(156, 39, 176, 0.05);
            transition: background 0.2s ease;
            min-height: 40px;
            position: relative;
        }

        .phc-calendar-day.clickable {
            cursor: pointer;
        }

        .phc-calendar-day:not(.clickable) {
            cursor: default;
            opacity: 0.7;
        }

        .phc-calendar-day.clickable:hover {
            background: rgba(156, 39, 176, 0.15);
        }

        .dark-mode .phc-calendar-day {
            background: rgba(156, 39, 176, 0.1);
        }

        .dark-mode .phc-calendar-day.clickable:hover {
            background: rgba(156, 39, 176, 0.2);
        }

        /* Today indicator - no highlight, just a symbol (handled by indicator dot) */
        
        /* Today indicator dot - next to day name */
        .phc-calendar-today-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: #4caf50;
            border-radius: 50%;
            margin-left: 4px;
            vertical-align: middle;
        }
        
        .dark-mode .phc-calendar-today-indicator {
            background: #66bb6a;
        }

        /* Dates with appointments (but not today) - lighter highlight */
        .phc-calendar-day.has-appointments {
            background: rgba(156, 39, 176, 0.1);
            border: 1px solid rgba(156, 39, 176, 0.3);
            border-bottom: none;
            border-radius: 6px 6px 0 0;
        }

        .dark-mode .phc-calendar-day.has-appointments {
            background: rgba(156, 39, 176, 0.15);
            border-color: rgba(186, 104, 200, 0.4);
        }

        /* When date is today and has badge - no special highlight needed */

        /* When date has appointments (but not today) and has badge, connect with lighter highlight */
        .phc-calendar-day-badge-container.has-appointments {
            background: rgba(156, 39, 176, 0.1);
            border: 1px solid rgba(156, 39, 176, 0.3);
            border-top: none;
            border-radius: 0 0 6px 6px;
            margin-top: -4px; /* Overlap with the gap to connect seamlessly */
        }

        .dark-mode .phc-calendar-day-badge-container.has-appointments {
            background: rgba(156, 39, 176, 0.15);
            border-color: rgba(186, 104, 200, 0.4);
        }

        .phc-calendar-day-label {
            font-size: 7px;
            color: #888;
            text-transform: uppercase;
            font-weight: 500;
            text-align: center;
            padding: 2px 0;
            border-radius: 6px 6px 0 0;
            transition: background 0.2s ease;
        }

        /* Today indicator for day label - make it bigger and bold */
        .phc-calendar-day-label.today {
            font-size: 8px;
            font-weight: 700;
        }

        /* Today indicator for day label - no special styling needed */

        .dark-mode .phc-calendar-day-label {
            color: #bfc7d1;
        }

        .phc-calendar-day-number {
            font-size: 12px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .dark-mode .phc-calendar-day-number {
            color: #e8e8e8;
        }

        .phc-calendar-day-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 16px;
            height: 16px;
            padding: 0 4px;
            background: #9C27B0;
            color: #ffffff;
            border-radius: 8px;
            font-size: 8px;
            font-weight: 600;
            line-height: 1;
        }

        .dark-mode .phc-calendar-day-badge {
            background: #BA68C8;
        }

        .phc-calendar-day-badge.zero {
            display: none;
        }

        .phc-calendar-day-badge-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px 0;
            min-height: 20px;
            border-radius: 0 0 6px 6px;
            transition: background 0.2s ease;
        }

        .phc-calendar-day-badge-container.selected {
            background: rgba(156, 39, 176, 0.2);
        }

        .dark-mode .phc-calendar-day-badge-container.selected {
            background: rgba(156, 39, 176, 0.25);
        }

        /* Appointments List Styles */
        .phc-appointments-list {
            flex: 0 0 auto;
            overflow-y: auto;
            overflow-x: hidden;
            width: 100%;
            max-height: 400px;
            padding: 8px 0 0 0;
            display: none;
            flex-direction: column;
            animation: slideDown 0.3s ease;
        }

        .phc-appointments-list.expanded {
            display: flex;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .phc-appointments-list-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 0 8px 0;
            margin-bottom: 4px;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
        }

        .dark-mode .phc-appointments-list-header {
            border-bottom-color: #2a323d;
        }

        .phc-back-to-calendar {
            background: none;
            border: none;
            color: #9C27B0;
            font-size: 9px;
            font-weight: 600;
            cursor: pointer;
            padding: 2px 4px;
        }

        .dark-mode .phc-back-to-calendar {
            color: #BA68C8;
        }

        .phc-selected-date {
            font-size: 9px;
            font-weight: 600;
            color: #666;
        }

        .dark-mode .phc-selected-date {
            color: #bfc7d1;
        }

        .phc-appointments-slots {
            flex: 1;
            overflow-y: auto;
            padding: 4px 0;
        }
        
        .phc-appointment-item {
            display: flex;
            flex-direction: column;
            padding: 6px 8px;
            margin-bottom: 6px;
            background: rgba(156, 39, 176, 0.08);
            border-radius: 6px;
            border-left: 3px solid #9C27B0;
            font-size: 9px;
            line-height: 1.4;
        }
        
        .dark-mode .phc-appointment-item {
            background: rgba(156, 39, 176, 0.12);
            border-left-color: #BA68C8;
        }
        
        .phc-appointment-status {
            font-weight: 600;
            color: #9C27B0;
            margin-bottom: 2px;
            font-size: 8px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .dark-mode .phc-appointment-status {
            color: #BA68C8;
        }
        
        .phc-appointment-status.not-screened {
            color: #FF9800;
        }
        
        .dark-mode .phc-appointment-status.not-screened {
            color: #FFB74D;
        }
        
        .phc-appointment-status.dm-followup {
            color: #F57C00;
        }
        
        .dark-mode .phc-appointment-status.dm-followup {
            color: #FF9800;
        }
        
        .phc-appointment-status.predm-followup {
            color: #FF9800;
        }
        
        .dark-mode .phc-appointment-status.predm-followup {
            color: #FFB74D;
        }
        
        .phc-appointment-date {
            color: #666;
            font-size: 8px;
            margin-bottom: 2px;
        }
        
        .dark-mode .phc-appointment-date {
            color: #bfc7d1;
        }
        
        .phc-appointment-mrn {
            color: #888;
            font-size: 7px;
            font-family: monospace;
        }
        
        .dark-mode .phc-appointment-mrn {
            color: #a8b3c3;
        }
        
        .phc-appointment-department {
            color: #666;
            font-size: 8px;
            margin-top: 2px;
        }
        
        .dark-mode .phc-appointment-department {
            color: #bfc7d1;
        }
        
        .phc-appointment-loading,
        .phc-appointment-empty {
            text-align: center;
            color: #888;
            font-size: 9px;
            padding: 8px;
        }
        
        .dark-mode .phc-appointment-loading,
        .dark-mode .phc-appointment-empty {
            color: #bfc7d1;
        }
        
        /* PHC carousel - vertical layout */
        #phcDetailCarousel {
            flex-direction: column;
            scroll-behavior: smooth;
            scroll-snap-type: y mandatory;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            overflow-y: auto;
            overflow-x: hidden;
            gap: 12px;
            padding: 0 20px;
        }
        
        /* Cards in vertical layout */
        #phcDetailCarousel .card {
            width: 100%;
            scroll-snap-align: start;
        }
        
        /* Allow normal touch interaction for vertical scrolling */
        #phcDetailCarousel .card,
        #phcDetailCarousel .card-content,
        #phcDetailCarousel .phc-watch-dashboard {
            touch-action: auto;
            user-select: none;
            -webkit-user-select: none;
        }
        
        /* Allow text selection in specific areas if needed */
        #phcDetailCarousel .phc-watch-value,
        #phcDetailCarousel .phc-watch-value-small {
            user-select: text;
            -webkit-user-select: text;
        }
        
        /* PHC Watch-Style Dashboard - Apple Watch Minimalist Design */
        .phc-watch-dashboard {
            display: flex;
            flex-direction: column;
            height: 100%;
            justify-content: flex-start;
            align-items: center;
            padding: 8px 14px;
            gap: 6px;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        /* إضافة padding للداخل لإفساح المجال للشريط */
        .phc-card-screening .phc-watch-dashboard,
        .phc-card-predm .phc-watch-dashboard,
        .phc-card-dm .phc-watch-dashboard {
            padding-left: 16px; /* إضافة مسافة من اليسار */
        }
        
        .phc-watch-header {
            text-align: center;
            margin-bottom: 6px;
            padding-bottom: 6px;
            flex-shrink: 0;
            min-height: fit-content;
            position: relative;
            width: 100%;
        }
        
        .phc-watch-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            height: 1px;
            background: #e0e0e0;
        }
        
        .dark-mode .phc-watch-header::after {
            background: #2a323d;
        }
        
        .phc-watch-header h2 {
            font-size: 13px;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0;
            letter-spacing: -0.02em;
            word-wrap: break-word;
            white-space: normal;
            line-height: 1.2;
        }
        
        .dark-mode .phc-watch-header h2 {
            color: #e8e8e8;
        }
        
        .phc-watch-metrics {
            display: flex;
            flex-direction: column;
            gap: 6px;
            width: 100%;
            align-items: center;
            flex: 1;
            justify-content: flex-start;
            min-height: 0;
        }
        
        /* Container for side-by-side metrics (Screening and DM cards) */
        .phc-watch-metrics-row {
            display: flex;
            flex-direction: row;
            gap: 12px;
            width: 100%;
            justify-content: space-around;
            align-items: flex-start;
        }
        
        .phc-watch-metric-large {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: 100%;
            padding: 4px 0;
        }
        
        /* Side-by-side metrics take equal space */
        .phc-watch-metrics-row .phc-watch-metric-large {
            flex: 1;
            min-width: 0;
        }
        
        .phc-watch-label {
            font-size: 9px;
            font-weight: 500;
            color: #666;
            margin-bottom: 3px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .dark-mode .phc-watch-label {
            color: #bfc7d1;
        }
        
        .phc-watch-value {
            font-size: 28px;
            font-weight: 700;
            color: #1a1a1a;
            line-height: 1;
            margin-bottom: 2px;
            letter-spacing: -0.03em;
        }
        
        .dark-mode .phc-watch-value {
            color: #ffffff;
        }
        
        .phc-watch-percent {
            font-size: 10px;
            font-weight: 500;
            color: #666;
            letter-spacing: 0.2px;
        }
        
        .dark-mode .phc-watch-percent {
            color: #bfc7d1;
        }
        
        .phc-watch-metric-small {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: 100%;
            padding: 5px 10px;
            background: rgba(255, 152, 0, 0.08);
            border-radius: 8px;
            border: 1px solid rgba(255, 152, 0, 0.2);
        }
        
        .dark-mode .phc-watch-metric-small {
            background: rgba(255, 152, 0, 0.12);
            border: 1px solid rgba(255, 152, 0, 0.3);
        }
        
        /* Light reddish indicator for warning metrics */
        .phc-watch-metric-orange {
            background: rgba(239, 83, 80, 0.08) !important; /* Light reddish background */
            border: 1px solid rgba(239, 83, 80, 0.2) !important; /* Light reddish border */
        }
        
        .dark-mode .phc-watch-metric-orange {
            background: rgba(239, 83, 80, 0.12) !important;
            border: 1px solid rgba(239, 83, 80, 0.3) !important;
        }
        
        .phc-watch-metric-orange .phc-watch-label-small {
            color: #E57373 !important; /* Light reddish for label */
        }
        
        .dark-mode .phc-watch-metric-orange .phc-watch-label-small {
            color: #EF9A9A !important; /* Lighter reddish in dark mode */
        }
        
        .phc-watch-label-small {
            font-size: 8px;
            font-weight: 600;
            color: #ff9800;
            margin-bottom: 3px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            line-height: 1.2;
            word-wrap: break-word;
            white-space: normal;
            text-align: center;
        }
        
        .phc-watch-value-small {
            font-size: 16px;
            font-weight: 700;
            color: #1a1a1a;
            line-height: 1;
        }
        
        .dark-mode .phc-watch-value-small {
            color: #ffffff;
        }

        /* iPhone and Android specific adjustments */
        @media screen and (max-width: 480px) {
            header {
                padding: 10px 16px;
            }

            header h1 {
                font-size: 18px;
            }

            footer {
                padding: 8px 16px;
            }

            .container {
                padding: 8px;
            }

            .card {
                padding: 14px;
                border-radius: 12px;
                margin: 0 4px;
            }

            .screen-count-template {
                gap: 12px;
            }

            .template-header h2 {
                font-size: 18px;
            }

            .template-header {
                padding-bottom: 10px;
            }

            .metric-row {
                padding: 6px 0;
            }
            
            .metric-label {
                font-size: 13px;
            }

            .metric-value {
                font-size: 16px;
            }

            .zones-title {
                font-size: 14px;
                margin-bottom: 4px;
            }

            .zone-item {
                padding: 6px 8px;
            }

            .zone-rank {
                font-size: 14px;
                min-width: 25px;
            }

            .zone-name {
                font-size: 13px;
                min-width: 50px;
            }

            .zone-value {
                font-size: 13px;
                min-width: 45px;
            }

            .zone-7d-indicator {
                min-width: 25px;
            }

            .zone-arrow {
                font-size: 16px;
            }

            .dm-metric-row {
                padding: 8px 0;
            }

            .dm-metric-label {
                font-size: 13px;
            }

            .dm-metric-value {
                font-size: 16px;
            }

            .dm-week-indicator {
                font-size: 14px;
            }

            .predm-metric-row {
                padding: 8px 0;
            }

            .predm-metric-label {
                font-size: 13px;
            }

            .predm-metric-value {
                font-size: 16px;
            }

            .predm-week-indicator {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <img src="loading-logo.gif" alt="Loading" class="loading-logo">
            <p class="loading-text">Loading data...</p>
        </div>
    </div>
    <div id="loadError" class="error-banner" role="alert" aria-live="polite">
        Unable to load data. Please check your connection and try again.
    </div>
    <header style="display: none;">
        <!-- Header hidden when in iframe - controlled by parent index.html -->
        <div class="last-updated" id="lastUpdated">Last update: <span class="last-updated-date" id="lastUpdatedValue">--</span></div>
    </header>
    <div class="container">
        <div class="main-view" id="mainView">
            <div class="carousel-wrapper">
                <div class="carousel-dots" id="carouselDots"></div>
                <div class="carousel" id="carousel">
                    <div class="card">
                    <div class="card-content">
                        <div class="screen-count-template">
                            <div class="template-header">
                                <h2>Population Coverage</h2>
                                <div class="subtitle">Performance Overview</div>
            </div>
                            <div class="metrics-section">
                                <div class="dm-metric-row">
                                    <span class="dm-metric-label">Population</span>
                                    <span class="dm-metric-value dm-value" id="targetValue">0</span>
        </div>
                                <div class="dm-metric-row">
                                    <span class="dm-metric-label">Screened</span>
                                    <div class="dm-metric-value-container">
                                        <span class="dm-metric-value dm-percent" id="currentValuePercent">0%</span>
                                        <span class="dm-metric-value dm-count" id="currentValue">0</span>
                                    </div>
    </div>
                                <div class="dm-metric-row">
                                    <span class="dm-metric-label">Remaining</span>
                                    <div class="dm-metric-value-container">
                                        <span class="dm-metric-value dm-percent" id="percentageValuePercent">0%</span>
                                        <span class="dm-metric-value dm-count" id="percentageValue">0</span>
                                    </div>
        </div>
                                <div class="dm-metric-row">
                                    <span class="dm-metric-label">Missed Screening Opportunities</span>
                                    <span class="dm-metric-value dm-value" id="opportunitiesValue">0</span>
                                </div>
        </div>
                            <div class="zones-ranking" id="screeningZonesList">
                                <div class="zone-item">
                                    <span class="zone-name">Loading...</span>
                        </div>
                        </div>
            </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-content">
                        <div class="dm-template">
                            <div class="template-header">
                                <h2>DM Patients</h2>
                                <div class="subtitle">Diabetes Management Overview</div>
            </div>
                            <div class="metrics-section">
                                <div class="dm-metric-row">
                                    <span class="dm-metric-label">DM Patients</span>
                                    <span class="dm-metric-value dm-value" id="dmPatientsValue">0</span>
                </div>
                                <div class="dm-metric-row">
                                    <span class="dm-metric-label">Controlled DM</span>
                                    <div class="dm-metric-value-container">
                                        <span class="dm-metric-value controlled-value dm-percent" id="controlledDMPercent">0%</span>
                                        <span class="dm-metric-value controlled-value dm-count" id="controlledDMValue">0</span>
                                    </div>
                                </div>
                                <div class="dm-metric-row">
                                    <span class="dm-metric-label">Uncontrolled DM</span>
                                    <div class="dm-metric-value-container">
                                        <span class="dm-metric-value uncontrolled-value dm-percent" id="uncontrolledDMPercent">0%</span>
                                        <span class="dm-metric-value uncontrolled-value dm-count" id="uncontrolledDMValue">0</span>
                                    </div>
                                </div>
            </div>
                            <div class="zones-ranking" id="dmZonesList">
                                <div class="zone-item">
                                    <span class="zone-name">Loading...</span>
                </div>
                </div>
            </div>
        </div>
    </div>
                <div class="card">
                    <div class="card-content">
                        <div class="predm-template">
                            <div class="template-header">
                                <h2>Pre-DM Patients</h2>
                                <div class="subtitle">Pre-Diabetes Management Overview</div>
    </div>
                            <div class="metrics-section">
                                <div class="dm-metric-row">
                                    <span class="dm-metric-label">Pre-DM Patients</span>
                                    <span class="dm-metric-value dm-value" id="preDMPatientsValue">0</span>
                                </div>
                                <div class="dm-metric-row">
                                    <span class="dm-metric-label">Pre-DM to Normal</span>
                                    <div class="dm-metric-value-container">
                                        <span class="dm-metric-value dm-percent" id="preDMToNormalPercent">0%</span>
                                        <span class="dm-metric-value dm-count" id="preDMToNormalValue">0</span>
                                    </div>
                                </div>
                                <div class="dm-metric-row">
                                    <span class="dm-metric-label">Pre-DM No Follow-up</span>
                                    <div class="dm-metric-value-container">
                                        <span class="dm-metric-value dm-percent" id="preDMNoFollowupPercent">0%</span>
                                        <span class="dm-metric-value dm-count" id="preDMNoFollowupValue">0</span>
                                    </div>
            </div>
                    </div>
                            <div class="zones-ranking" id="predmZonesList">
                                <div class="zone-item">
                                    <span class="zone-name">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <div class="main-view" id="zoneDetailView" style="display: none;">
            <div class="zone-detail-header" style="padding: 16px 20px; background: #ffffff; border-bottom: 1px solid #e0e0e0;">
                <button class="back-button" id="zoneDetailBackButton" onclick="goBackToMain()" aria-label="Go back" style="display: none;"></button>
                <div class="zone-detail-title" style="flex: 1; text-align: left;">
                    <h2 id="zoneDetailTitle" style="margin: 0; font-size: 20px; font-weight: 600; color: #1a1a1a;">Zone Details</h2>
                    <div class="subtitle" style="font-size: 10px; color: #888; margin-top: 2px;">PHC Performance</div>
                </div>
            </div>
            <div class="carousel-wrapper">
                <div class="carousel-dots" id="zoneDetailCarouselDots"></div>
                <div class="carousel" id="zoneDetailCarousel">
                    <div class="card">
                        <div class="card-content">
                            <div class="screen-count-template">
                                <div class="template-header">
                                    <h2>Population Coverage</h2>
                                    <div class="subtitle">Performance Overview</div>
                                </div>
                                <div class="metrics-section">
                                    <div class="dm-metric-row">
                                        <span class="dm-metric-label">Population</span>
                                        <span class="dm-metric-value dm-value" id="zoneDetailTargetValue">0</span>
                                    </div>
                                    <div class="dm-metric-row">
                                        <span class="dm-metric-label">Screened</span>
                                        <div class="dm-metric-value-container">
                                            <span class="dm-metric-value dm-percent" id="zoneDetailScreenedValuePercent">0%</span>
                                            <span class="dm-metric-value dm-count" id="zoneDetailScreenedValue">0</span>
                                        </div>
                                    </div>
                                    <div class="dm-metric-row">
                                        <span class="dm-metric-label">Remaining</span>
                                        <div class="dm-metric-value-container">
                                            <span class="dm-metric-value dm-percent" id="zoneDetailRemainingValuePercent">0%</span>
                                            <span class="dm-metric-value dm-count" id="zoneDetailRemainingValue">0</span>
                                        </div>
                                    </div>
                                    <div class="dm-metric-row">
                                        <span class="dm-metric-label">Missed Screening Opportunities</span>
                                        <span class="dm-metric-value dm-value" id="zoneDetailOpportunitiesValue">0</span>
                                    </div>
                                </div>
                                <div class="zones-ranking" id="zoneDetailScreeningPHCs">
                                    <div class="zone-item">
                                        <span class="zone-name">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-content">
                            <div class="dm-template">
                                <div class="template-header">
                                    <h2>DM Patients</h2>
                                    <div class="subtitle">Diabetes Management Overview</div>
                                </div>
                                <div class="metrics-section">
                                    <div class="dm-metric-row">
                                        <span class="dm-metric-label">DM Patients</span>
                                        <span class="dm-metric-value dm-value" id="zoneDetailDMPatientsValue">0</span>
                                    </div>
                                    <div class="dm-metric-row">
                                        <span class="dm-metric-label">Controlled DM</span>
                                    <div class="dm-metric-value-container">
                                        <span class="dm-metric-value controlled-value dm-percent" id="zoneDetailControlledDMPercent">0%</span>
                                            <span class="dm-metric-value controlled-value dm-count" id="zoneDetailControlledDMValue">0</span>
                                    </div>
                                </div>
                                <div class="dm-metric-row">
                                    <span class="dm-metric-label">Uncontrolled DM</span>
                                    <div class="dm-metric-value-container">
                                        <span class="dm-metric-value uncontrolled-value dm-percent" id="zoneDetailUncontrolledDMPercent">0%</span>
                                            <span class="dm-metric-value uncontrolled-value dm-count" id="zoneDetailUncontrolledDMValue">0</span>
                                    </div>
                                </div>
                                </div>
                                <div class="zones-ranking" id="zoneDetailDMPHCs">
                                    <div class="zone-item">
                                        <span class="zone-name">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-content">
                            <div class="predm-template">
                                <div class="template-header">
                                    <h2>Pre-DM Patients</h2>
                                    <div class="subtitle">Pre-Diabetes Management Overview</div>
                                </div>
                                <div class="metrics-section">
                                    <div class="dm-metric-row">
                                        <span class="dm-metric-label">Pre-DM Patients</span>
                                        <span class="dm-metric-value dm-value" id="zoneDetailPreDMPatientsValue">0</span>
                                    </div>
                                    <div class="dm-metric-row">
                                        <span class="dm-metric-label">Pre-DM to Normal</span>
                                        <div class="dm-metric-value-container">
                                            <span class="dm-metric-value dm-percent" id="zoneDetailPreDMToNormalPercent">0%</span>
                                            <span class="dm-metric-value dm-count" id="zoneDetailPreDMToNormalValue">0</span>
                                        </div>
                                    </div>
                                    <div class="dm-metric-row">
                                        <span class="dm-metric-label">Pre-DM No Follow-up</span>
                                        <div class="dm-metric-value-container">
                                            <span class="dm-metric-value dm-percent" id="zoneDetailPreDMNoFollowupPercent">0%</span>
                                            <span class="dm-metric-value dm-count" id="zoneDetailPreDMNoFollowupValue">0</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="zones-ranking" id="zoneDetailPreDMPHCs">
                                    <div class="zone-item">
                                        <span class="zone-name">Loading...</span>
                                    </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        <div class="main-view" id="phcDetailView" style="display: none;">
            <div class="zone-detail-header" style="padding: 16px 20px; background: #ffffff; border-bottom: 1px solid #e0e0e0;">
                <button class="back-button" id="phcDetailBackButton" onclick="goBackToZone()" aria-label="Go back"></button>
                <div class="zone-detail-title" style="flex: 1; text-align: left;">
                    <h2 id="phcDetailTitle" style="margin: 0; font-size: 20px; font-weight: 600; color: #1a1a1a;">PHC Details</h2>
                    <div class="subtitle" style="font-size: 10px; color: #888; margin-top: 2px;">PHC Performance</div>
                </div>
            </div>
            <div class="carousel-wrapper">
                <div class="carousel-dots" id="phcDetailCarouselDots"></div>
                <div class="carousel" id="phcDetailCarousel">
                    <!-- Screening Card -->
                    <div class="card phc-card-screening">
                        <div class="card-content">
                            <div class="phc-watch-dashboard">
                                <div class="phc-watch-header">
                                    <h2>Screening</h2>
                                </div>
                                <div class="phc-watch-metrics">
                                    <!-- Side-by-side container for Screening metrics -->
                                    <div class="phc-watch-metrics-row">
                                        <div class="phc-watch-metric-large">
                                            <div class="phc-watch-label">Screened</div>
                                            <div class="phc-watch-value" id="phcScreenedCount">0</div>
                                            <div class="phc-watch-percent" id="phcScreenedPercent">0%</div>
                                        </div>
                                        <div class="phc-watch-metric-large">
                                            <div class="phc-watch-label">Remaining</div>
                                            <div class="phc-watch-value" id="phcScreeningRemaining">0</div>
                                            <div class="phc-watch-percent" id="phcRemainingPercent">0%</div>
                                        </div>
                                    </div>
                                    <div class="phc-watch-metric-small phc-watch-metric-orange">
                                        <div class="phc-watch-label-small" id="phcMissedScreeningLabel">Missed Screening Opportunities on --</div>
                                        <div class="phc-watch-value-small" id="phcMissedScreeningCount">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pre-DM Card -->
                    <div class="card phc-card-predm">
                        <div class="card-content">
                            <div class="phc-watch-dashboard">
                                <div class="phc-watch-header">
                                    <h2>Pre-DM Follow-up</h2>
                                </div>
                                <div class="phc-watch-metrics">
                                    <div class="phc-watch-metric-large">
                                        <div class="phc-watch-label">Pre-DM Patients</div>
                                        <div class="phc-watch-value" id="phcPreDMTotal">0</div>
                                    </div>
                                    <div class="phc-watch-metric-small phc-watch-metric-orange">
                                        <div class="phc-watch-label-small">PRE-DM with no follow-up, 90 Days+</div>
                                        <div class="phc-watch-value-small" id="phcFollowupPreDM90">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- DM Card -->
                    <div class="card phc-card-dm">
                        <div class="card-content">
                            <div class="phc-watch-dashboard">
                                <div class="phc-watch-header">
                                    <h2>Diabetes Follow-up</h2>
                                </div>
                                <div class="phc-watch-metrics">
                                    <!-- Side-by-side container for DM metrics -->
                                    <div class="phc-watch-metrics-row">
                                        <div class="phc-watch-metric-large">
                                            <div class="phc-watch-label">Uncontrolled DM</div>
                                            <div class="phc-watch-value" id="phcUncontrolledDMCount">0</div>
                                            <div class="phc-watch-percent" id="phcUncontrolledDMPercent">0%</div>
                                        </div>
                                        <div class="phc-watch-metric-large">
                                            <div class="phc-watch-label">Controlled DM</div>
                                            <div class="phc-watch-value" id="phcControlledDMCount">0</div>
                                            <div class="phc-watch-percent" id="phcControlledDMPercent">0%</div>
                                        </div>
                                    </div>
                                    <div class="phc-watch-metric-small phc-watch-metric-orange">
                                        <div class="phc-watch-label-small">Uncontrolled DM with no follow-up 30 Days+</div>
                                        <div class="phc-watch-value-small" id="phcFollowupDM30">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Upcoming Appointments Card -->
                    <div class="card phc-card-appointments">
                        <div class="card-content">
                            <div class="phc-watch-dashboard">
                                <div class="phc-watch-header">
                                    <h2>Upcoming Appointments</h2>
                                </div>
                                <div class="phc-calendar-container">
                                    <div class="phc-calendar-week" id="phcCalendarWeek">
                                        <!-- Calendar dates will be generated here -->
                                    </div>
                                    <div class="phc-appointments-list" id="phcAppointmentsList">
                                        <div class="phc-appointments-list-header">
                                            <button class="phc-back-to-calendar" onclick="showCalendarView()">← Collapse</button>
                                            <div class="phc-selected-date" id="phcSelectedDate"></div>
                                        </div>
                                        <div class="phc-appointments-slots" id="phcAppointmentsSlots">
                                            <!-- Appointment slots will be shown here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer>
        <p>2025 Alhaalha</p>
    </footer>
    <script>
        (function() {
            const carousel = document.getElementById('carousel');
            const dotsContainer = document.getElementById('carouselDots');
            const cards = Array.from(carousel.querySelectorAll('.card'));
            
            // Only show dots if there are multiple cards (swipeable)
            if (dotsContainer && cards.length > 1) {
                const dots = [];
                cards.forEach((_, i) => {
                    const dot = document.createElement('button');
                    dot.type = 'button';
                    dot.className = 'carousel-dot';
                    dot.setAttribute('aria-label', `Go to slide ${i + 1}`);
                    dot.addEventListener('click', () => {
                        carousel.scrollTo({
                            left: i * carousel.clientWidth,
                            behavior: 'smooth'
                        });
                    });
                    dotsContainer.appendChild(dot);
                    dots.push(dot);
                });

                const updateDots = () => {
                    const index = Math.round(carousel.scrollLeft / carousel.clientWidth);
                    dots.forEach((dot, idx) => dot.classList.toggle('active', idx === index));
                };

                let scrollTimeout;
                carousel.addEventListener('scroll', () => {
                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(updateDots, 50);
                }, { passive: true });

                window.addEventListener('resize', () => {
                    carousel.scrollTo({
                        left: Math.round(carousel.scrollLeft / carousel.clientWidth) * carousel.clientWidth,
                        behavior: 'auto'
                    });
                    updateDots();
                });

                updateDots();
            } else if (dotsContainer) {
                // Hide dots if only one card (not swipeable)
                dotsContainer.style.display = 'none';
            }
        })();
    </script>
    <script>
        // Zone full names
        const ZONE_FULL_NAMES = {
            BGH: 'Bader Aljanoob General Hospital',
            HGH: 'Hubona General Hospital',
            KGH: 'Khubash General Hospital',
            KKH: 'King Khaled Hospital',
            MCH: 'Maternity and Children Hospital',
            WNH: 'West Najran General Hospital',
            NNGH: 'New Najran General Hospital',
            SGH: 'Sharourah General Hospital',
            TGH: 'Thar General Hospital',
            YGH: 'Yaddamah General Hospital'
        };

        // PHC to Zone mapping
        const PHC_ZONE_MAP = {
            "AL- qarn": "BGH",
            "Hadadah health center": "BGH",
            "Primary Care Alkhaniq": "BGH",
            "alrehab Primary care center": "BGH",
            "bader aljanoob primary health care": "BGH",
            "maleha public health center": "BGH",
            "AL JAFFAH PHCC": "HGH",
            "ALMONTSHER  PHCC": "HGH",
            "Habuna primary Health Care Center": "HGH",
            "al harshar phcc": "HGH",
            "dekah": "HGH",
            "majma": "HGH",
            "AL-SHARAA": "KGH",
            "KHUBASH Health center": "KGH",
            "Primary Health Care Center GOILLA": "KGH",
            "junoob matar": "KGH",
            "mishaliya": "KGH",
            "taslal health center": "KGH",
            "ALDUBAT PHCC": "KKH",
            "Al Faisaliah Health Center": "KKH",
            "Aqfah phcc": "KKH",
            "Biraskar phcc": "KKH",
            "Primary Health Care Center DIYAFA": "KKH",
            "al contub": "KKH",
            "khaldiya health center": "KKH",
            "primary health care center north": "KKH",
            "prince mishal health center": "KKH",
            "al fahad al janubi phcc": "MCH",
            "Al Fahad Al Janubi PHCC": "MCH",
            "Al Fahad Al Janubi phcc": "MCH",
            "al fahad al janubi PHCC": "MCH",
            "atheabah phcc": "MCH",
            "Al Safa Health Center": "WNH",
            "Al muratah phcc": "WNH",
            "Alhadan PHCC": "WNH",
            "Health Center algabil": "WNH",
            "Health center in aljurbah": "WNH",
            "PHCC Abasoud": "WNH",
            "albalad": "WNH",
            "dahada helth center": "WNH",
            "eam phcc reer": "WNH",
            "health center al mufja": "WNH",
            "Primary Health Care Center in Nhogah": "WNH",
            "Shebhan phcc": "WNH",
            "Al Arisa Health Center": "NNGH",
            "Alhamar phcc": "NNGH",
            "HUSSAINIAH PHCC": "NNGH",
            "RIJLA PHcc": "NNGH",
            "primary health care center barrk": "NNGH",
            "primary health care center of shurfa": "NNGH",
            "Wadi Riman Health Center": "NNGH",
            "Alakashim Health Center": "SGH",
            "Aziziyah PHCC Sharoora": "SGH",
            "RAWDAH phcc Sharoora": "SGH",
            "Security Forces PHCC Sharoora": "SGH",
            "Sultanaa PHCC Sharoora": "SGH",
            "Tamani phcc Sharoura": "SGH",
            "alwadia phcc sharoora": "SGH",
            "khaldiya sharoorah health center": "SGH",
            "hema phcc": "TGH",
            "naiwan phcc": "TGH",
            "qattan phcc": "TGH",
            "suffah phcc": "TGH",
            "talham phcc": "TGH",
            "thar phcc": "TGH",
            "tilah phcc": "TGH",
            "legam primary health care center": "YGH",
            "mohammadia phcc": "YGH",
            "sultana primaryhealth care center": "YGH",
            "wadi wasat": "YGH",
            "yadama primary health care center": "YGH"
        };

        // PHC Display Names mapping
        const PHC_DISPLAY_NAMES = {
            "hema phcc": "Hema",
            "naiwan phcc": "Na'wan",
            "qattan phcc": "Qattan",
            "suffah phcc": "Suffah",
            "talham phcc": "Talham",
            "thar phcc": "Thar",
            "tilah phcc": "Tila'h",
            "Alhamar phcc": "Al Hamar",
            "HUSSAINIAH PHCC": "Al Hussainiah",
            "primary health care center barrk": "Berrk",
            "primary health care center of shurfa": "Al Shurfah",
            "RIJLA PHcc": "Rijla",
            "Wadi Riman Health Center": "Wadi Riman",
            "alrehab Primary care center": "Al Rehab",
            "bader aljanoob primary health care": "Bader Al Janoob",
            "Hadadah health center": "Hadadah",
            "maleha public health center": "Al Maleha",
            "Primary Care Alkhaniq": "Al Khaniq",
            "al harshar phcc": "Al Harshaf",
            "AL JAFFAH PHCC": "Al Jaffah",
            "ALMONTSHER PHCC": "Al Montsher",
            "dekah": "Al Dekah",
            "Habuna primary Health Care Center": "Habuna",
            "majma": "Al Majma",
            "Al Faisaliah Health Center": "Al Faisaliah",
            "ALDUBAT PHCC": "Al Dubat",
            "Aqfah phcc": "Aqfah",
            "Biraskar phcc": "Bir Askar",
            "khaldiya health center": "Al Khaldiah",
            "Primary Health Care Center DIYAFA": "Al Diyafah",
            "primary health care center north": "Al Fahad Alshimaly",
            "prince mishal health center": "Prince Mishal",
            "Alakashim Health Center": "Al Akhashim",
            "Al Arisa Health Center": "Al Arisa",
            "alwadia phcc sharoora": "Alwadia",
            "Aziziyah PHCC Sharoora": "Aziziyah",
            "khaldiya sharoorah health center": "Khaldiya",
            "RAWDAH phcc Sharoora": "Rawdah",
            "Security Forces PHCC Sharoora": "Security Forces",
            "Sultanaa PHCC Sharoora": "Sultanah",
            "Al muratah phcc": "Al Muratah",
            "Al Safa Health Center": "Al Safa",
            "albalad": "Albalad",
            "Alhadan PHCC": "Alhadan",
            "dahada helth center": "Dahada",
            "eam phcc reer": "Rir",
            "health center al mufja": "Al Mufja",
            "Health Center algabil": "Al Gabil",
            "Health center in aljurbah": "Al Jurbah",
            "PHCC Abasoud": "Aba Saoud",
            "Primary Health Care Center in Nhogah": "Nhogah",
            "Shebhan phcc": "Shabhan",
            "AL-SHARAA": "Al Kharaa",
            "junoob matar": "Junoob Al Matar",
            "KHUBASH Health center": "Khubash",
            "mishaliya": "Mishaliya",
            "Primary Health Care Center GOILLA": "Goilla",
            "taslal health center": "Taslal",
            "atheabah phcc": "Al Athaibah",
            "legam primary health care center": "Lejam",
            "mohammadia phcc": "Mohammadia",
            "sultana primaryhealth care center": "Sultana",
            "wadi wasat": "Wadi Wasat",
            "yadama primary health care center": "Yaddamah",
            "al fahad al janubi phcc": "Al Fahad Al Janubi",
            "Al Fahad Al Janubi PHCC": "Al Fahad Al Janubi",
            "Al Fahad Al Janubi phcc": "Al Fahad Al Janubi",
            "al fahad al janubi PHCC": "Al Fahad Al Janubi"
        };

        const SCREENING_ZONE_START_ROW = 10; // Will be found dynamically
        const SCREENING_ZONE_NAME_COL = 3; // column D
        const SCREENING_ZONE_OPP_COL = 4; // Opportunities By Zone
        const SCREENING_ZONE_VALUE_COL = 5; // Screened by Zone
        const SCREENING_ZONE_TARGET_COL = 6; // Target by Zone
        const SCREENING_ZONE_INDICATOR_COL = 7; // 7-Day Indicator by Zone
        const SCREENING_ZONE_LIMIT = 10;

        // PHC Rankings rows (after zone rankings)
        const SCREENING_PHC_NAME_COL = 9; // column J
        const SCREENING_PHC_OPP_COL = 10; // Opportunities By PHC
        const SCREENING_PHC_VALUE_COL = 11; // Screened by PHC
        const SCREENING_PHC_TARGET_COL = 12; // Target by PHC
        const SCREENING_PHC_INDICATOR_COL = 13; // 7-Day Indicator by PHC
        const DM_PHC_NAME_COL = 25; // DM PHC (column 25)
        const DM_PHC_TOTAL_COL = 26; // DM Patients (column 26)
        const DM_PHC_CONTROLLED_COL = 27; // Controlled DM (column 27)
        const DM_PHC_INDICATOR_COL = 29; // 7-Day Indicator DM (column 29)
        const DM_PHC_NO_APPT_30D_COL = 30; // UNCONTROLLED DM NO VISIT 30DAYS BY THE PHCS (column 30)
        const PREDM_PHC_NAME_COL = 42; // PRE-DM PHC (column 42)
        const PREDM_PHC_TOTAL_COL = 43; // Pre-DM Patients (column 43)
        const PREDM_PHC_NORMAL_COL = 44; // Pre-DM to Normal (column 44)
        const PREDM_PHC_FOLLOWUP_COL = 45; // Pre-DM No Follow-up (column 45)
        const PREDM_PHC_INDICATOR_COL = 46; // 7-Day Indicator PRE-DM (column 46)
        const PREDM_PHC_NO_APPT_90D_COL = 47; // PRE-DM Patients NO VISIT 90DAYS BY THE PHCS (column 47)

        // Future Appointments columns
        const FUTURE_APPT_STATUS_COL = 50; // Future_Appt_statue (column 50/AY)
        const FUTURE_APPT_APPOINTMENT_COL = 51; // Future_Appt_Appointment (column 51/AZ)
        const FUTURE_APPT_DATE_TIME_COL = 52; // Future_Appt_Date_and_time (column 52/BA)
        const FUTURE_APPT_MRN_COL = 53; // Future_Appt_mrn (column 53/BB)
        const FUTURE_APPT_PHC_COL = 54; // Future_Appt_phc (column 54/BC)
        const FUTURE_APPT_ZONE_COL = 55; // Future_Appt_zone (column 55/BD)
        const FUTURE_APPT_DEPARTMENT_COL = 56; // Future_Appt_department (column 56/BE)

        const DM_ZONE_START_ROW = 98; // Will be found dynamically
        const DM_ZONE_NAME_COL = 18; // DM Zone
        const DM_ZONE_TOTAL_COL = 19; // DM Patients
        const DM_ZONE_CONTROLLED_COL = 20; // Controlled DM
        const DM_ZONE_INDICATOR_COL = 22; // 7-Day Indicator DM
        const DM_ZONE_LIMIT = 10;

        // Explicit overview rows
        const SCREENING_TARGET_ROW = 4; // B5 -> zero-indexed 4
        const SCREENING_CURRENT_ROW = 5; // B6 -> zero-indexed 5

        // DM overview (fixed cells in column Q)
        const DM_OVERVIEW_COL = 16; // column Q (zero-indexed)
        const DM_OVERVIEW_PATIENTS_ROW = 1; // Q2
        const DM_OVERVIEW_CONTROLLED_ROW = 2; // Q3
        const DM_OVERVIEW_UNCONTROLLED_ROW = 3; // Q4

        // PRE-DM overview (fixed cells in column 33 - AH, PRE-DM Metrics)
        const PREDM_OVERVIEW_COL = 33; // column 33 (AH) - PRE-DM Metrics (zero-indexed)
        const PREDM_OVERVIEW_PATIENTS_ROW = 1; // Row 2, Column 33 (AH)
        const PREDM_OVERVIEW_NORMAL_ROW = 2; // Row 3, Column 33 (AH)
        const PREDM_OVERVIEW_NOFOLLOW_ROW = 3; // Row 4, Column 33 (AH)

        const PREDM_LABEL_COL = 28; // column AC (zero-indexed: 28)
        const PREDM_VALUE_COL = 29; // column AD (zero-indexed: 29)

        const PREDM_ZONE_START_ROW = 179; // Will be found dynamically
        const PREDM_ZONE_NAME_COL = 35; // PRE-DM Zone
        const PREDM_ZONE_TOTAL_COL = 36; // Pre-DM Patients
        const PREDM_ZONE_NORMAL_COL = 37; // Pre-DM to Normal
        const PREDM_ZONE_FOLLOWUP_COL = 38; // Pre-DM No Follow-up
        const PREDM_ZONE_INDICATOR_COL = 39; // 7-Day Indicator PRE-DM
        const PREDM_ZONE_NO_VISIT_90D_COL = 40; // PRE-DM Patients NO VISIT 90DAYS BY THE ZONE
        const PREDM_ZONE_LIMIT = 10;

        let screeningTargetTotal = null;
        let screeningCurrentTotal = null;
        let screeningOpportunitiesTotal = null;
        let dmPatientsTotal = null;
        let controlledDMTotal = null;
        let uncontrolledDMTotal = null;
        let predmPatientsTotal = null;
        let predmToNormalTotal = null;
        let predmNoFollowupTotal = null;
        let globalSheetData = null; // Store sheet data globally
        let currentZoneName = null; // Store current zone name for PHC navigation
        let lastUpdateDate = null; // Store last update date
        let lastClusterContext = null; // Store which card was active when navigating to zone view

        function updateScreeningPercentage() {
            const screenedPercentEl = document.getElementById('currentValuePercent');
            const screenedEl = document.getElementById('currentValue');
            const remainingPercentEl = document.getElementById('percentageValuePercent');
            const remainingEl = document.getElementById('percentageValue');
            const opportunitiesEl = document.getElementById('opportunitiesValue');
            if (!screenedEl || !remainingEl || !screenedPercentEl || !remainingPercentEl) return;

            const hasTarget = screeningTargetTotal !== null && screeningTargetTotal !== undefined;
            const hasCurrent = screeningCurrentTotal !== null && screeningCurrentTotal !== undefined;
            const target = hasTarget ? screeningTargetTotal : 0;
            const current = hasCurrent ? screeningCurrentTotal : 0;
            const opportunities = screeningOpportunitiesTotal ?? 0;

            const screenedPct = target > 0 ? (current / target) * 100 : 0;
            const remaining = Math.max(0, target - current);
            const remainingPct = target > 0 ? (remaining / target) * 100 : 0;

            screenedPercentEl.textContent = `${screenedPct.toFixed(1)}%`;
            screenedEl.textContent = current.toLocaleString();
            remainingPercentEl.textContent = `${remainingPct.toFixed(1)}%`;
            remainingEl.textContent = remaining.toLocaleString();
            if (opportunitiesEl) {
                opportunitiesEl.textContent = opportunities.toLocaleString();
            }
        }

        function updateZoneDetailScreeningPercentage() {
            const targetEl = document.getElementById('zoneDetailTargetValue');
            const screenedPercentEl = document.getElementById('zoneDetailScreenedValuePercent');
            const screenedEl = document.getElementById('zoneDetailScreenedValue');
            const remainingPercentEl = document.getElementById('zoneDetailRemainingValuePercent');
            const remainingEl = document.getElementById('zoneDetailRemainingValue');
            const opportunitiesEl = document.getElementById('zoneDetailOpportunitiesValue');
            if (!targetEl || !screenedEl || !remainingEl || !screenedPercentEl || !remainingPercentEl) return;

            // Get the values from the elements (they might have been set as textContent)
            const targetText = targetEl.textContent || targetEl.innerText || '0';
            const screenedText = screenedEl.textContent || screenedEl.innerText || '0';
            const target = parseFloat(targetText.replace(/,/g, '')) || 0;
            const current = parseFloat(screenedText.replace(/,/g, '')) || 0;
            const opportunitiesText = opportunitiesEl ? (opportunitiesEl.textContent || opportunitiesEl.innerText || '0') : '0';
            const opportunities = parseFloat(opportunitiesText.replace(/,/g, '')) || 0;

            const screenedPct = target > 0 ? (current / target) * 100 : 0;
            const remaining = Math.max(0, target - current);
            const remainingPct = target > 0 ? (remaining / target) * 100 : 0;

            targetEl.textContent = target.toLocaleString();
            screenedPercentEl.textContent = `${screenedPct.toFixed(1)}%`;
            screenedEl.textContent = current.toLocaleString();
            remainingPercentEl.textContent = `${remainingPct.toFixed(1)}%`;
            remainingEl.textContent = remaining.toLocaleString();
            if (opportunitiesEl) {
                opportunitiesEl.textContent = opportunities.toLocaleString();
            }
        }

        function updateDMPercentages() {
            const patients = dmPatientsTotal ?? 0;
            const controlled = controlledDMTotal ?? 0;
            const uncontrolled = uncontrolledDMTotal ?? 0;

            const controlledPct = patients > 0 ? (controlled / patients) * 100 : 0;
            const uncontrolledPct = patients > 0 ? (uncontrolled / patients) * 100 : 0;

            document.getElementById('controlledDMPercent').textContent = `${controlledPct.toFixed(1)}%`;
            document.getElementById('uncontrolledDMPercent').textContent = `${uncontrolledPct.toFixed(1)}%`;
        }

        function updatePreDMPercentages() {
            const patients = predmPatientsTotal ?? 0;
            const toNormal = predmToNormalTotal ?? 0;
            const noFollowup = predmNoFollowupTotal ?? 0;

            const toNormalPct = patients > 0 ? (toNormal / patients) * 100 : 0;
            const noFollowupPct = patients > 0 ? (noFollowup / patients) * 100 : 0;

            document.getElementById('preDMToNormalPercent').textContent = `${toNormalPct.toFixed(1)}%`;
            document.getElementById('preDMNoFollowupPercent').textContent = `${noFollowupPct.toFixed(1)}%`;
        }

        function populateScreeningZones(rows) {
            const container = document.getElementById('screeningZonesList');
            if (!container) return;

            let html = '<div class="zone-header"><div class="zone-header-item">Zone</div><div class="zone-header-item">Missed Pts</div><div class="zone-header-item">Screened</div></div>';
            let rank = 1;
            
            // Apply scope filtering
            const shouldShowZone = (zoneName) => {
                if (!userScopeData) return true; // If no scope data, show all
                if (userScopeData.scope === 'cluster') return true; // Cluster sees all
                if (userScopeData.scope === 'zone') return zoneName === userScopeData.zone_id; // Zone sees only their zone
                if (userScopeData.scope === 'phc') {
                    // PHC users see only their zone
                    return zoneName === userScopeData.zone_id;
                }
                return true;
            };

            // Find the "SCREENING Zone" header row
            let startRow = SCREENING_ZONE_START_ROW;
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i] || [];
                const firstCell = String(row[SCREENING_ZONE_NAME_COL] || '').trim().toUpperCase();
                if (firstCell.includes('SCREENING ZONE') || firstCell.includes('SCREENING ZONE')) {
                    startRow = i + 1; // Start from row after header
                    break;
                }
            }

            for (let i = startRow; i < rows.length; i++) {
                const row = rows[i] || [];
                const zoneName = (row[SCREENING_ZONE_NAME_COL] || '').trim();
                const oppRaw = (row[SCREENING_ZONE_OPP_COL] || '').trim();
                const achievedRaw = (row[SCREENING_ZONE_VALUE_COL] || '').trim();
                const targetRaw = (row[SCREENING_ZONE_TARGET_COL] || '').trim();
                const oppNum = parseFloat(oppRaw.replace(/,/g, ''));
                const achievedNum = parseFloat(achievedRaw.replace(/,/g, ''));
                const targetNum = parseFloat(targetRaw.replace(/,/g, ''));
                const oppText = oppRaw || (!isNaN(oppNum) ? oppNum.toLocaleString() : '0');
                let zoneValueText = achievedRaw || (isNaN(achievedNum) ? '0' : achievedNum.toLocaleString());

                if (!zoneName) break;
                
                // Apply scope filter for screening
                if (!shouldShowZone(zoneName)) continue;

                const escapedZoneName = zoneName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                html += `
                    <div class="zone-item zone-item--screening" onclick="navigateToZone('${escapedZoneName}', 'screening')">
                        <div class="zone-name">
                            <span class="zone-name-text">${zoneName}</span>
                        </div>
                        <span class="zone-value">${oppText}</span>
                        <span class="zone-value">${zoneValueText}</span>
                    </div>
                `;

                rank++;
                if (rank > SCREENING_ZONE_LIMIT) break;
            }

            if (rank === 1) {
                html += '<div class="zone-item"><span class="zone-name">No zone data</span></div>';
            }

            container.innerHTML = html;
        }

        function populateDMZones(rows) {
            const container = document.getElementById('dmZonesList');
            if (!container) return;

            let html = '<div class="zone-header zone-header--dm"><div class="zone-header-item">Zone</div><div class="zone-header-item">Controlled</div><div class="zone-header-item">Uncontrolled</div></div>';
            let rank = 1;
            
            // Apply scope filtering
            const shouldShowZone = (zoneName) => {
                if (!userScopeData) return true;
                if (userScopeData.scope === 'cluster') return true;
                if (userScopeData.scope === 'zone') return zoneName === userScopeData.zone_id;
                if (userScopeData.scope === 'phc') return zoneName === userScopeData.zone_id;
                return true;
            };

            // Find the "DM Zone" header row
            let startRow = DM_ZONE_START_ROW;
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i] || [];
                const colQCell = String(row[DM_ZONE_NAME_COL] || '').trim().toUpperCase();
                if (colQCell.includes('DM ZONE') || colQCell.includes('DM ZONE')) {
                    startRow = i + 1; // Start from row after header
                    break;
                }
            }

            for (let i = startRow; i < rows.length; i++) {
                const row = rows[i] || [];
                const zoneName = (row[DM_ZONE_NAME_COL] || '').trim();
                const totalRaw = (row[DM_ZONE_TOTAL_COL] || '').trim();
                const controlledRaw = (row[DM_ZONE_CONTROLLED_COL] || '').trim();
                const totalNum = parseFloat(totalRaw.replace(/,/g, ''));
                const controlledNum = parseFloat(controlledRaw.replace(/,/g, ''));
                const uncontrolledNum = !isNaN(totalNum) && !isNaN(controlledNum) ? Math.max(0, totalNum - controlledNum) : 0;
                
                const controlledText = !isNaN(controlledNum) ? controlledNum.toLocaleString() : '0';
                const uncontrolledText = uncontrolledNum.toLocaleString();

                if (!zoneName) break;
                
                // Apply scope filter for DM
                if (!shouldShowZone(zoneName)) continue;

                const escapedZoneName = zoneName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                html += `
                    <div class="zone-item zone-item--dm" onclick="navigateToZone('${escapedZoneName}', 'dm')">
                        <div class="zone-name">
                            <span class="zone-name-text">${zoneName}</span>
                        </div>
                        <span class="zone-value">${controlledText}</span>
                        <span class="zone-value">${uncontrolledText}</span>
                    </div>
                `;

                rank++;
                if (rank > DM_ZONE_LIMIT) break;
            }

            if (rank === 1) {
                html += '<div class="zone-item"><span class="zone-name">No zone data</span></div>';
            }

            container.innerHTML = html;
        }

        function populatePreDMZones(rows) {
            const container = document.getElementById('predmZonesList');
            if (!container) return;

            let html = '<div class="zone-header zone-header--predm"><div class="zone-header-item">Zone</div><div class="zone-header-item">Normal</div><div class="zone-header-item">Follow-up</div></div>';
            let rank = 1;
            
            // Apply scope filtering
            const shouldShowZone = (zoneName) => {
                if (!userScopeData) return true;
                if (userScopeData.scope === 'cluster') return true;
                if (userScopeData.scope === 'zone') return zoneName === userScopeData.zone_id;
                if (userScopeData.scope === 'phc') return zoneName === userScopeData.zone_id;
                return true;
            };

            // Find the "PRE-DM Zone" header row
            let startRow = PREDM_ZONE_START_ROW;
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i] || [];
                const colAFCell = String(row[PREDM_ZONE_NAME_COL] || '').trim().toUpperCase();
                if (colAFCell.includes('PRE-DM ZONE') || colAFCell.includes('PRE-DM ZONE')) {
                    startRow = i + 1; // Start from row after header
                    break;
                }
            }

            for (let i = startRow; i < rows.length; i++) {
                const row = rows[i] || [];
                const zoneName = (row[PREDM_ZONE_NAME_COL] || '').trim();
                const totalRaw = (row[PREDM_ZONE_TOTAL_COL] || '').trim();
                const normalRaw = (row[PREDM_ZONE_NORMAL_COL] || '').trim();
                const followupRaw = (row[PREDM_ZONE_FOLLOWUP_COL] || '').trim();
                const indicatorRaw = (row[PREDM_ZONE_INDICATOR_COL] || '').toString().trim();
                const indicatorNum = parseFloat(indicatorRaw);

                const totalNum = parseFloat(totalRaw.replace(/,/g, ''));
                const normalNum = parseFloat(normalRaw.replace(/,/g, ''));
                const followupNum = parseFloat(followupRaw.replace(/,/g, ''));
                
                const normalText = normalRaw || (!isNaN(normalNum) ? normalNum.toLocaleString() : '0');
                const followupText = followupRaw || (!isNaN(followupNum) ? followupNum.toLocaleString() : '0');

                if (!zoneName) break;
                
                // Apply scope filter for Pre-DM
                if (!shouldShowZone(zoneName)) continue;

                const escapedZoneName = zoneName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                html += `
                    <div class="zone-item zone-item--predm" onclick="navigateToZone('${escapedZoneName}', 'predm')">
                        <div class="zone-name">
                            <span class="zone-name-text">${zoneName}</span>
                        </div>
                        <span class="zone-value">${normalText}</span>
                        <span class="zone-value">${followupText}</span>
                    </div>
                `;

                rank++;
                if (rank > PREDM_ZONE_LIMIT) break;
            }

            if (rank === 1) {
                html += '<div class="zone-item"><span class="zone-name">No zone data</span></div>';
            }

            container.innerHTML = html;
        }

        // Load user scope from parent window or localStorage
        let userScopeData = null;
        let scopeReceivedFromParent = false;
        
        function loadUserScope() {
        try {
            const scopeJson = localStorage.getItem('userScope');
            if (scopeJson) {
                    const parsed = JSON.parse(scopeJson);
                    // Only update if scope data changed
                    if (JSON.stringify(parsed) !== JSON.stringify(userScopeData)) {
                        userScopeData = parsed;
                        console.log('User scope loaded from localStorage:', userScopeData);
                        return true; // Scope data changed
                    }
            }
        } catch (e) {
            console.error('Error loading user scope:', e);
        }
            return false; // No change
        }
        
        // Listen for user scope from parent
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'user-scope') {
                const newScope = event.data.scope;
                if (newScope && JSON.stringify(newScope) !== JSON.stringify(userScopeData)) {
                    userScopeData = newScope;
                    scopeReceivedFromParent = true;
                    console.log('User scope received from parent:', userScopeData);
                    
                    // If data is already loaded, re-populate zones with correct filtering
                    if (globalSheetData) {
                        populateScreeningZones(globalSheetData);
                        populateDMZones(globalSheetData);
                        populatePreDMZones(globalSheetData);
                        
                        // Auto-navigate zone/PHC users to their zone
                        if (userScopeData && (userScopeData.scope === 'zone' || userScopeData.scope === 'phc') && userScopeData.zone_id) {
                            setTimeout(() => {
                                navigateToZone(userScopeData.zone_id, 'screening');
                                const backButton = document.getElementById('zoneDetailBackButton');
                                if (backButton) {
                                    backButton.style.display = 'none';
                                }
                            }, 100);
                        }
                    }
                }
            }
        });
        
        // Initial load from localStorage
        loadUserScope();

        // Load data from Supabase (or fallback to Google Sheets)
        (function() {
            const SHEET_ID = '1v5hh2tu53eVMPRLE3tCk_Gf39Rb2Rt1sseZHCdyGzvE';
            const SHEET_NAME = 'Summary';
            
            // Supabase client (same config as main app)
            const SUPABASE_URL = 'https://zobmqwncusqkbmyzmvxi.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpvYm1xd25jdXNxa2JteXptdnhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NTA1MjcsImV4cCI6MjA4MTIyNjUyN30.dISVd9GJ6ITsfIt-41b4lRtO2oYs9XSS768bdATLoVk';
            const supabaseDashboard = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            function parseCSV(csvText) {
                const rows = [];
                let row = [];
                let field = '';
                let inQuotes = false;
            
                for (let i = 0; i < csvText.length; i++) {
                    const char = csvText[i];
                    const nextChar = csvText[i + 1];
            
                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            field += '"';
                            i++; // skip escaped quote
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        row.push(field.trim());
                        field = '';
                    } else if ((char === '\n' || char === '\r') && !inQuotes) {
                        // handle Windows newlines \r\n
                        if (char === '\r' && nextChar === '\n') {
                            i++;
                        }
                        row.push(field.trim());
                        rows.push(row);
                        row = [];
                        field = '';
                    } else {
                        field += char;
                    }
                }
            
                // Push any trailing field/row
                if (field.length > 0 || row.length > 0) {
                    row.push(field.trim());
                    rows.push(row);
                }
            
                return rows.filter(r => r.some(cell => (cell || '').trim() !== ''));
            }
            
            function showLoading() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) loadingOverlay.classList.add('active');
            }

            function hideLoading() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) loadingOverlay.classList.remove('active');
            }
            
            function showLoadError(message) {
                const errorEl = document.getElementById('loadError');
                if (!errorEl) return;
                if (message) {
                    errorEl.textContent = message;
                }
                errorEl.classList.add('active');
            }

            function hideLoadError() {
                const errorEl = document.getElementById('loadError');
                if (!errorEl) return;
                errorEl.classList.remove('active');
            }

            function loadDataFromGoogleSheets() {
                showLoading();
                hideLoadError();
                
                // Use CSV export which is more reliable for CORS
                const publishedUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;
                const gvizUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;
                
                // Try direct fetch first, then fall back to proxies
                const sources = [
                    publishedUrl,
                    gvizUrl,
                    `https://api.allorigins.win/raw?url=${encodeURIComponent(publishedUrl)}`,
                    `https://api.allorigins.win/raw?url=${encodeURIComponent(gvizUrl)}`,
                    `https://corsproxy.io/?${encodeURIComponent(publishedUrl)}`,
                    `https://corsproxy.io/?${encodeURIComponent(gvizUrl)}`
                ];
                
                function trySource(index) {
                    if (index >= sources.length) {
                        console.error('All fetch methods failed.');
                        showLoadError('Unable to load data. Please check your connection and try again.');
                        hideLoading();
                        return;
                    }
            
                    fetch(sources[index], { mode: 'cors' })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.text();
                        })
                        .then(text => {
                            if (!text || text.trim().length === 0) {
                                throw new Error('Empty response');
                            }
                            const sheetData = parseCSV(text);
                            if (sheetData.length > 0) {
                                hideLoadError();
                                updateMobileAppData(sheetData);
                                console.log('✓ Data loaded successfully from Google Sheets');
                                hideLoading();
                            } else {
                                throw new Error('No data parsed');
                            }
                        })
                        .catch(() => {
                            // Silently try next source
                            if (index + 1 >= sources.length) {
                                showLoadError('Unable to load data. Please check your connection and try again.');
                                hideLoading();
                            }
                            trySource(index + 1);
                        });
                }
                
                trySource(0);
            }
            
        function updateMobileAppData(data) {
        // Update last updated timestamp (now in B6 -> row index 5, col index 1). Fallback to old I1 if missing.
        const lastUpdatedCell =
            (data && data[5] && typeof data[5][1] !== 'undefined' ? data[5][1] : '') ||
            (data && data[0] && typeof data[0][8] !== 'undefined' ? data[0][8] : '');
        const lastUpdatedEl = document.getElementById('lastUpdated');
        const lastUpdatedValueEl = document.getElementById('lastUpdatedValue');
        if (lastUpdatedValueEl) {
            lastUpdatedValueEl.textContent = lastUpdatedCell || '--';
        } else if (lastUpdatedEl) {
            // Fallback if span not found
            lastUpdatedEl.textContent = lastUpdatedCell ? `Last update: ${lastUpdatedCell}` : 'Last update: --';
        }
        
        // Store last update date globally
        lastUpdateDate = lastUpdatedCell || null;

                // Store data globally for zone detail view
                globalSheetData = data;
                
                // Find sections in the data
                let currentSection = '';
                let rowIndex = 0;
                
                while (rowIndex < data.length) {
                    const row = data[rowIndex];
                    if (row.length === 0) {
                        rowIndex++;
                            continue;
                        }
                        
                    const firstCell = String(row[0] || '').trim();
                    
                    // Detect section headers (check column A, column N for DM, column AC for Pre-DM)
                    const colNCell = String(row[13] || '').trim(); // column N
                    const colACCell = String(row[PREDM_LABEL_COL] || '').trim(); // column AC
                    if (firstCell.includes('SCREENING OVERVIEW')) {
                        currentSection = 'screening';
                        rowIndex++;
                        continue;
                    } else if (firstCell.includes('DM PATIENTS OVERVIEW') || colNCell.includes('DM OVERVIEW') || colNCell.includes('DM PATIENTS OVERVIEW')) {
                        currentSection = 'dm';
                        rowIndex++;
                        continue;
                    } else if (firstCell.includes('PRE-DM PATIENTS OVERVIEW') || colACCell.includes('PRE-DM OVERVIEW') || colACCell.includes('PRE-DM PATIENTS OVERVIEW')) {
                        currentSection = 'predm';
                        rowIndex++;
                        continue;
                    }
                    
                        
                // Parse Screening Overview (new labels in column A/B)
                if (currentSection === 'screening') {
                    if (firstCell === 'SCREENING Target' && row[1]) {
                        const targetNum = parseInt((row[1] || '').replace(/,/g, ''), 10);
                        if (!isNaN(targetNum)) {
                            screeningTargetTotal = targetNum;
                            document.getElementById('targetValue').textContent = targetNum.toLocaleString();
                            updateScreeningPercentage();
                        }
                    } else if (firstCell.startsWith('SCREENING screened') && row[1]) {
                        const currentNum = parseInt((row[1] || '').replace(/,/g, ''), 10);
                        if (!isNaN(currentNum)) {
                            screeningCurrentTotal = currentNum;
                            updateScreeningPercentage();
                        }
                    } else if (firstCell.startsWith('SCREENING Remaining') && row[1]) {
                        const remainingNum = parseInt((row[1] || '').replace(/,/g, ''), 10);
                        if (!isNaN(remainingNum)) {
                            // current + remaining should equal target; we keep current/target for percentage
                        }
                    } else if (firstCell.toLowerCase().startsWith('screening opportunities') && row[1]) {
                        const oppNum = parseInt((row[1] || '').replace(/,/g, ''), 10);
                        if (!isNaN(oppNum)) {
                            screeningOpportunitiesTotal = oppNum;
                            const oppEl = document.getElementById('opportunitiesValue');
                            if (oppEl) oppEl.textContent = oppNum.toLocaleString();
                            updateScreeningPercentage();
                        }
                    }
                }
                    
                    // Parse DM Overview (columns N and O)
                    if (currentSection === 'dm') {
                        const dmLabelCol = 13; // column N
                        const dmValueCol = 14; // column O
                        const dmLabel = String(row[dmLabelCol] || '').trim();
                        const dmValue = row[dmValueCol];
                        
                        if (dmLabel === 'DM Patients' && dmValue) {
                            const num = parseInt(String(dmValue || '').replace(/,/g, ''), 10);
                            if (!isNaN(num)) {
                                dmPatientsTotal = num;
                                document.getElementById('dmPatientsValue').textContent = num.toLocaleString();
                                updateDMPercentages();
                            }
                        } else if (dmLabel === 'Controlled DM' && dmValue) {
                            const num = parseInt(String(dmValue || '').replace(/,/g, ''), 10);
                            if (!isNaN(num)) {
                                controlledDMTotal = num;
                                document.getElementById('controlledDMValue').textContent = num.toLocaleString();
                                updateDMPercentages();
                            }
                        } else if (dmLabel === 'Uncontrolled DM' && dmValue) {
                            const num = parseInt(String(dmValue || '').replace(/,/g, ''), 10);
                            if (!isNaN(num)) {
                                uncontrolledDMTotal = num;
                                document.getElementById('uncontrolledDMValue').textContent = num.toLocaleString();
                                updateDMPercentages();
                            }
                        }
                    }
                    
                    rowIndex++;
                }


                // Re-check user scope before populating zones (in case it wasn't available initially)
                const scopeChanged = loadUserScope();
                
                // Re-populate zones if scope data changed or wasn't available before
                if (scopeChanged || !userScopeData) {
                    // Scope data just became available, re-populate zones
                populateScreeningZones(data);
                populateDMZones(data);
                populatePreDMZones(data);
                } else {
                    // Normal population
                    populateScreeningZones(data);
                    populateDMZones(data);
                    populatePreDMZones(data);
                }
                
                // Setup sticky headers after cards are populated
                setTimeout(setupStickyHeaders, 100);

                // Auto-navigate zone-scoped users to their zone detail view
                if (userScopeData && (userScopeData.scope === 'zone' || userScopeData.scope === 'phc') && userScopeData.zone_id) {
                    // Wait a bit for DOM to be ready, then auto-navigate
                    setTimeout(() => {
                        const zoneId = userScopeData.zone_id;
                        // Navigate to zone detail view showing PHCs list
                        navigateToZone(zoneId, 'screening');
                        // Hide back button for zone/PHC users
                        const backButton = document.getElementById('zoneDetailBackButton');
                        if (backButton) {
                            backButton.style.display = 'none';
                        }
                    }, 500);
                }
                
                // Check for scope data after delays (in case parent page saves it later)
                // Check after 1 second
                setTimeout(() => {
                    if (loadUserScope() && globalSheetData) {
                        // Scope data just became available, re-populate zones
                        populateScreeningZones(globalSheetData);
                        populateDMZones(globalSheetData);
                        populatePreDMZones(globalSheetData);
                        
                        // Auto-navigate if zone/PHC user
                        if (userScopeData && (userScopeData.scope === 'zone' || userScopeData.scope === 'phc') && userScopeData.zone_id) {
                            const zoneId = userScopeData.zone_id;
                            navigateToZone(zoneId, 'screening');
                            // Hide back button
                            const backButton = document.getElementById('zoneDetailBackButton');
                            if (backButton) {
                                backButton.style.display = 'none';
                            }
                        }
                    }
                }, 1000);
                
                // Check again after 2 seconds (fallback)
                setTimeout(() => {
                    if (loadUserScope() && globalSheetData) {
                        // Scope data just became available, re-populate zones
                        populateScreeningZones(globalSheetData);
                        populateDMZones(globalSheetData);
                        populatePreDMZones(globalSheetData);
                        
                        // Auto-navigate if zone/PHC user
                        if (userScopeData && (userScopeData.scope === 'zone' || userScopeData.scope === 'phc') && userScopeData.zone_id) {
                            const zoneId = userScopeData.zone_id;
                            navigateToZone(zoneId, 'screening');
                            // Hide back button
                            const backButton = document.getElementById('zoneDetailBackButton');
                            if (backButton) {
                                backButton.style.display = 'none';
                    }
                }
                    }
                }, 2000);


                // Fallback: explicit rows if section headers are missing
                // Screening overview
                if (screeningTargetTotal === null && data[SCREENING_TARGET_ROW] && data[SCREENING_TARGET_ROW][1]) {
                    const val = parseInt((data[SCREENING_TARGET_ROW][1] || '').replace(/,/g, ''), 10);
                    if (!isNaN(val)) {
                        screeningTargetTotal = val;
                        document.getElementById('targetValue').textContent = val.toLocaleString();
                    }
                }
                if (screeningCurrentTotal === null && data[SCREENING_CURRENT_ROW] && data[SCREENING_CURRENT_ROW][1]) {
                    const val = parseInt((data[SCREENING_CURRENT_ROW][1] || '').replace(/,/g, ''), 10);
                    if (!isNaN(val)) {
                        screeningCurrentTotal = val;
                    }
                }
                updateScreeningPercentage();

                // DM overview from fixed cells Q2-Q4
                if (dmPatientsTotal === null || controlledDMTotal === null || uncontrolledDMTotal === null) {
                    const dmPatientsCell = data?.[DM_OVERVIEW_PATIENTS_ROW]?.[DM_OVERVIEW_COL];
                    const dmControlledCell = data?.[DM_OVERVIEW_CONTROLLED_ROW]?.[DM_OVERVIEW_COL];
                    const dmUncontrolledCell = data?.[DM_OVERVIEW_UNCONTROLLED_ROW]?.[DM_OVERVIEW_COL];

                    const dmPatientsVal = parseInt(String(dmPatientsCell ?? '').replace(/,/g, ''), 10);
                    const dmControlledVal = parseInt(String(dmControlledCell ?? '').replace(/,/g, ''), 10);
                    const dmUncontrolledVal = parseInt(String(dmUncontrolledCell ?? '').replace(/,/g, ''), 10);

                    if (!isNaN(dmPatientsVal)) {
                        dmPatientsTotal = dmPatientsVal;
                        const el = document.getElementById('dmPatientsValue');
                        if (el) el.textContent = dmPatientsVal.toLocaleString();
                    }
                    if (!isNaN(dmControlledVal)) {
                        controlledDMTotal = dmControlledVal;
                        const el = document.getElementById('controlledDMValue');
                        if (el) el.textContent = dmControlledVal.toLocaleString();
                    }
                    if (!isNaN(dmUncontrolledVal)) {
                        uncontrolledDMTotal = dmUncontrolledVal;
                        const el = document.getElementById('uncontrolledDMValue');
                        if (el) el.textContent = dmUncontrolledVal.toLocaleString();
                    }
                    updateDMPercentages();
                }

                // PRE-DM overview from fixed cells AF2-AF4
                if (predmPatientsTotal === null || predmToNormalTotal === null || predmNoFollowupTotal === null) {
                    const prePatientsCell = data?.[PREDM_OVERVIEW_PATIENTS_ROW]?.[PREDM_OVERVIEW_COL];
                    const preNormalCell = data?.[PREDM_OVERVIEW_NORMAL_ROW]?.[PREDM_OVERVIEW_COL];
                    const preNoFollowCell = data?.[PREDM_OVERVIEW_NOFOLLOW_ROW]?.[PREDM_OVERVIEW_COL];

                    const prePatientsVal = parseInt(String(prePatientsCell ?? '').replace(/,/g, ''), 10);
                    const preNormalVal = parseInt(String(preNormalCell ?? '').replace(/,/g, ''), 10);
                    const preNoFollowVal = parseInt(String(preNoFollowCell ?? '').replace(/,/g, ''), 10);

                    if (!isNaN(prePatientsVal)) {
                        predmPatientsTotal = prePatientsVal;
                        const el = document.getElementById('preDMPatientsValue');
                        if (el) el.textContent = prePatientsVal.toLocaleString();
                    }
                    if (!isNaN(preNormalVal)) {
                        predmToNormalTotal = preNormalVal;
                        const el = document.getElementById('preDMToNormalValue');
                        if (el) el.textContent = preNormalVal.toLocaleString();
                    }
                    if (!isNaN(preNoFollowVal)) {
                        predmNoFollowupTotal = preNoFollowVal;
                        const el = document.getElementById('preDMNoFollowupValue');
                        if (el) el.textContent = preNoFollowVal.toLocaleString();
                    }
                    updatePreDMPercentages();
                }

                // DM overview fallback (check columns N and O)
                if (dmPatientsTotal === null) {
                    for (let i = 0; i < data.length; i++) {
                        const row = data[i] || [];
                        const label = String(row[13] || '').trim(); // column N
                        if (label === 'DM Patients' && row[14]) {
                            const val = parseInt(String(row[14] || '').replace(/,/g, ''), 10);
                            if (!isNaN(val)) {
                                dmPatientsTotal = val;
                                document.getElementById('dmPatientsValue').textContent = val.toLocaleString();
                                break;
                            }
                        }
                    }
                }
                if (controlledDMTotal === null) {
                    for (let i = 0; i < data.length; i++) {
                        const row = data[i] || [];
                        const label = String(row[13] || '').trim(); // column N
                        if (label === 'Controlled DM' && row[14]) {
                            const val = parseInt(String(row[14] || '').replace(/,/g, ''), 10);
                            if (!isNaN(val)) {
                                controlledDMTotal = val;
                                document.getElementById('controlledDMValue').textContent = val.toLocaleString();
                                break;
                            }
                        }
                    }
                }
                if (uncontrolledDMTotal === null) {
                    for (let i = 0; i < data.length; i++) {
                        const row = data[i] || [];
                        const label = String(row[13] || '').trim(); // column N
                        if (label === 'Uncontrolled DM' && row[14]) {
                            const val = parseInt(String(row[14] || '').replace(/,/g, ''), 10);
                            if (!isNaN(val)) {
                                uncontrolledDMTotal = val;
                                document.getElementById('uncontrolledDMValue').textContent = val.toLocaleString();
                                break;
                            }
                        }
                    }
                }
                updateDMPercentages();
            }
            
            // Load data when page loads
            loadDataFromGoogleSheets();
        })();

        // Helper function to normalize PHC names for matching
        function normalizePHC(phc) {
            if (!phc) return '';
            return phc.trim().toLowerCase().replace(/\s+/g, ' ');
        }

        // Find PHC rankings section in data
        function findPHCRankingsSection(data, sectionName) {
            let found = false;
            let startRow = -1;
            
            // Determine which columns to check based on section name
            let nameCol, headerCol;
            if (sectionName.includes('Screening')) {
                nameCol = SCREENING_PHC_NAME_COL; // column J (index 9)
                headerCol = 9; // Check column J for "SCREENING PHC"
            } else if (sectionName.includes('DM PHC') || sectionName.includes('DM')) {
                nameCol = DM_PHC_NAME_COL; // column 25
                headerCol = 25; // Check column 25 for "DM PHC"
            } else if (sectionName.includes('PRE-DM PHC') || sectionName.includes('Pre-DM') || sectionName.includes('PRE-DM')) {
                nameCol = PREDM_PHC_NAME_COL; // column 42
                headerCol = 42; // Check column 42 for "PRE-DM PHC"
            } else {
                return { found: false, startRow: -1 };
            }
            
            // First, check the first row (row 0) for the header
            if (data.length > 0) {
                const firstRow = data[0] || [];
                const headerCell = String(firstRow[headerCol] || '').trim().toUpperCase();
                
                // Check if header matches
                if (headerCell.includes('DM PHC') || headerCell.includes('PRE-DM PHC') || headerCell.includes('SCREENING PHC')) {
                    // Header found in first row, now find where data starts
                    // Look for the first row that has a PHC name in the nameCol
                    for (let i = 1; i < data.length; i++) {
                        const row = data[i] || [];
                        const phcNameCell = String(row[nameCol] || '').trim();
                        
                        // Skip empty cells and header-like text
                        if (phcNameCell && phcNameCell.length > 2 && 
                            !phcNameCell.toUpperCase().includes('PHC') && 
                            !phcNameCell.toUpperCase().includes('RANKING') &&
                            !phcNameCell.toUpperCase().includes('ZONE') &&
                            !phcNameCell.toUpperCase().includes('NAME') &&
                            !phcNameCell.toUpperCase().includes('SCREENING') &&
                            !phcNameCell.toUpperCase().includes('DM') &&
                            !phcNameCell.toUpperCase().includes('PRE-DM') &&
                            !phcNameCell.toUpperCase().includes('PATIENTS') &&
                            !phcNameCell.toUpperCase().includes('CONTROLLED') &&
                            !phcNameCell.toUpperCase().includes('UNCONTROLLED')) {
                            // Check if this looks like actual data (has values in adjacent columns)
                            const hasData = row[nameCol + 1] || row[nameCol + 2];
                            if (hasData) {
                                found = true;
                                startRow = i;
                                break;
                            }
                        }
                    }
                }
            }
            
            // Fallback: If header not found in first row, search all rows
            if (!found) {
            for (let i = 0; i < data.length; i++) {
                const row = data[i] || [];
                    const headerCell = String(row[headerCol] || '').trim().toUpperCase();
                    
                    if (headerCell.includes('DM PHC') || headerCell.includes('PRE-DM PHC') || headerCell.includes('SCREENING PHC')) {
                        // Found header, look for data start
                        for (let j = i + 1; j < Math.min(i + 10, data.length); j++) {
                        const nextRow = data[j] || [];
                            const phcNameCell = String(nextRow[nameCol] || '').trim();
                            
                            if (phcNameCell && phcNameCell.length > 2 && 
                                !phcNameCell.toUpperCase().includes('PHC') && 
                                !phcNameCell.toUpperCase().includes('RANKING') &&
                                !phcNameCell.toUpperCase().includes('ZONE') &&
                                !phcNameCell.toUpperCase().includes('NAME') &&
                                !phcNameCell.toUpperCase().includes('SCREENING') &&
                                !phcNameCell.toUpperCase().includes('DM') &&
                                !phcNameCell.toUpperCase().includes('PRE-DM') &&
                                !phcNameCell.toUpperCase().includes('PATIENTS') &&
                                !phcNameCell.toUpperCase().includes('CONTROLLED') &&
                                !phcNameCell.toUpperCase().includes('UNCONTROLLED')) {
                                const hasData = nextRow[nameCol + 1] || nextRow[nameCol + 2];
                                if (hasData) {
                            found = true;
                                startRow = j;
                            break;
                                }
                        }
                    }
                    if (found) break;
                    }
                }
            }
            
            // Final fallback: Direct search for PHC names in expected column
            if (!found && nameCol !== undefined) {
                for (let i = 1; i < data.length; i++) {
                    const row = data[i] || [];
                    const phcNameCell = String(row[nameCol] || '').trim();
                    
                    if (phcNameCell && phcNameCell.length > 2 && 
                        !phcNameCell.toUpperCase().includes('PHC') && 
                        !phcNameCell.toUpperCase().includes('RANKING') &&
                        !phcNameCell.toUpperCase().includes('ZONE') &&
                        !phcNameCell.toUpperCase().includes('NAME') &&
                        !phcNameCell.toUpperCase().includes('SCREENING') &&
                        !phcNameCell.toUpperCase().includes('DM') &&
                        !phcNameCell.toUpperCase().includes('PRE-DM') &&
                        !phcNameCell.toUpperCase().includes('PATIENTS') &&
                        !phcNameCell.toUpperCase().includes('CONTROLLED') &&
                        !phcNameCell.toUpperCase().includes('UNCONTROLLED')) {
                        const hasData = row[nameCol + 1] || row[nameCol + 2];
                        if (hasData) {
                            found = true;
                            startRow = i;
                            break;
                        }
                    }
                }
            }
            
            return { found, startRow };
        }

        // Populate PHCs for a specific zone
        function populateZonePHCs(data, zoneName, context) {
            let sectionName = '';
            let nameCol, valueCol, targetCol, indicatorCol, controlledCol, normalCol, followupCol, oppCol, noAppt30DCol, noAppt90DCol;
            
            if (context === 'screening') {
                sectionName = 'PHC Rankings - Screening';
                nameCol = SCREENING_PHC_NAME_COL;
                valueCol = SCREENING_PHC_VALUE_COL;
                oppCol = SCREENING_PHC_OPP_COL;
                targetCol = SCREENING_PHC_TARGET_COL;
                indicatorCol = SCREENING_PHC_INDICATOR_COL;
            } else if (context === 'dm') {
                sectionName = 'DM PHC'; // Look for "DM PHC" header in column 24
                nameCol = DM_PHC_NAME_COL;
                valueCol = DM_PHC_TOTAL_COL;
                controlledCol = DM_PHC_CONTROLLED_COL;
                noAppt30DCol = DM_PHC_NO_APPT_30D_COL;
                indicatorCol = DM_PHC_INDICATOR_COL;
            } else if (context === 'predm') {
                sectionName = 'PRE-DM PHC'; // Look for "PRE-DM PHC" header in column 39
                nameCol = PREDM_PHC_NAME_COL;
                valueCol = PREDM_PHC_TOTAL_COL;
                normalCol = PREDM_PHC_NORMAL_COL;
                followupCol = PREDM_PHC_FOLLOWUP_COL;
                noAppt90DCol = PREDM_PHC_NO_APPT_90D_COL;
                indicatorCol = PREDM_PHC_INDICATOR_COL;
            }
            
            const { found, startRow } = findPHCRankingsSection(data, sectionName);
            if (!found || startRow < 0) {
                // Print first row to help understand structure
                if (data.length > 0) {
                    console.log('First row of Google Sheet:', data[0]);
                }
                return [];
            }
            
            const phcs = [];
            for (let i = startRow; i < data.length; i++) {
                const row = data[i] || [];
                const phcName = (row[nameCol] || '').trim();
                
                // Skip empty rows but continue looking (don't break immediately)
                if (!phcName || phcName === '') {
                    // If we've found some PHCs and hit an empty row, we might be at the end
                    // But continue for a few more rows in case there are gaps
                    if (phcs.length > 0 && i > startRow + 5) {
                        // After finding PHCs and hitting multiple empty rows, likely done
                        let emptyCount = 0;
                        for (let j = i; j < Math.min(i + 3, data.length); j++) {
                            const nextRow = data[j] || [];
                            const nextPhcName = (nextRow[nameCol] || '').trim();
                            if (!nextPhcName || nextPhcName === '') emptyCount++;
                        }
                        if (emptyCount >= 3) break; // 3 consecutive empty rows, likely end of section
                    }
                    continue;
                }
                
                // Debug: log PHC names that might match "al fahad al janubi"
                if (normalizePHC(phcName).includes('fahad') && normalizePHC(phcName).includes('janubi')) {
                    console.log('Found potential match for al fahad al janubi:', phcName, 'Normalized:', normalizePHC(phcName));
                }
                
                // Check if this PHC belongs to the selected zone
                let phcZone = PHC_ZONE_MAP[phcName];
                
                // If not found, try case-insensitive matching
                if (!phcZone) {
                    const normalizedPhcName = normalizePHC(phcName);
                    const matchingKey = Object.keys(PHC_ZONE_MAP).find(key => 
                        normalizePHC(key) === normalizedPhcName
                    );
                    if (matchingKey) {
                        phcZone = PHC_ZONE_MAP[matchingKey];
                    } else {
                        // Try more flexible matching - remove all spaces and compare
                        const phcNameNoSpaces = normalizedPhcName.replace(/\s+/g, '');
                        const matchingKeyNoSpaces = Object.keys(PHC_ZONE_MAP).find(key => {
                            const keyNoSpaces = normalizePHC(key).replace(/\s+/g, '');
                            return keyNoSpaces === phcNameNoSpaces;
                        });
                        if (matchingKeyNoSpaces) {
                            phcZone = PHC_ZONE_MAP[matchingKeyNoSpaces];
                        }
                    }
                }
                
                // Normalize zone names for comparison
                const normalizedPhcZone = phcZone ? normalizePHC(phcZone) : '';
                const normalizedZoneName = zoneName ? normalizePHC(zoneName) : '';
                
                if (normalizedPhcZone === normalizedZoneName || phcZone === zoneName) {
                    if (context === 'screening') {
                        const achievedRaw = (row[valueCol] || '').trim();
                        const oppRaw = oppCol !== undefined ? (row[oppCol] || '').trim() : '';
                        const targetRaw = (row[targetCol] || '').trim();
                        const indicatorRaw = (row[indicatorCol] || '').toString().trim();
                        
                        const oppNum = parseFloat(oppRaw.replace(/,/g, ''));
                        const achievedNum = parseFloat(achievedRaw.replace(/,/g, ''));
                        const targetNum = parseFloat(targetRaw.replace(/,/g, ''));
                        const indicatorNum = parseFloat(indicatorRaw);
                        
                        // Show count instead of percentage
                        let valueText = achievedRaw || (achievedNum ? achievedNum.toLocaleString() : '0');
                        const oppText = oppRaw || (!isNaN(oppNum) ? oppNum.toLocaleString() : '0');
                        
                        phcs.push({
                            name: phcName,
                            opportunities: oppText,
                            value: valueText,
                            achieved: achievedNum,
                            target: targetNum,
                            indicator: indicatorNum
                        });
                    } else if (context === 'dm') {
                        const totalRaw = (row[valueCol] || '').trim();
                        const controlledRaw = (row[controlledCol] || '').trim();
                        const noAppt30DRaw = noAppt30DCol !== undefined ? (row[noAppt30DCol] || '').trim() : '';
                        const indicatorRaw = (row[indicatorCol] || '').toString().trim();
                        
                        const totalNum = isNaN(parseFloat(totalRaw.replace(/,/g, ''))) ? 0 : parseFloat(totalRaw.replace(/,/g, ''));
                        const controlledNum = isNaN(parseFloat(controlledRaw.replace(/,/g, ''))) ? 0 : parseFloat(controlledRaw.replace(/,/g, ''));
                        const noAppt30DNum = isNaN(parseFloat(noAppt30DRaw.replace(/,/g, ''))) ? 0 : parseFloat(noAppt30DRaw.replace(/,/g, ''));
                        const indicatorNum = isNaN(parseFloat(indicatorRaw)) ? 0 : parseFloat(indicatorRaw);
                        
                        let valueText = '0%';
                        if (!isNaN(totalNum) && !isNaN(controlledNum) && totalNum !== 0) {
                            const percent = ((controlledNum / totalNum) * 100).toFixed(1);
                            valueText = `${percent}%`;
                        }
                        
                        phcs.push({
                            name: phcName,
                            value: valueText,
                            total: totalNum,
                            controlled: controlledNum,
                            noAppt30D: noAppt30DNum,
                            indicator: indicatorNum
                        });
                    } else if (context === 'predm') {
                        const totalRaw = (row[valueCol] || '').trim();
                        const normalRaw = (row[normalCol] || '').trim();
                        const followupRaw = (row[followupCol] || '').trim();
                        const noAppt90DRaw = noAppt90DCol !== undefined ? (row[noAppt90DCol] || '').trim() : '';
                        const indicatorRaw = (row[indicatorCol] || '').toString().trim();
                        
                        const totalNum = isNaN(parseFloat(totalRaw.replace(/,/g, ''))) ? 0 : parseFloat(totalRaw.replace(/,/g, ''));
                        const normalNum = isNaN(parseFloat(normalRaw.replace(/,/g, ''))) ? 0 : parseFloat(normalRaw.replace(/,/g, ''));
                        const followupNum = isNaN(parseFloat(followupRaw.replace(/,/g, ''))) ? 0 : parseFloat(followupRaw.replace(/,/g, ''));
                        const noAppt90DNum = isNaN(parseFloat(noAppt90DRaw.replace(/,/g, ''))) ? 0 : parseFloat(noAppt90DRaw.replace(/,/g, ''));
                        const indicatorNum = isNaN(parseFloat(indicatorRaw)) ? 0 : parseFloat(indicatorRaw);
                        
                        let normalPercentText = '0%';
                        if (!isNaN(totalNum) && !isNaN(normalNum) && totalNum !== 0) {
                            const percent = ((normalNum / totalNum) * 100).toFixed(1);
                            normalPercentText = `${percent}%`;
                        }
                        
                        let followupPercentText = '0%';
                        if (!isNaN(totalNum) && !isNaN(followupNum) && totalNum !== 0) {
                            const percent = ((followupNum / totalNum) * 100).toFixed(1);
                            followupPercentText = `${percent}%`;
                        }
                        
                        phcs.push({
                            name: phcName,
                            normalPercent: normalPercentText,
                            followupPercent: followupPercentText,
                            total: totalNum,
                            normal: normalNum,
                            followup: followupNum,
                            noAppt90D: noAppt90DNum,
                            indicator: indicatorNum
                        });
                    }
                }
            }
            
            return phcs;
        }

        // Render PHC list for zone detail view
        function renderZonePHCList(containerId, phcs, context) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Filter PHCs based on user scope
            if (userScopeData && userScopeData.scope === 'phc') {
                // PHC users should only see their own PHC
                phcs = phcs.filter(phc => phc.name === userScopeData.phc_id);
            }
            
            let html = '';
            
            if (context === 'screening') {
                html = '<div class="zone-header"><div class="zone-header-item">PHC</div><div class="zone-header-item">Missed Pts</div><div class="zone-header-item">Screened</div></div>';
                phcs.forEach(phc => {
                    const displayName = PHC_DISPLAY_NAMES[phc.name] || PHC_DISPLAY_NAMES[phc.name?.toLowerCase()] || phc.name;
                    
                    // Get appointment count for this PHC (filtered by status and current week)
                    let appointmentCount = 0;
                    if (globalSheetData) {
                        const allAppointments = getFutureAppointmentsForPHC(phc.name, globalSheetData);
                        const statusFiltered = filterAppointmentsByStatus(allAppointments, 'screening');
                        const weekAppointments = filterAppointmentsByCurrentWeek(statusFiltered);
                        appointmentCount = weekAppointments.length;
                    }
                    const badgeHtml = appointmentCount > 0 ? `<span class="phc-appointment-badge">${appointmentCount}</span>` : '';
                    
                    const escapedPhcName = phc.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    html += `
                        <div class="zone-item zone-item--screening" onclick="navigateToPHC('${escapedPhcName}')">
                            <div class="zone-name">
                                <span class="zone-name-text">${displayName}</span>${badgeHtml}
                            </div>
                            <span class="zone-value">${phc.opportunities || '0'}</span>
                            <span class="zone-value">${phc.value}</span>
                        </div>
                    `;
                });
            } else if (context === 'dm') {
                html = '<div class="zone-header zone-header--dm"><div class="zone-header-item">PHC</div><div class="zone-header-item">Controlled</div><div class="zone-header-item">Uncontrolled</div></div>';
                phcs.forEach(phc => {
                    const controlledText = !isNaN(phc.controlled) ? phc.controlled.toLocaleString() : '0';
                    const uncontrolledText = !isNaN(phc.total) && !isNaN(phc.controlled) ? Math.max(0, phc.total - phc.controlled).toLocaleString() : '0';

                    const displayName = PHC_DISPLAY_NAMES[phc.name] || PHC_DISPLAY_NAMES[phc.name?.toLowerCase()] || phc.name;

                    // Get appointment count for this PHC (filtered by status and current week)
                    let appointmentCount = 0;
                    if (globalSheetData) {
                        const allAppointments = getFutureAppointmentsForPHC(phc.name, globalSheetData);
                        const statusFiltered = filterAppointmentsByStatus(allAppointments, 'dm');
                        const weekAppointments = filterAppointmentsByCurrentWeek(statusFiltered);
                        appointmentCount = weekAppointments.length;
                    }
                    const badgeHtml = appointmentCount > 0 ? `<span class="phc-appointment-badge">${appointmentCount}</span>` : '';

                    const escapedPhcName = phc.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    html += `
                        <div class="zone-item zone-item--dm" onclick="navigateToPHC('${escapedPhcName}')">
                            <div class="zone-name">
                                <span class="zone-name-text">${displayName}</span>${badgeHtml}
                            </div>
                            <span class="zone-value">${controlledText}</span>
                            <span class="zone-value">${uncontrolledText}</span>
                        </div>
                    `;
                });
            } else if (context === 'predm') {
                html = '<div class="zone-header zone-header--predm"><div class="zone-header-item">PHC</div><div class="zone-header-item">Normal</div><div class="zone-header-item">Follow-up</div></div>';
                phcs.forEach(phc => {
                    const normalText = !isNaN(phc.normal) ? phc.normal.toLocaleString() : '0';
                    const followupText = !isNaN(phc.followup) ? phc.followup.toLocaleString() : '0';

                    const displayName = PHC_DISPLAY_NAMES[phc.name] || PHC_DISPLAY_NAMES[phc.name?.toLowerCase()] || phc.name;

                    // Get appointment count for this PHC (filtered by status and current week)
                    let appointmentCount = 0;
                    if (globalSheetData) {
                        const allAppointments = getFutureAppointmentsForPHC(phc.name, globalSheetData);
                        const statusFiltered = filterAppointmentsByStatus(allAppointments, 'predm');
                        const weekAppointments = filterAppointmentsByCurrentWeek(statusFiltered);
                        appointmentCount = weekAppointments.length;
                    }
                    const badgeHtml = appointmentCount > 0 ? `<span class="phc-appointment-badge">${appointmentCount}</span>` : '';

                    const escapedPhcName = phc.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    html += `
                        <div class="zone-item zone-item--predm" onclick="navigateToPHC('${escapedPhcName}')">
                            <div class="zone-name">
                                <span class="zone-name-text">${displayName}</span>${badgeHtml}
                            </div>
                            <span class="zone-value">${normalText}</span>
                            <span class="zone-value">${followupText}</span>
                        </div>
                    `;
                });
            }
            
            if (phcs.length === 0) {
                html += '<div class="zone-item"><span class="zone-name">No PHC data available</span></div>';
            }
            
            container.innerHTML = html;
        }

        // Zone navigation functions
        function navigateToZone(zoneName, context) {
            // Store current zone name
            currentZoneName = zoneName;
            
            // Store the context for back button navigation
            lastClusterContext = context;
            
            // Hide main view
            const mainView = document.getElementById('mainView');
            const zoneDetailView = document.getElementById('zoneDetailView');
            
            if (mainView) mainView.classList.add('hidden');
            if (zoneDetailView) zoneDetailView.style.display = 'flex';
            
            // Set scroll position using requestAnimationFrame to ensure it happens before paint
            const zoneCarousel = document.getElementById('zoneDetailCarousel');
            if (zoneCarousel && context) {
                let cardIndex = 0; // Default to first card (Screening)
                
                if (context === 'screening') {
                    cardIndex = 0; // Screening card
                } else if (context === 'dm') {
                    cardIndex = 1; // DM card
                } else if (context === 'predm') {
                    cardIndex = 2; // Pre-DM card
                }
                
                // Use requestAnimationFrame to set scroll before browser paints
                requestAnimationFrame(() => {
                    // Temporarily disable smooth scrolling
                    zoneCarousel.style.scrollBehavior = 'auto';
                    
                    // Set scroll position immediately
                    zoneCarousel.scrollLeft = cardIndex * zoneCarousel.clientWidth;
                    
                    // Force synchronous layout recalculation
                    void zoneCarousel.offsetHeight;
                    
                    // Restore smooth scrolling in next frame
                    requestAnimationFrame(() => {
                        zoneCarousel.style.scrollBehavior = '';
                    });
                });
            }

            // Update zone detail page title (use full name if available)
            const fullZoneName = ZONE_FULL_NAMES[zoneName] || ZONE_FULL_NAMES[zoneName?.toUpperCase?.()] || zoneName;

            const titleEl = document.getElementById('zoneDetailTitle');
            if (titleEl) titleEl.textContent = fullZoneName;

            // Restore smooth scrolling after view is shown
            if (zoneCarousel) {
                setTimeout(() => {
                    zoneCarousel.style.scrollBehavior = '';
                }, 0);
            }
            
            // Create dots for zone detail carousel if swipeable
            const zoneDotsContainer = document.getElementById('zoneDetailCarouselDots');
            if (zoneCarousel && zoneDotsContainer) {
                const zoneCards = Array.from(zoneCarousel.querySelectorAll('.card'));
                
                // Only show dots if there are multiple cards (swipeable)
                if (zoneCards.length > 1) {
                    zoneDotsContainer.innerHTML = '';
                    const dots = [];
                    zoneCards.forEach((_, i) => {
                        const dot = document.createElement('button');
                        dot.type = 'button';
                        dot.className = 'carousel-dot';
                        dot.setAttribute('aria-label', `Go to slide ${i + 1}`);
                        dot.addEventListener('click', () => {
                            zoneCarousel.scrollTo({
                                left: i * zoneCarousel.clientWidth,
                                behavior: 'smooth'
                            });
                        });
                        zoneDotsContainer.appendChild(dot);
                        dots.push(dot);
                    });
                    
                    // Update dots immediately based on context (if available)
                    if (context !== undefined) {
                        let cardIndex = 0;
                        if (context === 'screening') cardIndex = 0;
                        else if (context === 'dm') cardIndex = 1;
                        else if (context === 'predm') cardIndex = 2;
                        
                        dots.forEach((dot, idx) => dot.classList.toggle('active', idx === cardIndex));
                    }
                    
                    // Update dots on scroll
                    const updateZoneDots = () => {
                        const index = Math.round(zoneCarousel.scrollLeft / zoneCarousel.clientWidth);
                        dots.forEach((dot, idx) => dot.classList.toggle('active', idx === index));
                    };
                    
                    let zoneScrollTimeout;
                    zoneCarousel.addEventListener('scroll', () => {
                        clearTimeout(zoneScrollTimeout);
                        zoneScrollTimeout = setTimeout(updateZoneDots, 50);
                    }, { passive: true });
                    
                    // Only call updateZoneDots if context wasn't set (to avoid double update)
                    if (context === undefined) {
                        updateZoneDots();
                    }
                } else {
                    // Hide dots if only one card (not swipeable)
                    zoneDotsContainer.style.display = 'none';
                }
            }

            // Populate PHCs for the selected zone
            if (globalSheetData) {
                const screeningPHCs = populateZonePHCs(globalSheetData, zoneName, 'screening');
                const dmPHCs = populateZonePHCs(globalSheetData, zoneName, 'dm');
                const predmPHCs = populateZonePHCs(globalSheetData, zoneName, 'predm');
                
                // Calculate and display zone overview metrics for Screening
                let zoneTargetTotal = 0;
                let zoneScreenedTotal = 0;
                let zoneOpportunitiesTotal = 0;
                screeningPHCs.forEach(phc => {
                    if (!isNaN(phc.target)) zoneTargetTotal += phc.target;
                    if (!isNaN(phc.achieved)) zoneScreenedTotal += phc.achieved;
                    // Sum opportunities (parse from text if needed)
                    const oppNum = parseFloat(String(phc.opportunities || '0').replace(/,/g, ''));
                    if (!isNaN(oppNum)) zoneOpportunitiesTotal += oppNum;
                });
                const zoneRemainingTotal = Math.max(0, zoneTargetTotal - zoneScreenedTotal);
                
                document.getElementById('zoneDetailTargetValue').textContent = zoneTargetTotal.toLocaleString();
                // Set values temporarily, then format with percentages
                document.getElementById('zoneDetailScreenedValue').textContent = zoneScreenedTotal.toLocaleString();
                document.getElementById('zoneDetailRemainingValue').textContent = zoneRemainingTotal.toLocaleString();
                document.getElementById('zoneDetailOpportunitiesValue').textContent = zoneOpportunitiesTotal.toLocaleString();
                
                // Update with percentages (this will update the percent elements)
                updateZoneDetailScreeningPercentage();
                
                // Hide back button for zone/PHC scoped users
                const backButton = document.getElementById('zoneDetailBackButton');
                if (backButton && userScopeData && (userScopeData.scope === 'zone' || userScopeData.scope === 'phc')) {
                    backButton.style.display = 'none';
                } else if (backButton) {
                    backButton.style.display = 'block';
                }
                
                // Calculate and display zone overview metrics for DM
                let zoneDMTotal = 0;
                let zoneControlledTotal = 0;
                dmPHCs.forEach(phc => {
                    const total = phc.total || 0;
                    const controlled = phc.controlled || 0;
                    if (!isNaN(total) && total >= 0) zoneDMTotal += total;
                    if (!isNaN(controlled) && controlled >= 0) zoneControlledTotal += controlled;
                });
                // Ensure values are non-negative
                zoneDMTotal = Math.max(0, zoneDMTotal);
                zoneControlledTotal = Math.max(0, zoneControlledTotal);
                const zoneUncontrolledTotal = Math.max(0, zoneDMTotal - zoneControlledTotal);
                const zoneControlledPercent = zoneDMTotal > 0 ? ((zoneControlledTotal / zoneDMTotal) * 100).toFixed(1) : 0;
                const zoneUncontrolledPercent = zoneDMTotal > 0 ? ((zoneUncontrolledTotal / zoneDMTotal) * 100).toFixed(1) : 0;
                
                document.getElementById('zoneDetailDMPatientsValue').textContent = zoneDMTotal.toLocaleString();
                document.getElementById('zoneDetailControlledDMValue').textContent = zoneControlledTotal.toLocaleString();
                document.getElementById('zoneDetailControlledDMPercent').textContent = `${zoneControlledPercent}%`;
                document.getElementById('zoneDetailUncontrolledDMValue').textContent = zoneUncontrolledTotal.toLocaleString();
                document.getElementById('zoneDetailUncontrolledDMPercent').textContent = `${zoneUncontrolledPercent}%`;
                
                // Calculate and display zone overview metrics for Pre-DM
                let zonePreDMTotal = 0;
                let zoneNormalTotal = 0;
                let zoneFollowupTotal = 0;
                predmPHCs.forEach(phc => {
                    const total = phc.total || 0;
                    const normal = phc.normal || 0;
                    const followup = phc.followup || 0;
                    if (!isNaN(total) && total >= 0) zonePreDMTotal += total;
                    if (!isNaN(normal) && normal >= 0) zoneNormalTotal += normal;
                    if (!isNaN(followup) && followup >= 0) zoneFollowupTotal += followup;
                });
                // Ensure values are non-negative
                zonePreDMTotal = Math.max(0, zonePreDMTotal);
                zoneNormalTotal = Math.max(0, zoneNormalTotal);
                zoneFollowupTotal = Math.max(0, zoneFollowupTotal);
                
                const zoneNormalPercent = zonePreDMTotal > 0 ? ((zoneNormalTotal / zonePreDMTotal) * 100).toFixed(1) : 0;
                const zoneFollowupPercent = zonePreDMTotal > 0 ? ((zoneFollowupTotal / zonePreDMTotal) * 100).toFixed(1) : 0;
                
                document.getElementById('zoneDetailPreDMPatientsValue').textContent = zonePreDMTotal.toLocaleString();
                document.getElementById('zoneDetailPreDMToNormalValue').textContent = zoneNormalTotal.toLocaleString();
                document.getElementById('zoneDetailPreDMToNormalPercent').textContent = `${zoneNormalPercent}%`;
                document.getElementById('zoneDetailPreDMNoFollowupValue').textContent = zoneFollowupTotal.toLocaleString();
                document.getElementById('zoneDetailPreDMNoFollowupPercent').textContent = `${zoneFollowupPercent}%`;
                
                renderZonePHCList('zoneDetailScreeningPHCs', screeningPHCs, 'screening');
                renderZonePHCList('zoneDetailDMPHCs', dmPHCs, 'dm');
                renderZonePHCList('zoneDetailPreDMPHCs', predmPHCs, 'predm');
            }
        }

        function goBackToMain() {
            const mainView = document.getElementById('mainView');
            const zoneDetailView = document.getElementById('zoneDetailView');
            
            if (mainView) mainView.classList.remove('hidden');
            if (zoneDetailView) zoneDetailView.style.display = 'none';
            
            // Scroll to the card that matches the context we came from
            if (lastClusterContext) {
                const carousel = document.getElementById('carousel');
                if (carousel) {
                    let cardIndex = 0; // Default to first card (Screening)
                    
                    if (lastClusterContext === 'screening') {
                        cardIndex = 0; // Screening card
                    } else if (lastClusterContext === 'dm') {
                        cardIndex = 1; // DM card
                    } else if (lastClusterContext === 'predm') {
                        cardIndex = 2; // Pre-DM card
                    }
                    
                    // Use double requestAnimationFrame to ensure view is fully rendered
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            // Check if carousel has valid width
                            if (carousel.clientWidth > 0) {
                                // Temporarily disable smooth scrolling
                                carousel.style.scrollBehavior = 'auto';
                                
                                // Set scroll position immediately
                                carousel.scrollLeft = cardIndex * carousel.clientWidth;
                                
                                // Force synchronous layout recalculation
                                void carousel.offsetHeight;
                                
                                
                                // Restore smooth scrolling
                                requestAnimationFrame(() => {
                                    carousel.style.scrollBehavior = '';
                                });
                            }
                        });
                    });
                }
            }
        }
        
        function goBackToZone() {
            const zoneDetailView = document.getElementById('zoneDetailView');
            const phcDetailView = document.getElementById('phcDetailView');
            
            if (zoneDetailView) zoneDetailView.style.display = 'flex';
            if (phcDetailView) phcDetailView.style.display = 'none';
        }
        
        // Navigate to PHC detail view
        function navigateToPHC(phcName) {
            // Hide zone detail view and show PHC detail view
            const zoneDetailView = document.getElementById('zoneDetailView');
            const phcDetailView = document.getElementById('phcDetailView');
            
            if (zoneDetailView) zoneDetailView.style.display = 'none';
            if (phcDetailView) phcDetailView.style.display = 'flex';
            
            // Update PHC detail title
            const displayName = PHC_DISPLAY_NAMES[phcName] || PHC_DISPLAY_NAMES[phcName?.toLowerCase()] || phcName;
            const titleEl = document.getElementById('phcDetailTitle');
            if (titleEl) titleEl.textContent = displayName;
            
            // Populate PHC dashboard data
            populatePHCDashboard(phcName);
        }
        
        // Parse and filter future appointments for a specific PHC
        function getFutureAppointmentsForPHC(phcName, sheetData) {
            if (!sheetData || !phcName) return [];
            
            const appointments = [];
            const normalizedSearchName = normalizePHC(phcName);
            
            // Find the header row for future appointments
            let startRow = -1;
            for (let i = 0; i < sheetData.length; i++) {
                const row = sheetData[i] || [];
                const statusCell = String(row[FUTURE_APPT_STATUS_COL] || '').trim();
                if (statusCell && (statusCell.includes('Future_Appt') || statusCell.includes('STATUE') || statusCell.includes('Status'))) {
                    startRow = i + 1; // Start from row after header
                    break;
                }
            }
            
            // If no header found, try to find data rows (rows with status values)
            if (startRow === -1) {
                for (let i = 0; i < sheetData.length; i++) {
                    const row = sheetData[i] || [];
                    const statusCell = String(row[FUTURE_APPT_STATUS_COL] || '').trim();
                    const phcCell = String(row[FUTURE_APPT_PHC_COL] || '').trim();
                    if (statusCell && phcCell && 
                        (statusCell.includes('Not Screened') || 
                         statusCell.includes('Pre-DM') || 
                         statusCell.includes('Uncontrolled DM'))) {
                        startRow = i;
                        break;
                    }
                }
            }
            
            if (startRow === -1) return [];
            
            // Parse appointments
            for (let i = startRow; i < sheetData.length; i++) {
                const row = sheetData[i] || [];
                const status = String(row[FUTURE_APPT_STATUS_COL] || '').trim();
                const appointment = String(row[FUTURE_APPT_APPOINTMENT_COL] || '').trim();
                const dateTime = String(row[FUTURE_APPT_DATE_TIME_COL] || '').trim();
                const mrn = String(row[FUTURE_APPT_MRN_COL] || '').trim();
                const phc = String(row[FUTURE_APPT_PHC_COL] || '').trim();
                const zone = String(row[FUTURE_APPT_ZONE_COL] || '').trim();
                const department = String(row[FUTURE_APPT_DEPARTMENT_COL] || '').trim();
                
                // Skip empty rows
                if (!status && !phc && !mrn) continue;
                
                // Match PHC name (normalized)
                const normalizedPHCName = normalizePHC(phc);
                if (normalizedPHCName === normalizedSearchName) {
                    appointments.push({
                        status: status,
                        appointment: appointment || dateTime,
                        dateTime: dateTime || appointment,
                        mrn: mrn,
                        phc: phc,
                        zone: zone,
                        department: department
                    });
                }
            }
            
            // Sort by date/time (most recent first, or upcoming first)
            appointments.sort((a, b) => {
                const dateA = new Date(a.dateTime);
                const dateB = new Date(b.dateTime);
                if (isNaN(dateA.getTime()) && isNaN(dateB.getTime())) return 0;
                if (isNaN(dateA.getTime())) return 1;
                if (isNaN(dateB.getTime())) return -1;
                return dateA - dateB; // Ascending order (earliest first)
            });
            
            return appointments;
        }
        
        // Get current week dates (Sunday to Saturday)
        function getCurrentWeekDates() {
            const today = new Date();
            const day = today.getDay(); // 0 = Sunday, 6 = Saturday
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - day); // Go to Sunday
            
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                weekDates.push(date);
            }
            return weekDates;
        }

        // Format date as YYYY-MM-DD for comparison
        function formatDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Format date for display
        function formatDateDisplay(date) {
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${month}/${day}`;
        }

        // Get day name abbreviation
        function getDayName(date) {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            return days[date.getDay()];
        }

        // Check if a date is within the current week (Sunday to Saturday)
        function isDateInCurrentWeek(date) {
            const today = new Date();
            const day = today.getDay(); // 0 = Sunday, 6 = Saturday
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - day); // Go to Sunday
            startOfWeek.setHours(0, 0, 0, 0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6); // Go to Saturday
            endOfWeek.setHours(23, 59, 59, 999);
            
            return date >= startOfWeek && date <= endOfWeek;
        }

        // Filter appointments by status type based on card context
        function filterAppointmentsByStatus(appointments, context) {
            if (!appointments || appointments.length === 0) return [];
            
            return appointments.filter(appt => {
                const status = String(appt.status || '').trim();
                
                if (context === 'screening') {
                    // Show badges for "Not Screened" appointments
                    return status.includes('Not Screened');
                } else if (context === 'dm') {
                    // Show badges for "Uncontrolled DM - Needs Follow-up (30+ days)" appointments
                    return status.includes('Uncontrolled DM') && status.includes('30+');
                } else if (context === 'predm') {
                    // Show badges for "Pre-DM - Needs Follow-up (90+ days)" appointments
                    return status.includes('Pre-DM') && status.includes('90+');
                }
                
                return false;
            });
        }

        // Filter appointments to only include those in the current week
        function filterAppointmentsByCurrentWeek(appointments) {
            return appointments.filter(appt => {
                try {
                    const dateStr = appt.dateTime || appt.appointment || '';
                    if (!dateStr) return false;
                    
                    // Parse date (handle formats like "01/05/2026, 14:19" or "01/05/2026")
                    const dateMatch = dateStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                    if (dateMatch) {
                        const month = parseInt(dateMatch[1], 10) - 1;
                        const day = parseInt(dateMatch[2], 10);
                        const year = parseInt(dateMatch[3], 10);
                        const date = new Date(year, month, day);
                        
                        if (!isNaN(date.getTime())) {
                            return isDateInCurrentWeek(date);
                        }
                    }
                } catch (e) {
                    // Skip if date parsing fails
                }
                return false;
            });
        }

        // Count appointments by date
        function countAppointmentsByDate(appointments) {
            const counts = {};
            appointments.forEach(appt => {
                try {
                    // Try to parse the date from dateTime or appointment field
                    const dateStr = appt.dateTime || appt.appointment || '';
                    if (!dateStr) return;
                    
                    // Parse date (handle formats like "01/05/2026, 14:19" or "01/05/2026")
                    const dateMatch = dateStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                    if (dateMatch) {
                        const month = parseInt(dateMatch[1], 10) - 1;
                        const day = parseInt(dateMatch[2], 10);
                        const year = parseInt(dateMatch[3], 10);
                        const date = new Date(year, month, day);
                        
                        if (!isNaN(date.getTime())) {
                            const dateKey = formatDateKey(date);
                            counts[dateKey] = (counts[dateKey] || 0) + 1;
                        }
                    }
                } catch (e) {
                    // Skip if date parsing fails
                }
            });
            return counts;
        }

        // Show calendar view
        function showCalendarView() {
            const calendarWeek = document.getElementById('phcCalendarWeek');
            const appointmentsList = document.getElementById('phcAppointmentsList');
            const appointmentsCard = document.querySelector('.phc-card-appointments');
            
            // Collapse the card
            if (appointmentsCard) {
                appointmentsCard.classList.remove('expanded');
            }
            
            // Hide list
            if (appointmentsList) {
                appointmentsList.classList.remove('expanded');
            }
        }

        // Show appointments for selected date
        function showAppointmentsForDate(date, appointments) {
            const calendarWeek = document.getElementById('phcCalendarWeek');
            const appointmentsList = document.getElementById('phcAppointmentsList');
            const selectedDateEl = document.getElementById('phcSelectedDate');
            const appointmentsSlots = document.getElementById('phcAppointmentsSlots');
            const appointmentsCard = document.querySelector('.phc-card-appointments');
            
            if (!appointmentsList || !appointmentsSlots) return;
            
            // Expand the card
            if (appointmentsCard) {
                appointmentsCard.classList.add('expanded');
            }
            
            // Show list (keep calendar visible)
            appointmentsList.classList.add('expanded');
            
            // Set selected date
            if (selectedDateEl) {
                selectedDateEl.textContent = formatDateDisplay(date) + ' - ' + getDayName(date);
            }
            
            // Filter appointments for this date
            const dateKey = formatDateKey(date);
            const dateAppointments = appointments.filter(appt => {
                try {
                    const dateStr = appt.dateTime || appt.appointment || '';
                    const dateMatch = dateStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                    if (dateMatch) {
                        const month = parseInt(dateMatch[1], 10) - 1;
                        const day = parseInt(dateMatch[2], 10);
                        const year = parseInt(dateMatch[3], 10);
                        const apptDate = new Date(year, month, day);
                        return formatDateKey(apptDate) === dateKey;
                    }
                } catch (e) {
                    return false;
                }
                return false;
            });
            
            // Display appointments
            if (dateAppointments.length === 0) {
                appointmentsSlots.innerHTML = '<div class="phc-appointment-empty">No appointments for this date</div>';
            } else {
                let html = '';
                dateAppointments.forEach(appt => {
                    // Determine status class
                    let statusClass = '';
                    if (appt.status && appt.status.includes('Not Screened')) {
                        statusClass = 'not-screened';
                    } else if (appt.status && appt.status.includes('Uncontrolled DM')) {
                        statusClass = 'dm-followup';
                    } else if (appt.status && appt.status.includes('Pre-DM')) {
                        statusClass = 'predm-followup';
                    }
                    
                    // Format time
                    let displayTime = '';
                    try {
                        const dateStr = appt.dateTime || appt.appointment || '';
                        const timeMatch = dateStr.match(/(\d{1,2}):(\d{2})/);
                        if (timeMatch) {
                            displayTime = `${timeMatch[1]}:${timeMatch[2]}`;
                        }
                    } catch (e) {
                        // Keep empty if parsing fails
                    }
                    
                    html += `
                        <div class="phc-appointment-item">
                            <div class="phc-appointment-status ${statusClass}">${appt.status || '--'}</div>
                            <div class="phc-appointment-date">${displayTime || '--'}</div>
                            <div class="phc-appointment-mrn">MRN: ${appt.mrn || '--'}</div>
                            ${appt.department ? `<div class="phc-appointment-department">Department: ${appt.department}</div>` : ''}
                        </div>
                    `;
                });
                appointmentsSlots.innerHTML = html;
            }
        }

        // Populate PHC dashboard with data
        function populatePHCDashboard(phcName) {
            if (!globalSheetData) return;
            
            // Create dots for PHC carousel if swipeable (though it's vertical, so dots won't be very useful)
            const phcCarousel = document.getElementById('phcDetailCarousel');
            const phcDotsContainer = document.getElementById('phcDetailCarouselDots');
            if (phcCarousel && phcDotsContainer) {
                const phcCards = Array.from(phcCarousel.querySelectorAll('.card'));
                // PHC carousel is vertical, so hide dots (dots are for horizontal carousels)
                phcDotsContainer.style.display = 'none';
            }
            
            // Get the zone for this PHC (use current zone if available, otherwise look it up)
            let phcZone = currentZoneName;
            if (!phcZone) {
                phcZone = PHC_ZONE_MAP[phcName];
                if (!phcZone) {
                    const normalizedPhcName = normalizePHC(phcName);
                    const matchingKey = Object.keys(PHC_ZONE_MAP).find(key => 
                        normalizePHC(key) === normalizedPhcName
                    );
                    if (matchingKey) {
                        phcZone = PHC_ZONE_MAP[matchingKey];
                    }
                }
            }
            
            // Find PHC data from the zone
            const dmPHCs = phcZone ? populateZonePHCs(globalSheetData, phcZone, 'dm') : [];
            const predmPHCs = phcZone ? populateZonePHCs(globalSheetData, phcZone, 'predm') : [];
            const screeningPHCs = phcZone ? populateZonePHCs(globalSheetData, phcZone, 'screening') : [];
            
            console.log(`PHC Dashboard - Looking for: "${phcName}", Zone: "${phcZone}"`);
            console.log(`Found DM PHCs: ${dmPHCs.length}`, dmPHCs.map(p => p.name));
            console.log(`Found Screening PHCs: ${screeningPHCs.length}`, screeningPHCs.map(p => p.name));
            console.log(`Found Pre-DM PHCs: ${predmPHCs.length}`, predmPHCs.map(p => p.name));
            
            // Find the specific PHC
            const normalizedSearchName = normalizePHC(phcName);
            const dmPHC = dmPHCs.find(p => {
                const normalizedPHCName = normalizePHC(p.name);
                const match = normalizedPHCName === normalizedSearchName;
                if (match) console.log(`✓ Matched DM PHC: "${p.name}" (normalized: "${normalizedPHCName}")`);
                return match;
            });
            const predmPHC = predmPHCs.find(p => {
                const normalizedPHCName = normalizePHC(p.name);
                return normalizedPHCName === normalizedSearchName;
            });
            const screeningPHC = screeningPHCs.find(p => {
                const normalizedPHCName = normalizePHC(p.name);
                return normalizedPHCName === normalizedSearchName;
            });
            
            if (dmPHC) {
                console.log(`DM PHC data:`, dmPHC);
            } else {
                console.warn(`DM PHC not found for: "${phcName}"`);
            }
            
            // SCREENING CARD: Screened and Remaining (with count and %)
            if (screeningPHC) {
                const target = screeningPHC.target || 0;
                const achieved = screeningPHC.achieved || 0;
                const remaining = Math.max(0, target - achieved);
                const screenedPercent = target > 0 ? ((achieved / target) * 100).toFixed(1) : 0;
                const remainingPercent = target > 0 ? ((remaining / target) * 100).toFixed(1) : 0;
                
                // Format as "XX.X% count" like cluster and zone views
                document.getElementById('phcScreenedCount').innerHTML = `<span class="metric-percent">${screenedPercent}%</span><span class="metric-count">${achieved.toLocaleString()}</span>`;
                document.getElementById('phcScreenedPercent').textContent = ''; // Clear separate percent display
                document.getElementById('phcScreeningRemaining').innerHTML = `<span class="metric-percent">${remainingPercent}%</span><span class="metric-count">${remaining.toLocaleString()}</span>`;
                document.getElementById('phcRemainingPercent').textContent = ''; // Clear separate percent display
                
                // Missed Screening Opportunities
                const opportunities = parseFloat(String(screeningPHC.opportunities || '0').replace(/,/g, '')) || 0;
                document.getElementById('phcMissedScreeningCount').textContent = opportunities.toLocaleString();
                
                // Calculate date one day before last update
                let missedDateLabel = '--';
                if (lastUpdateDate) {
                    try {
                        // Parse the last update date (assuming format like "MM/DD/YYYY" or "DD/MM/YYYY")
                        const dateParts = lastUpdateDate.split(/[\/\-]/);
                        let updateDate;
                        if (dateParts.length === 3) {
                            // Try to parse as MM/DD/YYYY or DD/MM/YYYY
                            const month = parseInt(dateParts[0], 10) - 1;
                            const day = parseInt(dateParts[1], 10);
                            const year = parseInt(dateParts[2], 10);
                            if (month >= 0 && month <= 11 && day > 0 && day <= 31) {
                                updateDate = new Date(year, month, day);
                            }
                        }
                        if (!updateDate || isNaN(updateDate.getTime())) {
                            // Fallback: try parsing as ISO date
                            updateDate = new Date(lastUpdateDate);
                        }
                        if (updateDate && !isNaN(updateDate.getTime())) {
                            // Subtract one day
                            updateDate.setDate(updateDate.getDate() - 1);
                            // Format as MM/DD/YYYY
                            const month = (updateDate.getMonth() + 1).toString().padStart(2, '0');
                            const day = updateDate.getDate().toString().padStart(2, '0');
                            const year = updateDate.getFullYear();
                            missedDateLabel = `${month}/${day}/${year}`;
                        }
                    } catch (e) {
                        console.warn('Error parsing last update date:', e);
                    }
                }
                document.getElementById('phcMissedScreeningLabel').textContent = `Missed Screening Opportunities on ${missedDateLabel}`;
            } else {
                document.getElementById('phcScreenedCount').innerHTML = '<span class="metric-percent">0%</span><span class="metric-count">0</span>';
                document.getElementById('phcScreenedPercent').textContent = '';
                document.getElementById('phcScreeningRemaining').innerHTML = '<span class="metric-percent">0%</span><span class="metric-count">0</span>';
                document.getElementById('phcRemainingPercent').textContent = '';
                document.getElementById('phcMissedScreeningCount').textContent = '0';
                document.getElementById('phcMissedScreeningLabel').textContent = 'Missed Screening Opportunities on --';
            }
            
            // DM CARD: Uncontrolled DM, Controlled DM, and No Appt 30D+
            if (dmPHC) {
                const totalDM = dmPHC.total || 0;
                const controlled = dmPHC.controlled || 0;
                const uncontrolledDM = Math.max(0, totalDM - controlled);
                const uncontrolledPercent = totalDM > 0 ? ((uncontrolledDM / totalDM) * 100).toFixed(0) : 0;
                const controlledPercent = totalDM > 0 ? ((controlled / totalDM) * 100).toFixed(0) : 0;
                const noAppt30D = dmPHC.noAppt30D || 0;
                
                document.getElementById('phcUncontrolledDMCount').textContent = uncontrolledDM.toLocaleString();
                document.getElementById('phcUncontrolledDMPercent').textContent = `${uncontrolledPercent}%`;
                document.getElementById('phcControlledDMCount').textContent = controlled.toLocaleString();
                document.getElementById('phcControlledDMPercent').textContent = `${controlledPercent}%`;
                document.getElementById('phcFollowupDM30').textContent = noAppt30D.toLocaleString();
            } else {
                document.getElementById('phcUncontrolledDMCount').textContent = '0';
                document.getElementById('phcUncontrolledDMPercent').textContent = '0%';
                document.getElementById('phcControlledDMCount').textContent = '0';
                document.getElementById('phcControlledDMPercent').textContent = '0%';
                document.getElementById('phcFollowupDM30').textContent = '0';
            }
            
            // PRE-DM CARD: Pre-DM Patients count and No Appt 90D+
            if (predmPHC) {
                const preDMTotal = predmPHC.total || 0;
                const noAppt90D = predmPHC.noAppt90D || 0;
                document.getElementById('phcPreDMTotal').textContent = preDMTotal.toLocaleString();
                document.getElementById('phcFollowupPreDM90').textContent = noAppt90D.toLocaleString();
            } else {
                document.getElementById('phcPreDMTotal').textContent = '0';
                document.getElementById('phcFollowupPreDM90').textContent = '0';
            }
            
            // UPCOMING APPOINTMENTS CARD: Display calendar week view with appointment counts
            const calendarWeek = document.getElementById('phcCalendarWeek');
            if (calendarWeek) {
                const appointments = getFutureAppointmentsForPHC(phcName, globalSheetData);
                const weekDates = getCurrentWeekDates();
                const appointmentCounts = countAppointmentsByDate(appointments);
                
                // Store appointments globally for date click handler
                window.currentPHCAppointments = appointments;
                
                // Generate three rows: day labels, dates, badges
                let dayLabelsHtml = '';
                let datesHtml = '';
                let badgesHtml = '';
                
                weekDates.forEach((date, index) => {
                    const dateKey = formatDateKey(date);
                    const count = appointmentCounts[dateKey] || 0;
                    const isToday = formatDateKey(new Date()) === dateKey;
                    const dayName = getDayName(date);
                    const dayNumber = date.getDate();
                    
                    // Day labels row - add today indicator dot next to day name if today
                    const todayIndicator = isToday ? '<span class="phc-calendar-today-indicator"></span>' : '';
                    dayLabelsHtml += `<div class="phc-calendar-day-label ${isToday ? 'today' : ''}">${dayName}${todayIndicator}</div>`;
                    
                    // Dates row (clickable only if has appointments)
                    // Add classes: 'today' for today, 'has-appointments' for dates with appointments, 'clickable' if has appointments
                    const dateClasses = [];
                    if (isToday) dateClasses.push('today');
                    if (count > 0 && !isToday) dateClasses.push('has-appointments');
                    if (count > 0) dateClasses.push('clickable');
                    
                    // Only add onclick if there are appointments
                    const onClickHandler = count > 0 
                        ? `onclick="showAppointmentsForDate(new Date(${date.getTime()}), window.currentPHCAppointments || [])"`
                        : '';
                    
                    datesHtml += `
                        <div class="phc-calendar-day ${dateClasses.join(' ')}" ${onClickHandler}>
                            <div class="phc-calendar-day-number">${dayNumber}</div>
                        </div>
                    `;
                    
                    // Badges row - add class if date has appointments
                    // 'today' for today with appointments, 'has-appointments' for non-today with appointments
                    let badgeClass = '';
                    if (count > 0) {
                        badgeClass = isToday ? 'today' : 'has-appointments';
                    }
                    badgesHtml += `
                        <div class="phc-calendar-day-badge-container ${badgeClass}">
                            ${count > 0 ? `<span class="phc-calendar-day-badge">${count}</span>` : '<span class="phc-calendar-day-badge zero">0</span>'}
                        </div>
                    `;
                });
                
                calendarWeek.innerHTML = `
                    <div class="phc-calendar-row">${dayLabelsHtml}</div>
                    <div class="phc-calendar-row">${datesHtml}</div>
                    <div class="phc-calendar-row">${badgesHtml}</div>
                `;
                
                // Ensure calendar is visible and list is hidden
                calendarWeek.style.display = 'flex';
                const appointmentsList = document.getElementById('phcAppointmentsList');
                const appointmentsCard = document.querySelector('.phc-card-appointments');
                if (appointmentsList) {
                    appointmentsList.classList.remove('expanded');
                }
                if (appointmentsCard) {
                    appointmentsCard.classList.remove('expanded');
                }
            }
        }

    // Theme toggle (light / dark)
    (function() {
        const body = document.body;
        const themeToggle = document.getElementById('themeToggle');
        const THEME_KEY = 'phm-theme';

        function applyTheme(mode) {
            if (mode === 'dark') {
                body.classList.add('dark-mode');
                if (themeToggle) {
                    themeToggle.setAttribute('aria-label', 'Switch to light mode');
                }
            } else {
                body.classList.remove('dark-mode');
                if (themeToggle) {
                    themeToggle.setAttribute('aria-label', 'Switch to dark mode');
                }
            }
            localStorage.setItem(THEME_KEY, mode);
            
            // Notify parent page (index.html) about theme change
            try {
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'theme-changed',
                        theme: mode
                    }, '*');
                }
            } catch (e) {
                // Cross-origin or other error, ignore
            }
        }

        const savedTheme = localStorage.getItem(THEME_KEY);
        // Default to light if nothing saved or value is invalid
        const initialTheme = savedTheme === 'dark' ? 'dark' : 'light';
        applyTheme(initialTheme);

        if (themeToggle) {
            themeToggle.addEventListener('click', () => {
                const nextMode = body.classList.contains('dark-mode') ? 'light' : 'dark';
                applyTheme(nextMode);
            });
        }
        
        // Listen for theme changes from parent
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'theme-changed') {
                const mode = event.data.theme;
                if (mode === 'dark') {
                    body.classList.add('dark-mode');
                } else {
                    body.classList.remove('dark-mode');
                }
                localStorage.setItem(THEME_KEY, mode);
            }
        });
    })();
    </script>
    
    <script>
        // Reset zoom to default (100%) on page load
        window.addEventListener('load', function() {
            document.body.style.zoom = '1';
            if (document.documentElement) {
                document.documentElement.style.zoom = '1';
            }
            
            // Setup scroll handlers for sticky headers
            setupStickyHeaders();
        });
        
        // Setup sticky headers that shrink on scroll
        function setupStickyHeaders() {
            const SHRINK_THRESHOLD = 40; // Pixels to scroll before header is fully shrunk
            
            // Handle cluster view cards
            const clusterCards = document.querySelectorAll('#carousel .card');
            clusterCards.forEach(card => {
                const header = card.querySelector('.template-header');
                const h2 = header?.querySelector('h2');
                const subtitle = header?.querySelector('.subtitle');
                
                if (header && h2) {
                    // Initialize on load
                    function updateHeader() {
                        const scrollTop = card.scrollTop;
                        const progress = Math.min(scrollTop / SHRINK_THRESHOLD, 1); // 0 to 1
                        
                        // Interpolate between normal and small sizes
                        const h2Size = 13.6 - (13.6 - 11) * progress;
                        const h2Margin = 3.2 - (3.2 - 2) * progress;
                        const subtitleSize = 8.8 - (8.8 - 7) * progress;
                        const paddingBottom = 6.4 - (6.4 - 4) * progress;
                        const borderWidth = 2 - (2 - 1) * progress;
                        
                        h2.style.fontSize = h2Size + 'px';
                        h2.style.marginBottom = h2Margin + 'px';
                        if (subtitle) {
                            subtitle.style.fontSize = subtitleSize + 'px';
                        }
                        header.style.paddingBottom = paddingBottom + 'px';
                        header.style.borderBottomWidth = borderWidth + 'px';
                    }
                    
                    // Update on scroll
                    card.addEventListener('scroll', updateHeader, { passive: true });
                    
                    // Initial update
                    updateHeader();
                }
            });
            
            // Handle zone view cards
            const zoneCards = document.querySelectorAll('#zoneDetailCarousel .card');
            zoneCards.forEach(card => {
                const header = card.querySelector('.template-header');
                const h2 = header?.querySelector('h2');
                const subtitle = header?.querySelector('.subtitle');
                
                if (header && h2) {
                    // Initialize on load
                    function updateHeader() {
                        const scrollTop = card.scrollTop;
                        const progress = Math.min(scrollTop / SHRINK_THRESHOLD, 1);
                        
                        // Interpolate between normal and small sizes
                        const h2Size = 13.6 - (13.6 - 11) * progress;
                        const h2Margin = 3.2 - (3.2 - 2) * progress;
                        const subtitleSize = 8.8 - (8.8 - 7) * progress;
                        const paddingBottom = 6.4 - (6.4 - 4) * progress;
                        const borderWidth = 2 - (2 - 1) * progress;
                        
                        h2.style.fontSize = h2Size + 'px';
                        h2.style.marginBottom = h2Margin + 'px';
                        if (subtitle) {
                            subtitle.style.fontSize = subtitleSize + 'px';
                        }
                        header.style.paddingBottom = paddingBottom + 'px';
                        header.style.borderBottomWidth = borderWidth + 'px';
                    }
                    
                    // Update on scroll
                    card.addEventListener('scroll', updateHeader, { passive: true });
                    
                    // Initial update
                    updateHeader();
                }
            });
        }
        
        // Also reset on DOMContentLoaded for faster reset
        document.addEventListener('DOMContentLoaded', function() {
            if (document.body) {
                document.body.style.zoom = '1';
            }
            if (document.documentElement) {
                document.documentElement.style.zoom = '1';
            }
            
            // Setup sticky headers
            setupStickyHeaders();
        });
    </script>
</body>
</html>
