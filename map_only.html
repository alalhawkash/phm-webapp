<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Najran Health Cluster - Map Only</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            direction: rtl;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden;
            background: #fff;
        }
        .layout {
            display: grid;
            grid-template-rows: auto auto 1fr;
            width: 100vw;
            height: 100vh;
        }
        .header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-bottom: 1px solid #e5e5e7;
            background: #fff;
            z-index: 10;
        }
        .header-logo {
            width: 44px;
            height: 44px;
            object-fit: contain;
            flex-shrink: 0;
        }
        .header-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .header-company-name {
            font-size: 16px;
            font-weight: 600;
            color: #1d1d1f;
            margin: 0;
            letter-spacing: -0.2px;
        }
        .header-company-name-ar {
            font-size: 13px;
            font-weight: 400;
            color: #86868b;
            margin: 0;
        }
        .main {
            position: relative;
        }
        .lang-toggle {
            margin-right: auto;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #f5f5f7;
            border: 1px solid #e5e5e7;
            border-radius: 999px;
            padding: 4px;
        }
        .lang-btn {
            border: none;
            background: transparent;
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 700;
            cursor: pointer;
            color: #4b5563;
            transition: all 0.15s ease;
        }
        .lang-btn.active {
            background: #2563a5;
            color: #fff;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        .leaflet-control-attribution { display: none !important; }
        .leaflet-control-container { margin: 0 !important; padding: 0 !important; }

        .topbar {
            position: relative;
            height: 0;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.96);
            backdrop-filter: saturate(180%) blur(18px);
            -webkit-backdrop-filter: saturate(180%) blur(18px);
            border: none;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0;
            box-shadow: none;
            transition: height 0.2s ease, padding 0.2s ease, border 0.2s ease, box-shadow 0.2s ease;
            z-index: 5;
        }
        .topbar.active {
            height: auto;
            padding: 8px 16px;
            border-bottom: 1px solid #e5e5e7;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        }
        .topbar-title { font-weight: 700; color: #1d1d1f; }
        .topbar-sub { font-size: 12px; color: #6b7280; }
        .topbar-close {
            margin-left: auto;
            border: 1px solid #d1d5db;
            background: #fff;
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            font-weight: 700;
            color: #4b5563;
        }
        .topbar-content {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            width: 100%;
        }
        .topbar-stats {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .topbar-stat {
            background: #f8f8f8;
            border: 1px solid #e5e5e7;
            border-radius: 10px;
            padding: 8px 12px;
            min-width: 120px;
        }
        .topbar-stat .label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .topbar-stat .value {
            font-weight: 700;
            color: #1d1d1f;
            font-size: 14px;
        }
        .topbar-stat .value .pct {
            font-size: 11px;
            color: #6b7280;
            margin-left: 4px;
        }
        .topbar-stat.large {
            min-width: 220px;
        }
        .stat-row {
            display: flex;
            gap: 10px;
        }
        .substat {
            background: #fff;
            border: 1px solid #e5e5e7;
            border-radius: 8px;
            padding: 6px 10px;
            min-width: 100px;
            transition: background 0.15s ease, border-color 0.15s ease;
        }
        .substat.clickable { cursor: pointer; }
        .substat.clickable:hover {
            background: #f0f4ff;
            border-color: #cdd9ff;
        }
        .substat .label {
            font-size: 11px;
            color: #6b7280;
            margin-bottom: 2px;
            display: flex;
            gap: 4px;
        }
        .substat .value {
            font-weight: 700;
            color: #1d1d1f;
        }
        .phc-mini-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
        }
        .phc-pill {
            background: #f8f8f8;
            border: 1px solid #e5e5e7;
            border-radius: 10px;
            padding: 4px 8px;
            font-size: 11px;
            color: #1f2937;
            white-space: nowrap;
        }
        .zone-navigation {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #007AFF;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.2s ease;
        }
        .zone-navigation:hover {
            background: #007AFF;
            color: white;
            box-shadow: 0 6px 16px rgba(0, 122, 255, 0.3);
        }
        .zone-navigation:active {
            transform: translateY(-50%) scale(0.95);
        }
        .zone-nav-left {
            left: 20px;
        }
        .zone-nav-right {
            right: 20px;
        }
        .zone-navigation svg {
            width: 24px;
            height: 24px;
            fill: #007AFF;
            transition: fill 0.2s ease;
        }
        .zone-navigation:hover svg {
            fill: white;
        }
        
        /* RTL/LTR Support */
        [dir="rtl"] .lang-toggle {
            margin-right: 0;
            margin-left: auto;
        }
        [dir="ltr"] .lang-toggle {
            margin-left: 0;
            margin-right: auto;
        }
        [dir="rtl"] .topbar-close {
            margin-left: 0;
            margin-right: auto;
        }
        [dir="ltr"] .topbar-close {
            margin-right: 0;
            margin-left: auto;
        }
        [dir="rtl"] .topbar-stat .value .pct {
            margin-left: 0;
            margin-right: 4px;
        }
        [dir="ltr"] .topbar-stat .value .pct {
            margin-right: 0;
            margin-left: 4px;
        }
        [dir="rtl"] .zone-nav-left {
            left: auto;
            right: 20px;
        }
        [dir="ltr"] .zone-nav-left {
            right: auto;
            left: 20px;
        }
        [dir="rtl"] .zone-nav-right {
            right: auto;
            left: 20px;
        }
        [dir="ltr"] .zone-nav-right {
            left: auto;
            right: 20px;
        }
        [dir="rtl"] #generateReportBtn {
            margin-left: 0;
            margin-right: 16px;
        }
        [dir="ltr"] #generateReportBtn {
            margin-right: 0;
            margin-left: 16px;
        }
        
        /* Card ordering: RTL right-to-left, LTR left-to-right */
        [dir="rtl"] .topbar-content {
            direction: rtl;
        }
        [dir="ltr"] .topbar-content {
            direction: ltr;
        }
        [dir="rtl"] .topbar-stats {
            direction: rtl;
        }
        [dir="ltr"] .topbar-stats {
            direction: ltr;
        }
        [dir="rtl"] .stat-row {
            direction: rtl;
        }
        [dir="ltr"] .stat-row {
            direction: ltr;
        }
        [dir="rtl"] .phc-mini-list {
            direction: rtl;
        }
        [dir="ltr"] .phc-mini-list {
            direction: ltr;
        }
        /* PHC pill text direction within cards */
        [dir="rtl"] .phc-pill {
            direction: rtl;
            text-align: right;
        }
        [dir="ltr"] .phc-pill {
            direction: ltr;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="layout">
        <div class="header">
            <img src="light_mode_logo.png" alt="Najran Health Cluster" class="header-logo">
            <div class="header-content">
                <div class="header-company-name">Najran Health cluster</div>
                <div class="header-company-name-ar">تجمع نجران الصحي</div>
            </div>
            <div class="lang-toggle" aria-label="Language toggle">
                <button class="lang-btn active" id="langAr">العربية</button>
                <button class="lang-btn" id="langEn">English</button>
            </div>
        </div>
        <div class="topbar" id="topbar">
            <div class="topbar-content">
                <div style="flex: 1;">
                    <div class="topbar-title" id="topbarTitle"></div>
                    <div class="topbar-sub" id="topbarSub"></div>
                </div>
                <button id="generateReportBtn" style="display:none; margin-left:16px; padding:8px 16px; background:#007AFF; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px;">
                    <span data-lang="ar">تقرير شامل</span>
                    <span data-lang="en" style="display:none;">Generate Report</span>
                </button>
                <div class="topbar-stats">
                    <div class="topbar-stat">
                        <div class="label"><span data-lang="ar">الفحوصات</span><span data-lang="en" style="display:none;">Screening</span></div>
                        <div class="stat-row">
                            <div class="substat clickable" data-export="screening-screened">
                                <div class="label"><span data-lang="ar">المفحوصين</span><span data-lang="en" style="display:none;">Screened</span></div>
                                <div class="value" id="topbarScreened">--</div>
                            </div>
                            <div class="substat clickable" data-export="screening-target">
                                <div class="label"><span data-lang="ar">المستهدف</span><span data-lang="en" style="display:none;">Target</span></div>
                                <div class="value" id="topbarTarget">--</div>
                            </div>
                            <div class="substat clickable" data-export="screening-remaining">
                                <div class="label"><span data-lang="ar">المتبقي</span><span data-lang="en" style="display:none;">Remaining</span></div>
                                <div class="value" id="topbarRemaining">--</div>
                            </div>
                        </div>
                        <div class="phc-mini-list" id="phcTopScreening"></div>
                    </div>
                    <div class="topbar-stat large">
                        <div class="label">
                            <span data-lang="ar">السكري</span>
                            <span data-lang="en" style="display:none;">DM Status</span>
                        </div>
                        <div class="stat-row">
                            <div class="substat clickable" data-export="dm-controlled">
                                <div class="label"><span data-lang="ar">متحكم</span><span data-lang="en" style="display:none;">Controlled</span></div>
                                <div class="value" id="topbarControlled">--</div>
                            </div>
                            <div class="substat clickable" data-export="dm-uncontrolled">
                                <div class="label"><span data-lang="ar">غير متحكم</span><span data-lang="en" style="display:none;">Uncontrolled</span></div>
                                <div class="value" id="topbarUncontrolled">--</div>
                            </div>
                        </div>
                        <div class="phc-mini-list" id="phcTopDm"></div>
                    </div>
                    <div class="topbar-stat large">
                        <div class="label">
                            <span data-lang="ar">ما قبل السكري</span>
                            <span data-lang="en" style="display:none;">Pre-DM</span>
                        </div>
                        <div class="stat-row">
                            <div class="substat clickable" data-export="predm-normal">
                                <div class="label"><span data-lang="ar">عاد للطبيعي</span><span data-lang="en" style="display:none;">Returned to normal</span></div>
                                <div class="value" id="topbarPreDmNormal">--</div>
                            </div>
                            <div class="substat clickable" data-export="predm-still">
                                <div class="label"><span data-lang="ar">ما زال قبل سكري</span><span data-lang="en" style="display:none;">Still Pre-DM</span></div>
                                <div class="value" id="topbarPreDmStill">--</div>
                            </div>
                        </div>
                        <div class="phc-mini-list" id="phcTopPreDm"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="main">
            <div id="map"></div>
            <button class="zone-navigation zone-nav-left" id="zoneNavLeft" aria-label="Previous zone">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                </svg>
            </button>
            <button class="zone-navigation zone-nav-right" id="zoneNavRight" aria-label="Next zone">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                </svg>
            </button>
        </div>
    </div>

    <script>
        // Load DM JSON and aggregate stats
        const DM_JSON_URL = 'Diabetic_Patients.json';
        let dmRaw = [];
        let dmStatsByZone = {};
        let dmStatsReady = null;
        let preDmRaw = [];
        let preDmStatsByZone = {};
        let preDmStatsReady = null;
        let screeningRaw = [];
        let screeningStatsByZone = {};
        let screeningStatsReady = null;
        const clusterId = 'cluster';
        const CONTROLLED_STATUSES = ['controlled', 'below threshold'];
        const UNCONTROLLED_STATUSES = ['uncontrolled'];
        const PRE_DM_NORMAL_STATUSES = ['back to normal'];
        const PRE_DM_STILL_STATUSES = ['still pre-dm', 'still pre dm', 'progressed to diabetic'];
        const SCREENING_JSON_URL = 'screened.json';
        const isYes = (v) => String(v || '').trim().toLowerCase() === 'yes' || v === true;

        const normalizeKey = (v) => String(v || '').trim().replace(/\s+/g, ' ').toLowerCase();

        const formatCountPct = (count, total) => {
            const c = Number(count);
            const t = Number(total);
            if (!Number.isFinite(c)) return '--';
            if (!Number.isFinite(t) || t <= 0) return `${c}`;
            const pct = Math.min((c / t) * 100, 100).toFixed(1);
            return `${c} <span class="pct">(${pct}%)</span>`;
        };
        const pctText = (num, den) => {
            const n = Number(num);
            const d = Number(den);
            if (!Number.isFinite(n) || !Number.isFinite(d) || d <= 0) return '0%';
            return `${Math.min((n / d) * 100, 100).toFixed(1)}%`;
        };

        const toCsv = (rows) => {
            if (!rows || !rows.length) return '';
            const headers = Array.from(new Set(rows.flatMap(r => Object.keys(r))));
            const escape = (v) => {
                if (v === null || v === undefined) return '';
                const s = String(v).replace(/"/g, '""');
                return `"${s}"`;
            };
            const lines = [
                headers.join(','),
                ...rows.map(r => headers.map(h => escape(r[h])).join(','))
            ];
            return lines.join('\n');
        };

        const downloadCsv = (filename, rows) => {
            const csv = toCsv(rows);
            if (!csv) {
                alert('No data to export for this selection.');
                return;
            }
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        };

        const loadDmStats = async () => {
            try {
                const res = await fetch(DM_JSON_URL, { cache: 'no-store' });
                if (!res.ok) throw new Error('Failed to load DM JSON');
                // The JSON may contain NaN which is invalid; normalize before parse.
                const raw = await res.text();
                const safe = raw.replace(/\bNaN\b/g, 'null');
                const data = JSON.parse(safe);
                dmRaw = data;
                const stats = {};
                data.forEach(row => {
                    const zone = (row.LAST_VISIT_ZONE || row.Zone || '').toUpperCase();
                    const statusRaw = String(row.CONTROL_STATUS || '').trim().toLowerCase();
                    if (!zone) return;
                    if (!stats[zone]) stats[zone] = { controlled: 0, uncontrolled: 0 };
                    const isControlled = CONTROLLED_STATUSES.includes(statusRaw);
                    const isUncontrolled = UNCONTROLLED_STATUSES.includes(statusRaw);
                    if (isControlled) stats[zone].controlled += 1;
                    if (isUncontrolled) stats[zone].uncontrolled += 1;
                });
                // Aggregate totals for full cluster
                const total = { controlled: 0, uncontrolled: 0 };
                Object.values(stats).forEach(z => {
                    total.controlled += z.controlled || 0;
                    total.uncontrolled += z.uncontrolled || 0;
                });
                stats[clusterId.toUpperCase()] = total;
                dmStatsByZone = stats;
            } catch (e) {
                console.warn('DM stats load error', e);
                dmStatsByZone = {};
            }
        };

        const loadPreDmStats = async () => {
            try {
                const res = await fetch('Pre-DM_Patients.json', { cache: 'no-store' });
                if (!res.ok) throw new Error('Failed to load Pre-DM JSON');
                const raw = await res.text();
                const safe = raw.replace(/\bNaN\b/g, 'null');
                const data = JSON.parse(safe);
                preDmRaw = data;
                const stats = {};
                data.forEach(row => {
                    const zone = (row.LAST_VISIT_ZONE || row.Zone || '').toUpperCase();
                    const statusRaw = String(row.STATUS || '').trim().toLowerCase();
                    if (!zone) return;
                    if (!stats[zone]) stats[zone] = { normal: 0, still: 0 };
                    const isNormal = PRE_DM_NORMAL_STATUSES.includes(statusRaw);
                    const isStill = PRE_DM_STILL_STATUSES.includes(statusRaw);
                    if (isNormal) stats[zone].normal += 1;
                    if (isStill) stats[zone].still += 1;
                });
                const total = { normal: 0, still: 0 };
                Object.values(stats).forEach(z => {
                    total.normal += z.normal || 0;
                    total.still += z.still || 0;
                });
                stats[clusterId.toUpperCase()] = total;
                preDmStatsByZone = stats;
            } catch (e) {
                console.warn('Pre-DM stats load error', e);
                preDmStatsByZone = {};
            }
        };

        const loadScreeningStats = async () => {
            try {
                const res = await fetch(SCREENING_JSON_URL, { cache: 'no-store' });
                if (!res.ok) throw new Error('Failed to load screening JSON');
                const raw = await res.text();
                const safe = raw.replace(/\bNaN\b/g, 'null');
                const data = JSON.parse(safe);
                screeningRaw = data;
                const stats = {};
                data.forEach(row => {
                    const zone = (row.Zone || row.LAST_VISIT_ZONE || '').toUpperCase();
                    if (!zone) return;
                    if (!stats[zone]) stats[zone] = { screened: 0, target: 0 };
                    const target = isYes(row.IS_TARGETED);
                    const screened = isYes(row.HAS_LAB) || (!isYes(row.REMAINING) && target);
                    if (target) stats[zone].target += 1;
                    if (screened) stats[zone].screened += 1;
                });
                const total = { screened: 0, target: 0 };
                Object.values(stats).forEach(z => {
                    total.screened += z.screened || 0;
                    total.target += z.target || 0;
                });
                stats[clusterId.toUpperCase()] = total;
                screeningStatsByZone = stats;
            } catch (e) {
                console.warn('Screening stats load error', e);
                screeningStatsByZone = {};
            }
        };
        // Zone polygons (copied from kpi_map.html)
        const sghZoneCoordinates = [
            [16.949748, 46.999512],[17.283773, 46.749573],[17.236560, 46.381531],[17.416166, 46.373291],[17.953905, 45.904999],[18.110608, 45.821228],[18.329757, 45.601501],[18.469187, 45.561333],[18.513144, 45.541420],[18.914724, 46.347198],[19.080285, 46.540833],[19.316973, 46.537399],[19.333168, 47.528229],[19.334438, 51.998291],[19.002361, 52.003784],[18.790599, 50.781555],[18.618897, 49.118500],[18.167372, 48.183975],[17.450198, 47.598267],[17.117127, 47.469177],[16.956942, 47.180786]
        ];
        const kghZoneCoordinates = [
            [17.430902, 44.337044],[17.502296, 44.418755],[17.523251, 44.426994],[17.532418, 44.415665],[17.541257, 44.417038],[17.540602, 44.393349],[17.556642, 44.390259],[17.561552, 44.397469],[17.554678, 44.450340],[17.554024, 44.458237],[17.567444, 44.456177],[17.578245, 44.447594],[17.584137, 44.435921],[17.585118, 44.429398],[17.591664, 44.426308],[17.599846, 44.428024],[17.618826, 44.458923],[17.634205, 44.449654],[17.647619, 44.470940],[17.661033, 44.474716],[17.715003, 44.442444],[17.790208, 44.441757],[17.807533, 44.470596],[17.880083, 44.478836],[17.835639, 44.545784],[17.832698, 44.555054],[17.919282, 44.573593],[17.933001, 44.567413],[17.976767, 44.576340],[17.957172, 44.642258],[17.955212, 44.662170],[17.965663, 44.696503],[17.953253, 44.745941],[17.918627, 44.818726],[17.956517, 44.853058],[17.995706, 44.959488],[18.044016, 45.045319],[18.098846, 45.343323],[18.136697, 45.354309],[18.158883, 45.354309],[18.252811, 45.407867],[18.327136, 45.418854],[18.342779, 45.446320],[18.363634, 45.449066],[18.506947, 45.530090],[18.513631, 45.541248],[18.468618, 45.561247],[18.329593, 45.601158],[18.110552, 45.821207],[17.953253, 45.904655],[17.415999, 46.373034],[17.236561, 46.381359],[17.233249, 46.365738],[17.252267, 46.086960],[17.333909, 45.399971],[17.433360, 45.216637],[17.435157, 44.888420],[17.434343, 44.649725],[17.405516, 44.566641],[17.433321, 44.467077],[17.433360, 44.365196]
        ];
        const nnghZoneCoordinates = [
            [17.430903, 44.336700],[17.418455, 44.227867],[17.413869, 44.209328],[17.414852, 44.190102],[17.464312, 44.176369],[17.477411, 44.174652],[17.484288, 44.179459],[17.484616, 44.187698],[17.486253, 44.194221],[17.481996, 44.208984],[17.512448, 44.205208],[17.524890, 44.224777],[17.534711, 44.238510],[17.541259, 44.246063],[17.545514, 44.260826],[17.549115, 44.261169],[17.552389, 44.271812],[17.550425, 44.287262],[17.568755, 44.286232],[17.580538, 44.262199],[17.591010, 44.257736],[17.694399, 44.223404],[17.704211, 44.224091],[17.738222, 44.241257],[17.770921, 44.252930],[17.782691, 44.254303],[17.804266, 44.268723],[17.812765, 44.292755],[17.823225, 44.306488],[17.833684, 44.312668],[17.859175, 44.316101],[17.878781, 44.364853],[17.908186, 44.377899],[17.917333, 44.390945],[17.900345, 44.406052],[17.890543, 44.424591],[17.880741, 44.478149],[17.809496, 44.471283],[17.791190, 44.443130],[17.719256, 44.441757],[17.663650, 44.474716],[17.649255, 44.472656],[17.635514, 44.451370],[17.619153, 44.458923],[17.599519, 44.429398],[17.591010, 44.427338],[17.585119, 44.431458],[17.581191, 44.444504],[17.567445, 44.458237],[17.556315, 44.458237],[17.554053, 44.458199],[17.555643, 44.442956],[17.561553, 44.398499],[17.556315, 44.391632],[17.540603, 44.394379],[17.541912, 44.417725],[17.532746, 44.416351],[17.524234, 44.427338],[17.504589, 44.420471],[17.502303, 44.418744],[17.502296, 44.418712],[17.476839, 44.389462],[17.472024, 44.384079]
        ];
        const wnhZoneCoordinates = [
            [17.414201, 44.189758],[17.408304, 44.138260],[17.383405, 44.132767],[17.367022, 44.112854],[17.366366, 44.099808],[17.405028, 44.067535],[17.403718, 44.049683],[17.391924, 44.023590],[17.400442, 44.011230],[17.330974, 43.967972],[17.339495, 43.904114],[17.337528, 43.832016],[17.353914, 43.807297],[17.374230, 43.788071],[17.370298, 43.720093],[17.386026, 43.711166],[17.401752, 43.694000],[17.416822, 43.694687],[17.431890, 43.685760],[17.430580, 43.702240],[17.438441, 43.706360],[17.448268, 43.719406],[17.467264, 43.714600],[17.467919, 43.744812],[17.473813, 43.788757],[17.513107, 43.860855],[17.525549, 43.936386],[17.553702, 44.038010],[17.556321, 44.095688],[17.526858, 44.103928],[17.525549, 44.116974],[17.533406, 44.165039],[17.531442, 44.180832],[17.526858, 44.184952],[17.522275, 44.182892],[17.522275, 44.195251],[17.515072, 44.187698],[17.510488, 44.189072],[17.511143, 44.206238],[17.482328, 44.209671],[17.484948, 44.195938],[17.484293, 44.180145],[17.477088, 44.174652]
        ];
        const mchZoneCoordinates = [
            [17.550588, 44.243660],[17.549279, 44.255333],[17.548461, 44.260826],[17.551898, 44.271641],[17.550916, 44.286747],[17.568755, 44.285889],[17.581029, 44.261169],[17.590520, 44.257393],[17.589211, 44.242630],[17.570065, 44.232159],[17.573829, 44.223061],[17.577265, 44.214134],[17.567282, 44.204521],[17.550752, 44.218769],[17.550097, 44.221687],[17.550425, 44.224262],[17.560081, 44.228554],[17.557463, 44.234905],[17.554189, 44.241943]
        ];
        const kkhZoneCoordinates = [
            [17.512778, 44.205208],[17.511796, 44.192505],[17.510813, 44.187698],[17.515070, 44.186668],[17.521291, 44.194908],[17.520308, 44.187355],[17.521945, 44.182892],[17.526202, 44.183922],[17.530785, 44.178429],[17.533404, 44.164352],[17.524892, 44.112854],[17.525547, 44.102554],[17.556974, 44.094315],[17.552391, 44.038010],[17.524893, 43.935699],[17.511797, 43.860168],[17.473812, 43.788757],[17.465953, 43.744812],[17.467263, 43.713226],[17.484619, 43.708763],[17.485929, 43.702583],[17.487566, 43.692970],[17.496407, 43.690567],[17.505903, 43.692970],[17.527185, 43.651428],[17.559921, 43.634605],[17.570068, 43.647308],[17.576941, 43.651085],[17.585451, 43.651772],[17.603450, 43.649025],[17.620140, 43.646622],[17.630283, 43.648682],[17.630283, 43.654518],[17.626684, 43.661385],[17.615231, 43.666534],[17.582832, 43.675117],[17.531441, 43.706360],[17.517363, 43.737259],[17.517690, 43.743782],[17.519327, 43.763351],[17.516708, 43.785667],[17.534060, 43.789444],[17.540280, 43.807983],[17.553047, 43.827553],[17.575632, 43.845062],[17.583487, 43.852272],[17.583487, 43.866692],[17.595269, 43.878708],[17.601814, 43.880081],[17.616867, 43.910980],[17.645007, 43.937073],[17.656457, 43.964539],[17.675432, 43.994751],[17.695385, 44.007111],[17.697674, 44.011230],[17.705851, 44.015007],[17.715336, 44.028397],[17.722531, 44.040756],[17.735939, 44.051399],[17.743133, 44.082642],[17.745749, 44.103928],[17.749346, 44.114227],[17.748365, 44.131050],[17.736920, 44.146500],[17.724166, 44.158859],[17.721550, 44.170189],[17.711084, 44.179459],[17.706832, 44.181862],[17.694404, 44.222717],[17.591669, 44.257736],[17.589051, 44.242973],[17.571377, 44.233017],[17.577268, 44.214821],[17.567122, 44.205208],[17.550755, 44.218941],[17.550755, 44.223747],[17.560248, 44.227867],[17.555011, 44.242630],[17.550428, 44.244347],[17.549773, 44.259453],[17.545845, 44.261169],[17.541589, 44.246063],[17.533732, 44.236794],[17.517035, 44.212418]
        ];
        const tghZoneCoordinates = [
            [17.908019, 43.918362],[17.900995, 43.944454],[17.900015, 43.957500],[17.906386, 43.976727],[17.907202, 43.991489],[17.887906, 44.026337],[17.880064, 44.039383],[17.894440, 44.069595],[17.896400, 44.092255],[17.897707, 44.158173],[17.897054, 44.179459],[17.865033, 44.211044],[17.858497, 44.226151],[17.861765, 44.270096],[17.860458, 44.305115],[17.858497, 44.316101],[17.879410, 44.364166],[17.908815, 44.377899],[17.916656, 44.389572],[17.898361, 44.405365],[17.887906, 44.424591],[17.880164, 44.478579],[17.835885, 44.545698],[17.832943, 44.554882],[17.919279, 44.573572],[17.932988, 44.567392],[17.976813, 44.576254],[17.957184, 44.642268],[17.955219, 44.662170],[17.965791, 44.696546],[17.953581, 44.746284],[17.918737, 44.818726],[17.956606, 44.852886],[17.996037, 44.959574],[18.044277, 45.045319],[18.098876, 45.343312],[18.136737, 45.354266],[18.158922, 45.354245],[18.252951, 45.407782],[18.327192, 45.418768],[18.342825, 45.446298],[18.363649, 45.449023],[18.506796, 45.529575],[18.492308, 45.486832],[18.455186, 45.380402],[18.440082, 45.375981],[18.439838, 45.375595],[18.437599, 45.374908],[18.438413, 45.370789],[18.437599, 45.367870],[18.438413, 45.362892],[18.438087, 45.349846],[18.438576, 45.337658],[18.438902, 45.324612],[18.439553, 45.311952],[18.437965, 45.304914],[18.434668, 45.290451],[18.432388, 45.281353],[18.431085, 45.277405],[18.433039, 45.275173],[18.434342, 45.273027],[18.449487, 45.254745],[18.459501, 45.241742],[18.459582, 45.237923],[18.458768, 45.233974],[18.457954, 45.229511],[18.455511, 45.227795],[18.452743, 45.224876],[18.446393, 45.219555],[18.433324, 45.206337],[18.426850, 45.201359],[18.410727, 45.186596],[18.405189, 45.180931],[18.398836, 45.175095],[18.396393, 45.172863],[18.395090, 45.166512],[18.393950, 45.158958],[18.390692, 45.140591],[18.388737, 45.129433],[18.386457, 45.114326],[18.383199, 45.096989],[18.380755, 45.083599],[18.379452, 45.075188],[18.375379, 45.053215],[18.373913, 45.047035],[18.373424, 45.042915],[18.373098, 45.038280],[18.372121, 45.034161],[18.370981, 45.030899],[18.370818, 45.027466],[18.369677, 45.021286],[18.369189, 45.017166],[18.367396, 45.009441],[18.366092, 45.001545],[18.365604, 44.997597],[18.364790, 44.993992],[18.369187, 44.988027],[18.373098, 44.982662],[18.376357, 44.977169],[18.381244, 44.970989],[18.386619, 44.963093],[18.401117, 44.943008],[18.403723, 44.938717],[18.407632, 44.933739],[18.409749, 44.929790],[18.411867, 44.926701],[18.413984, 44.921894],[18.418707, 44.911423],[18.426036, 44.888034],[18.427624, 44.883785],[18.428520, 44.880095],[18.436703, 44.862671],[18.444439, 44.849753],[18.445416, 44.848294],[18.434749, 44.816923],[18.427503, 44.794693],[18.452908, 44.533768],[18.466585, 44.502869],[18.491169, 44.498749],[18.492635, 44.446735],[18.478470, 44.423561],[18.392320, 44.402790],[18.352243, 44.400043],[18.266030, 44.324512],[18.238641, 44.265289],[18.221684, 44.250183],[18.207171, 44.264088],[18.190537, 44.264088],[18.182546, 44.250355],[18.209780, 44.234047],[18.233587, 44.152851],[18.229184, 44.078522],[18.247771, 44.060841],[18.284286, 44.064789],[18.310364, 44.053802],[18.328616, 44.063244],[18.367395, 43.956299],[18.387433, 43.930378],[18.412029, 43.934498],[18.427827, 43.937416],[18.441182, 43.938961],[18.441344, 43.933125],[18.438413, 43.929691],[18.444276, 43.918362],[18.440530, 43.914070],[18.435156, 43.910980],[18.426199, 43.910465],[18.424733, 43.906345],[18.419684, 43.906002],[18.420498, 43.904457],[18.422616, 43.901367],[18.421639, 43.898792],[18.417567, 43.899136],[18.417241, 43.896904],[18.417567, 43.892956],[18.413658, 43.891926],[18.404699, 43.893299],[18.392646, 43.889351],[18.385315, 43.884544],[18.376029, 43.884716],[18.366255, 43.881454],[18.364462, 43.879566],[18.353220, 43.860683],[18.344422, 43.857765],[18.332690, 43.855019],[18.326334, 43.850727],[18.316883, 43.844891],[18.308571, 43.844547],[18.298303, 43.852444],[18.288524, 43.854675],[18.283471, 43.851414],[18.277277, 43.848495],[18.275484, 43.848667],[18.272061, 43.845577],[18.267497, 43.841629],[18.263910, 43.838711],[18.259835, 43.834763],[18.260487, 43.829784],[18.256411, 43.826523],[18.249564, 43.820343],[18.251115, 43.785925],[18.254865, 43.779659],[18.255028, 43.772621],[18.257391, 43.769875],[18.257636, 43.764381],[18.252338, 43.756742],[18.250870, 43.749189],[18.245490, 43.741894],[18.231469, 43.734941],[18.228045, 43.736401],[18.226333, 43.740950],[18.226414, 43.749704],[18.223887, 43.753910],[18.212636, 43.763866],[18.197226, 43.774166],[18.189154, 43.776484],[18.182467, 43.775454],[18.178308, 43.773909],[18.167380, 43.767128],[18.138673, 43.741293],[18.129211, 43.741078],[18.121992, 43.744512],[18.106655, 43.759232],[18.088624, 43.792276],[18.084830, 43.809443],[18.045458, 43.873301],[18.012280, 43.914714],[18.000733, 43.923855],[17.975426, 43.924928],[17.959219, 43.910422],[17.956198, 43.909564],[17.951462, 43.906345],[17.933130, 43.885617],[17.925986, 43.881969]
        ];
        const bghZoneCoordinates = [
            [17.559753, 43.634005],[17.562290, 43.639112],[17.569737, 43.647351],[17.575833, 43.651171],[17.584132, 43.652458],[17.605241, 43.648682],[17.620948, 43.646793],[17.628638, 43.647480],[17.631256, 43.649712],[17.629783, 43.655376],[17.624711, 43.662758],[17.612768, 43.668079],[17.597714, 43.670826],[17.580532, 43.675804],[17.530777, 43.706703],[17.523738, 43.724384],[17.515880, 43.738976],[17.517845, 43.758202],[17.518827, 43.763695],[17.516044, 43.772106],[17.515553, 43.784466],[17.521282, 43.787556],[17.530286, 43.787727],[17.535196, 43.792362],[17.539452, 43.806953],[17.554183, 43.828239],[17.564657, 43.834763],[17.575950, 43.844547],[17.580204, 43.849869],[17.587241, 43.853817],[17.603768, 43.859825],[17.643688, 43.862743],[17.660047, 43.858967],[17.679347, 43.847294],[17.695702, 43.846436],[17.719578, 43.851929],[17.731678, 43.850384],[17.742306, 43.846264],[17.749663, 43.841114],[17.756857, 43.842144],[17.761761, 43.849869],[17.771570, 43.872871],[17.777945, 43.878708],[17.785955, 43.876820],[17.809491, 43.871326],[17.822893, 43.867378],[17.829593, 43.860683],[17.837437, 43.857765],[17.851000, 43.864117],[17.906057, 43.875961],[17.925331, 43.882141],[17.933171, 43.885660],[17.951381, 43.906260],[17.956198, 43.909521],[17.959138, 43.910379],[17.969426, 43.920250],[17.975386, 43.924885],[18.000775, 43.923855],[18.012284, 43.914671],[18.024528, 43.900423],[18.045665, 43.873043],[18.068025, 43.838625],[18.084835, 43.809357],[18.088588, 43.792362],[18.106700, 43.759232],[18.122037, 43.744469],[18.129215, 43.741035],[18.138677, 43.741207],[18.154174, 43.754597],[18.167386, 43.766956],[18.178314, 43.773994],[18.177662, 43.768501],[18.178151, 43.756657],[18.170811, 43.751507],[18.164613, 43.739491],[18.153522, 43.727646],[18.140798, 43.719234],[18.124810, 43.716488],[18.116816, 43.718891],[18.111758, 43.713913],[18.101968, 43.711853],[18.096910, 43.705673],[18.089240, 43.702240],[18.075696, 43.689709],[18.063293, 43.684387],[18.055788, 43.684387],[18.038487, 43.692627],[18.026735, 43.702927],[18.021184, 43.708763],[18.017266, 43.708420],[18.014655, 43.703613],[18.002247, 43.695030],[17.991798, 43.689194],[17.980695, 43.676834],[17.966653, 43.667908],[17.958488, 43.667908],[17.949996, 43.658638],[17.939544, 43.667564],[17.925498, 43.652802],[17.918638, 43.640442],[17.911451, 43.632545],[17.910471, 43.622246],[17.902630, 43.618126],[17.899036, 43.612633],[17.889235, 43.617096],[17.879513, 43.622932],[17.870119, 43.628340],[17.869547, 43.632374],[17.866525, 43.634176],[17.865789, 43.637180],[17.862767, 43.636150],[17.858682, 43.642159],[17.858927, 43.645592],[17.856395, 43.646536],[17.856313, 43.648252],[17.855578, 43.650398],[17.856966, 43.653059],[17.858028, 43.657608],[17.856558, 43.657436],[17.854107, 43.656492],[17.853453, 43.655291],[17.853944, 43.654089],[17.853617, 43.652630],[17.851329, 43.652201],[17.849123, 43.650570],[17.846427, 43.650141],[17.844139, 43.651514],[17.842751, 43.653746],[17.840790, 43.653316],[17.837276, 43.651342],[17.832782, 43.650656],[17.829187, 43.649712],[17.828370, 43.650999],[17.826164, 43.650913],[17.826246, 43.653059],[17.825102, 43.653574],[17.822323, 43.652887],[17.821670, 43.654432],[17.820689, 43.654175],[17.819545, 43.651171],[17.818891, 43.648939],[17.816603, 43.647051],[17.813171, 43.649368],[17.813825, 43.652716],[17.812436, 43.652458],[17.810638, 43.654776],[17.808595, 43.653316],[17.809167, 43.651772],[17.808350, 43.649025],[17.804591, 43.649540],[17.802221, 43.652458],[17.802875, 43.654261],[17.800913, 43.654175],[17.800178, 43.652973],[17.797971, 43.651686],[17.795846, 43.653231],[17.796418, 43.655119],[17.795765, 43.656235],[17.791597, 43.656063],[17.791597, 43.653574],[17.787592, 43.656836],[17.783342, 43.655977],[17.782606, 43.659153],[17.782034, 43.659067],[17.780808, 43.657265],[17.780400, 43.653574],[17.779255, 43.653316],[17.778765, 43.655806],[17.776476, 43.656492],[17.777049, 43.652287],[17.775741, 43.651686],[17.774024, 43.655977],[17.772798, 43.657522],[17.774760, 43.661556],[17.769447, 43.660355],[17.770428, 43.658638],[17.768793, 43.657007],[17.766178, 43.656063],[17.763153, 43.658638],[17.762581, 43.661642],[17.766831, 43.662157],[17.765769, 43.664904],[17.762254, 43.664989],[17.762990, 43.667307],[17.764625, 43.672371],[17.768221, 43.675375],[17.766750, 43.677950],[17.762744, 43.674345],[17.761927, 43.672199],[17.759475, 43.672113],[17.759557, 43.674002],[17.756941, 43.672800],[17.756696, 43.675289],[17.757431, 43.677692],[17.757023, 43.678808],[17.753099, 43.678293],[17.751382, 43.678894],[17.753181, 43.680353],[17.754407, 43.681297],[17.754243, 43.683529],[17.754815, 43.684988],[17.753099, 43.685417],[17.750074, 43.683872],[17.750238, 43.685846],[17.749666, 43.687391],[17.747131, 43.685760],[17.748112, 43.689623],[17.749993, 43.691511],[17.747213, 43.693657],[17.745496, 43.696060],[17.739283, 43.697176],[17.740837, 43.699408],[17.741899, 43.702755],[17.743371, 43.705072],[17.744515, 43.705587],[17.743453, 43.707905],[17.740183, 43.707047],[17.741245, 43.704386],[17.740183, 43.703270],[17.737567, 43.707476],[17.734297, 43.710737],[17.731353, 43.711338],[17.730536, 43.707819],[17.727756, 43.707132],[17.725303, 43.710566],[17.725876, 43.715458],[17.724486, 43.717432],[17.721134, 43.717346],[17.710096, 43.715372],[17.706010, 43.715458],[17.705847, 43.712368],[17.702740, 43.712025],[17.704048, 43.710308],[17.699632, 43.707733],[17.703067, 43.708420],[17.700287, 43.704300],[17.697179, 43.703442],[17.694399, 43.701725],[17.692436, 43.704472],[17.691128, 43.703270],[17.691619, 43.699837],[17.688511, 43.697605],[17.690474, 43.694687],[17.687530, 43.691425],[17.689493, 43.686962],[17.686549, 43.686104],[17.684259, 43.688507],[17.681806, 43.685417],[17.680824, 43.681812],[17.671992, 43.679409],[17.664795, 43.681812],[17.662828, 43.677006],[17.664627, 43.674431],[17.662664, 43.666706],[17.667244, 43.670654],[17.670025, 43.667221],[17.666099, 43.662415],[17.667081, 43.657780],[17.664954, 43.651085],[17.659393, 43.644562],[17.661683, 43.640957],[17.659883, 43.639755],[17.662173, 43.635807],[17.660701, 43.634090],[17.659393, 43.635635],[17.655630, 43.633404],[17.660701, 43.630142],[17.660211, 43.628254],[17.655630, 43.628597],[17.654158, 43.621559],[17.658084, 43.621044],[17.660865, 43.617954],[17.657266, 43.616581],[17.653504, 43.613834],[17.650069, 43.613491],[17.641890, 43.615036],[17.602296, 43.627052],[17.578569, 43.628426]
        ];
        const yghZoneCoordinates = [
            [18.506957, 45.527344],[18.454857, 45.380402],[18.437921, 45.374908],[18.439224, 45.311737],[18.431407, 45.277405],[18.460068, 45.241699],[18.457463, 45.229340],[18.396226, 45.173035],[18.364948, 44.994507],[18.411863, 44.927216],[18.445738, 44.848938],[18.427499, 44.795380],[18.453555, 44.533081],[18.466581, 44.502869],[18.491329, 44.498749],[18.492631, 44.446564],[18.478304, 44.423218],[18.392317, 44.402618],[18.351914, 44.399872],[18.265863, 44.324341],[18.238475, 44.265289],[18.221518, 44.250183],[18.207168, 44.263916],[18.190208, 44.263916],[18.182380, 44.250183],[18.209777, 44.233704],[18.233257, 44.152679],[18.229344, 44.078522],[18.247605, 44.060669],[18.284120, 44.064789],[18.310198, 44.053802],[18.328450, 44.063416],[18.367555, 43.956299],[18.387104, 43.930206],[18.411863, 43.934326],[18.402742, 43.943939],[18.420984, 43.963165],[18.428801, 43.985138],[18.444435, 44.004364],[18.477002, 43.916473],[18.501748, 43.946686],[18.519979, 43.948059],[18.548625, 43.956299],[18.553833, 43.996124],[18.572059, 44.002991],[18.588982, 43.997498],[18.585077, 43.981018],[18.604601, 43.974152],[18.624123, 43.990631],[18.647547, 43.986511],[18.676171, 44.016724],[18.749012, 44.086761],[18.752913, 44.122467],[18.765917, 44.137573],[18.807522, 44.090881],[18.816621, 44.064789],[18.830920, 44.090881],[18.858214, 44.099121],[18.862112, 44.129333],[18.899796, 44.141693],[18.890701, 44.195251],[18.923181, 44.228210],[18.954356, 44.313354],[18.940068, 44.320221],[18.933573, 44.376526],[19.090673, 44.365540],[19.111436, 44.400558],[19.143225, 44.410858],[19.185384, 44.421844],[19.189924, 44.434204],[19.204190, 44.440384],[19.199651, 44.452744],[19.191869, 44.460983],[19.173710, 44.463043],[19.165279, 44.471283],[19.202893, 44.480896],[19.211323, 44.489136],[19.224291, 44.468536],[19.232719, 44.448624],[19.240499, 44.452744],[19.262213, 44.445877],[19.283927, 44.467163],[19.292028, 44.468536],[19.297537, 44.477119],[19.304018, 44.473686],[19.307582, 44.474716],[19.310174, 44.480209],[19.316006, 44.477463],[19.318274, 44.453773],[19.319570, 44.434547],[19.316654, 44.425278],[19.313414, 44.420128],[19.317626, 44.413605],[19.317626, 44.388542],[19.320866, 44.386826],[19.333501, 44.395752],[19.354558, 44.395409],[19.362332, 44.390945],[19.365895, 44.386482],[19.375936, 44.389572],[19.391157, 44.383049],[19.406054, 44.384422],[19.418683, 44.390945],[19.419978, 44.553680],[19.449120, 45.089264],[19.209377, 45.119476],[19.305317, 45.362549],[19.305317, 45.405807],[19.296244, 45.406494],[19.316976, 46.537228],[19.080329, 46.540747],[18.914751, 46.347188],[18.513754, 45.541377]
        ];
        const hghZoneCoordinates = [
            [17.583055, 43.851457],[17.582523, 43.852959],[17.582994, 43.856542],[17.582666, 43.865082],[17.583300, 43.866305],[17.594100, 43.877399],[17.599398, 43.879094],[17.600482, 43.880167],[17.602262, 43.883085],[17.608846, 43.897934],[17.609992, 43.900938],[17.619563, 43.914499],[17.633061, 43.927031],[17.640750, 43.932610],[17.645657, 43.938446],[17.650810, 43.951578],[17.655145, 43.962994],[17.664796, 43.977242],[17.672157, 43.990459],[17.675183, 43.994751],[17.694318, 44.006424],[17.695954, 44.008312],[17.697098, 44.010544],[17.700206, 44.010973],[17.704049, 44.013462],[17.713452, 44.024448],[17.718521, 44.033289],[17.722200, 44.039555],[17.725470, 44.042988],[17.732747, 44.048052],[17.735608, 44.052343],[17.736426, 44.059296],[17.740758, 44.071913],[17.743538, 44.083500],[17.743620, 44.087877],[17.745745, 44.104013],[17.748361, 44.113111],[17.748770, 44.125128],[17.747625, 44.130707],[17.744437, 44.136801],[17.740840, 44.140749],[17.737488, 44.145298],[17.732420, 44.148560],[17.722854, 44.159031],[17.721873, 44.162550],[17.721955, 44.165640],[17.718030, 44.172506],[17.711326, 44.178686],[17.706175, 44.181604],[17.703231, 44.195766],[17.698325, 44.213276],[17.694400, 44.222975],[17.704376, 44.223404],[17.739287, 44.241686],[17.771412, 44.252501],[17.779667, 44.253788],[17.797239, 44.264517],[17.804512, 44.270868],[17.811949, 44.290953],[17.822572, 44.306660],[17.830988, 44.312067],[17.858604, 44.315844],[17.860483, 44.305201],[17.861953, 44.270096],[17.858604, 44.226065],[17.865385, 44.210787],[17.897242, 44.179459],[17.897814, 44.158001],[17.896589, 44.092169],[17.894628, 44.069681],[17.880252, 44.039555],[17.907452, 43.991661],[17.906553, 43.976898],[17.899937, 43.957586],[17.901081, 43.944283],[17.908105, 43.918362],[17.926072, 43.882313],[17.907207, 43.876219],[17.851333, 43.864202],[17.837525, 43.857765],[17.829681, 43.860683],[17.822981, 43.867464],[17.778033, 43.878708],[17.771739, 43.872957],[17.761931, 43.849869],[17.756863, 43.842144],[17.749587, 43.841114],[17.742312, 43.846264],[17.731684, 43.850470],[17.719911, 43.851929],[17.695708, 43.846350],[17.679435, 43.847294],[17.660134, 43.859053],[17.643367, 43.862829],[17.603774, 43.859911],[17.587083, 43.853817]
        ];

        let currentLang = 'ar';

        const map = L.map('map').setView([18.0, 48.0], 7);
        const minimalistMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '© OpenStreetMap contributors © CARTO',
            subdomains: 'abcd',
            maxZoom: 20
        });
        minimalistMap.addTo(map);

        const zoneColors = {
            sgh: '#4A90E2',
            kgh: '#5BA3F5',
            nngh: '#357ABD',
            wnh: '#6BB6FF',
            mch: '#2E5C8A',
            kkh: '#7FC8F8',
            tgh: '#1E6BA8',
            bgh: '#8CC8FF',
            ygh: '#2563A5',
            hgh: '#4A9EFF'
        };

        const addPoly = (coords, color) => L.polygon(coords, {
            fillColor: color,
            fillOpacity: 0.5,
            weight: 2,
            color
        }).addTo(map);

        const polygons = {
            sgh: addPoly(sghZoneCoordinates, zoneColors.sgh),
            kgh: addPoly(kghZoneCoordinates, zoneColors.kgh),
            nngh: addPoly(nnghZoneCoordinates, zoneColors.nngh),
            wnh: addPoly(wnhZoneCoordinates, zoneColors.wnh),
            mch: addPoly(mchZoneCoordinates, zoneColors.mch),
            kkh: addPoly(kkhZoneCoordinates, zoneColors.kkh),
            tgh: addPoly(tghZoneCoordinates, zoneColors.tgh),
            bgh: addPoly(bghZoneCoordinates, zoneColors.bgh),
            ygh: addPoly(yghZoneCoordinates, zoneColors.ygh),
            hgh: addPoly(hghZoneCoordinates, zoneColors.hgh)
        };

        // Zone labels
        const zoneNames = {
            sgh: { ar: 'مستشفى شرورة العام', en: 'SGH' },
            kgh: { ar: 'مستشفى خباش العام', en: 'KGH' },
            nngh: { ar: 'مستشفى نجران العام الجديد', en: 'NNGH' },
            wnh: { ar: 'مستشفى نجران العام - البلد', en: 'WNH' },
            mch: { ar: 'مستشفى الولادة والأطفال', en: 'MCH' },
            kkh: { ar: 'مستشفى الملك خالد', en: 'KKH' },
            tgh: { ar: 'مستشفى ثار العام', en: 'TGH' },
            bgh: { ar: 'مستشفى بدر الجنوب العام', en: 'BGH' },
            ygh: { ar: 'مستشفى يدمة العام', en: 'YGH' },
            hgh: { ar: 'مستشفى حبونا العام', en: 'HGH' },
            [clusterId]: { ar: 'تجمع نجران الصحي', en: 'Najran Health Cluster' }
        };

        // Hide zone labels on the map (only keep topbar titles)
        const applyZoneLabels = () => {
            Object.entries(polygons).forEach(([, poly]) => {
                poly.unbindTooltip();
            });
        };

        // PHC markers (subset)
        const healthcareCenters = [
            { name_ar: 'مركز الرعاية الصحية الاولية باسكان قوى الامن بشرورة', name_en: 'Security Forces PHCC Sharoora', lat: 17.4802438, lng: 47.13076738, zone: 'sgh' },
            { name_ar: 'مركز الرعاية الصحية الاولية بالروضة الشمالية بشرورة', name_en: 'RAWDAH PHCC Sharoora', lat: 17.51024315, lng: 47.10210837, zone: 'sgh' },
            { name_ar: 'مركز الرعاية الصحية الاولية بالعزيزية شرورة', name_en: 'Aziziyah PHCC Sharoora', lat: 17.49644463, lng: 47.11248781, zone: 'sgh' },
            { name_ar: 'مركز الرعاية الصحية الاولية بالوديعة شرورة', name_en: 'Alwadia PHCC Sharoora', lat: 17.05604376, lng: 47.09488983, zone: 'sgh' },
            { name_ar: 'مركز الرعاية الصحية الاولية بسلطانه شرورة', name_en: 'Sultanaa PHCC Sharoora', lat: 17.48100418, lng: 47.11810708, zone: 'sgh' },
            { name_ar: 'تماني', name_en: 'Tamani PHCC Sharoura', lat: 17.48500000, lng: 47.11500000, zone: 'sgh' },
            { name_ar: 'مركز صحي الاخاشيم', name_en: 'Alakashim Health Center', lat: 17.7212795, lng: 47.2143375, zone: 'sgh' },
            { name_ar: 'خالدية شرورة', name_en: 'Khaldiya Sharoora Health Center', lat: 17.49589037, lng: 47.12088168, zone: 'sgh' },
            { name_ar: 'مركز الرعاية الصحية الاولية بتصلال', name_en: 'Taslal Health Center', lat: 17.63142516, lng: 44.4718774, zone: 'kgh' },
            { name_ar: 'مركز الرعاية الصحية الأولية بالمشعلية', name_en: 'Mishaliya', lat: 17.7596349, lng: 44.46164075, zone: 'kgh' },
            { name_ar: 'مركز الرعاية الصحية الأولية بجنوب المطار', name_en: 'Junoob Matar', lat: 17.5939663, lng: 44.44931437, zone: 'kgh' },
            { name_ar: 'مركز الرعايةالصحية الأولية الغويلة', name_en: 'Primary Health Care Center GOILLA', lat: 17.60163679, lng: 44.52500373, zone: 'kgh' },
            { name_ar: 'مركز صحي الخرعاء', name_en: 'AL-SHARAA', lat: 17.53103729, lng: 44.56510464, zone: 'kgh' },
            { name_ar: 'مركز صحي خباش', name_en: 'KHUBASH Health center', lat: 17.55435111, lng: 44.70508114, zone: 'kgh' },
            { name_ar: 'مركز الرعاية الصحية الاولية بـ الشرفة', name_en: 'Primary Health Care Center of Shurfa', lat: 17.51436563, lng: 44.29527963, zone: 'nngh' },
            { name_ar: 'مركز الرعاية الصحية الاولية بالحمر', name_en: 'Alhamar PHCC', lat: 17.46992373, lng: 44.18192437, zone: 'nngh' },
            { name_ar: 'مركز الرعاية الصحية الاولية ببرك', name_en: 'Primary Health Care Center Barrk', lat: 17.5619045, lng: 44.33461938, zone: 'nngh' },
            { name_ar: 'مركز الرعاية الصحية بالحصينية', name_en: 'HUSSAINIAH PHCC', lat: 17.81193406, lng: 44.44693271, zone: 'nngh' },
            { name_ar: 'مركز صحي العريسة', name_en: 'Al Arisa Health Center', lat: 17.56253263, lng: 44.30852923, zone: 'nngh' },
            { name_ar: 'مركز صحي رجلاء', name_en: 'RIJLA PHCC', lat: 17.4974044, lng: 44.21335344, zone: 'nngh' },
            { name_ar: 'مركز صحي وادي ريمان', name_en: 'Wadi Riman Health Center', lat: 17.5455171, lng: 44.38632901, zone: 'nngh' },
            { name_ar: 'البلد', name_en: 'Albalad', lat: 17.49420914, lng: 44.13150175, zone: 'wnh' },
            { name_ar: 'مركز الرعاية الصحية الاولية بالجربة', name_en: 'Health Center in Aljurbah', lat: 17.47110123, lng: 44.15016604, zone: 'wnh' },
            { name_ar: 'مركز الرعاية الصحية الأولية بأبا السعود', name_en: 'PHCC Abasoud', lat: 17.48452285, lng: 44.12842703, zone: 'wnh' },
            { name_ar: 'مركز الرعايه الصحيه الاوليه بالموفجة', name_en: 'Health Center Al Mufja', lat: 17.43864766, lng: 44.05285434, zone: 'wnh' },
            { name_ar: 'مركز صحي الحضن', name_en: 'Alhadan PHCC', lat: 17.45825564, lng: 44.12599991, zone: 'wnh' },
            { name_ar: 'مركز صحي الصفا', name_en: 'Al Safa Health Center', lat: 17.4633955, lng: 44.07759645, zone: 'wnh' },
            { name_ar: 'مركز صحي القابل', name_en: 'Health Center Algabil', lat: 17.48997978, lng: 44.19169454, zone: 'wnh' },
            { name_ar: 'دحضه', name_en: 'Dahada Health Center', lat: 17.51695355, lng: 44.16039583, zone: 'wnh' },
            { name_ar: 'المراطه', name_en: 'Al muratah phcc', lat: 17.48982264, lng: 44.10260304, zone: 'wnh' },
            { name_ar: 'مركز صحي شعب رير', name_en: 'Eam PHCC Reer', lat: 17.46419144, lng: 44.16237482, zone: 'wnh' },
            { name_ar: 'مركز صحي الشبهان', name_en: 'Shebhan PHCC', lat: 17.48417091, lng: 44.12151161, zone: 'wnh' },
            { name_ar: 'مركز الرعاية الصحية الأولية بنهوقة', name_en: 'Primary Health Care Center in Nhogah', lat: 17.44634448, lng: 44.10357423, zone: 'wnh' },
            { name_ar: 'مركز صحي الاثايبه', name_en: 'Atheabah PHCC', lat: 17.554978, lng: 44.252263, zone: 'mch' },
            { name_ar: 'مركز صحي حي الفهد الجنوبي', name_en: 'Al Fahad Al Janubi PHCC', lat: 17.56809955, lng: 44.22254192, zone: 'mch' },
            { name_ar: 'مركز الرعاية الصحية الاولية بالخالدية بنجران', name_en: 'Khaldiya Health Center', lat: 17.54325635, lng: 44.23095685, zone: 'kkh' },
            { name_ar: 'مركز الرعاية الصحية الاولية بحي الفهد الشمالي', name_en: 'Primary Health Care Center North', lat: 17.57525868, lng: 44.23019571, zone: 'kkh' },
            { name_ar: 'مركز الرعاية الصحية الأولية بحي الضباط', name_en: 'ALDUBAT PHCC', lat: 17.53174619, lng: 44.20465925, zone: 'kkh' },
            { name_ar: 'مركز الرعاية الصحية الأولية بحي الفيصلية', name_en: 'Al Faisaliah Health Center', lat: 17.52434888, lng: 44.18856931, zone: 'kkh' },
            { name_ar: 'مركز الرعاية الصحية الأولية بئر عسكر', name_en: 'Biraskar PHCC', lat: 17.5758571, lng: 44.04300509, zone: 'kkh' },
            { name_ar: 'مركز صحي الأمير مشعل', name_en: 'Prince Mishal Health Center', lat: 17.55814636, lng: 44.23037093, zone: 'kkh' },
            { name_ar: 'مركز صحي الضيافة', name_en: 'Primary Health Care Center DIYAFA', lat: 17.54117504, lng: 44.21656854, zone: 'kkh' },
            { name_ar: 'مركز صحي الكنتوب', name_en: 'Al Contub', lat: 17.52613818, lng: 44.20995694, zone: 'kkh' },
            { name_ar: 'مركز صحي عاكفه', name_en: 'Aqfah PHCC', lat: 17.49513154, lng: 43.74081721, zone: 'kkh' },
            { name_ar: 'مركز الرعاية الصحية الاولية بالجفه', name_en: 'AL JAFFAH PHCC', lat: 17.77329562, lng: 43.91604472, zone: 'hgh' },
            { name_ar: 'مركز الرعاية الصحية الاولية بالحرشف', name_en: 'Al Harshar PHCC', lat: 17.67157909, lng: 43.88503866, zone: 'hgh' },
            { name_ar: 'المنتشر', name_en: 'ALMONTSHER  PHCC', lat: 17.88795838, lng: 44.171646, zone: 'hgh' },
            { name_ar: 'مركز الرعاية الصحية الأولية بحبونا', name_en: 'Habuna Primary Health Care Center', lat: 17.85048519, lng: 44.01969491, zone: 'hgh' },
            { name_ar: 'مركز الرعاية الصحية بالضيقة', name_en: 'Dekah', lat: 17.85470235, lng: 44.27155056, zone: 'hgh' },
            { name_ar: 'المجمع', name_en: 'Majma', lat: 17.75457056, lng: 43.96086896, zone: 'hgh' },
            { name_ar: 'مركز الرعاية الاولية الخانق', name_en: 'Primary Care Alkhaniq', lat: 17.74396059, lng: 43.76283045, zone: 'bgh' },
            { name_ar: 'مركز صحي القرن', name_en: 'AL- qarn', lat: 17.75285114, lng: 43.71795687, zone: 'bgh' },
            { name_ar: 'مركز صحي الرحاب', name_en: 'Alrehab Primary Care Center', lat: 18.00721995, lng: 43.89921, zone: 'bgh' },
            { name_ar: 'مركز صحي المليحة', name_en: 'Maleha Public Health Center', lat: 17.99223082, lng: 43.82004094, zone: 'bgh' },
            { name_ar: 'مركز صحي بدر الجنوب', name_en: 'Bader Aljanoob Primary Health Care', lat: 17.8788742, lng: 43.71604, zone: 'bgh' },
            { name_ar: 'مركز صحي هداده', name_en: 'Hadadah Health Center', lat: 17.61097958, lng: 43.75963065, zone: 'bgh' },
            { name_ar: 'مركز الرعاية الصحية الاولية بوادي وسط', name_en: 'Wadi Wasat', lat: 18.29824487, lng: 44.20244981, zone: 'ygh' },
            { name_ar: 'مركز الرعاية الصحية الاولية يدمة', name_en: 'Yadama Primary Health Care Center', lat: 18.53280931, lng: 44.20531118, zone: 'ygh' },
            { name_ar: 'مركز صحي اللجام', name_en: 'Legam Primary Health Care Center', lat: 18.59928839, lng: 44.18008645, zone: 'ygh' },
            { name_ar: 'سلطانة يدمة', name_en: 'Sultana Primary Health Care Center', lat: 18.85983969, lng: 45.11052394, zone: 'ygh' },
            { name_ar: 'المحمدية', name_en: 'Mohammadia PHCC', lat: 18.4440713, lng: 44.79583144, zone: 'ygh' },
            { name_ar: 'مركز صحي الصفاح', name_en: 'Suffah PHCC', lat: 18.1823639, lng: 44.33625415, zone: 'tgh' },
            { name_ar: 'مركز صحي ثار', name_en: 'Thar PHCC', lat: 17.97677191, lng: 44.10630215, zone: 'tgh' },
            { name_ar: 'مركز صحي حما', name_en: 'Hema PHCC', lat: 18.20931322, lng: 44.48405551, zone: 'tgh' },
            { name_ar: 'مركز صحي طلحام', name_en: 'Talham PHCC', lat: 18.27707155, lng: 43.995497, zone: 'tgh' },
            { name_ar: 'مركز صحي قطن', name_en: 'Qattan PHCC', lat: 18.13527449, lng: 44.12734562, zone: 'tgh' },
            { name_ar: 'تلاع', name_en: 'tilah phcc', lat: 18.0529148, lng: 43.98022, zone: 'tgh' },
            { name_ar: 'مركزصحي نعوان', name_en: 'Naiwan PHCC', lat: 18.29489278, lng: 43.87686073, zone: 'tgh' }
        ];

        // PHC name lookup for bilingual display
        const phcNameLookup = {};
        healthcareCenters.forEach(({ name_ar, name_en }) => {
            const enKey = normalizeKey(name_en);
            const arKey = normalizeKey(name_ar);
            if (enKey) phcNameLookup[enKey] = { ar: name_ar || name_en, en: name_en || name_ar };
            if (arKey) phcNameLookup[arKey] = { ar: name_ar || name_en, en: name_en || name_ar };
        });
        const formatPhcName = (raw) => {
            const key = String(raw || '').trim();
            if (!key) return '';
            // Fix common typos before lookup
            let correctedKey = key;
            correctedKey = correctedKey.replace(/\bhelth\b/gi, 'health');
            correctedKey = correctedKey.replace(/\bhealh\b/gi, 'health');
            correctedKey = correctedKey.replace(/\bhelath\b/gi, 'health');
            correctedKey = correctedKey.replace(/\bprimaryhealth\b/gi, 'primary health');
            correctedKey = correctedKey.replace(/\bprimary\s*health\s+care\s+center\b/gi, 'primary health care center');
            correctedKey = correctedKey.replace(/\bsharoorah\b/gi, 'sharoora');
            const normalizedKey = normalizeKey(correctedKey);
            let hit = phcNameLookup[normalizedKey];
            // If not found, try fuzzy matching for common variations
            if (!hit) {
                // Try matching with case-insensitive partial match
                const searchKey = normalizedKey;
                for (const [lookupKey, value] of Object.entries(phcNameLookup)) {
                    if (lookupKey.includes(searchKey) || searchKey.includes(lookupKey)) {
                        // Check if it's a reasonable match (same core name)
                        if (searchKey.replace(/\s+/g, '') === lookupKey.replace(/\s+/g, '')) {
                            hit = value;
                            break;
                        }
                    }
                }
            }
            if (hit) {
                if (currentLang === 'ar') {
                    let arName = hit.ar || key;
                    // Remove common prefixes
                    arName = arName.replace(/^مركز الرعاية الصحية الاولية\s+/i, '');
                    arName = arName.replace(/^مركز الرعاية الصحية الأولية\s+/i, '');
                    arName = arName.replace(/^مركز الرعايةالصحية الأولية\s+/i, '');
                    arName = arName.replace(/^مركز الرعايه الصحيه الاوليه\s+/i, '');
                    arName = arName.replace(/^مركز الرعاية الاولية\s+/i, '');
                    arName = arName.replace(/^مركز الرعايه الصحية\s+/i, '');
                    arName = arName.replace(/^مركز الرعاية الصحية\s+/i, '');
                    arName = arName.replace(/^مركز صحي\s+/i, '');
                    // Remove "ب" from start except for "بدر الجنوب"
                    if (arName.startsWith('ب') && !arName.startsWith('بدر الجنوب')) {
                        arName = arName.substring(1).trim();
                    }
                    return arName;
                }
                return hit.en || key;
            }
            // If not found, try to find a partial match or return original if already Arabic
            if (/[\u0600-\u06FF]/.test(key)) {
                // Already Arabic, try to clean it
                let arName = key;
                arName = arName.replace(/^مركز الرعاية الصحية الاولية\s+/i, '');
                arName = arName.replace(/^مركز الرعاية الصحية الأولية\s+/i, '');
                arName = arName.replace(/^مركز الرعايةالصحية الأولية\s+/i, '');
                arName = arName.replace(/^مركز الرعايه الصحيه الاوليه\s+/i, '');
                arName = arName.replace(/^مركز الرعاية الاولية\s+/i, '');
                arName = arName.replace(/^مركز الرعايه الصحية\s+/i, '');
                arName = arName.replace(/^مركز الرعاية الصحية\s+/i, '');
                arName = arName.replace(/^مركز صحي\s+/i, '');
                if (arName.startsWith('ب') && !arName.startsWith('بدر الجنوب')) {
                    arName = arName.substring(1).trim();
                }
                return arName;
            }
            return key;
        };
        const formatZoneName = (zoneCode) => {
            const zn = zoneNames[zoneCode.toLowerCase()] || { ar: zoneCode, en: zoneCode };
            return currentLang === 'ar' ? zn.ar : zn.en;
        };

        const createMinimalIcon = (color) => L.divIcon({
            className: 'minimal-marker',
            html: `<div style="width: 8px; height: 8px; background-color: ${color}; border-radius: 50%;"></div>`,
            iconSize: [8, 8],
            iconAnchor: [4, 4]
        });

        const healthcareMarkers = [];
        healthcareCenters.forEach(center => {
            const iconColor = zoneColors[center.zone] || '#2c3e50';
            const marker = L.marker([center.lat, center.lng], { icon: createMinimalIcon(iconColor) });
            const zn = zoneNames[center.zone] || { ar: '', en: center.zone.toUpperCase() };
            const markerLabel = () => {
                const zoneText = currentLang === 'ar' ? `${zn.ar}` : `${zn.en}`;
                const nameText = formatPhcName(center.name_en || center.name_ar);
                return `${nameText}<br>${zoneText}`;
            };
            marker.bindTooltip(markerLabel(), {
                direction: 'top',
                offset: [0, -4],
                opacity: 0.95
            });
            marker.addTo(map);
            marker.on('click', () => marker.openTooltip());
            marker.on('mouseover', () => marker.openTooltip());
            healthcareMarkers.push({ marker, center, zn });
        });

        // Fit bounds around all polygons (default view)
        const all = [
            sghZoneCoordinates,kghZoneCoordinates,nnghZoneCoordinates,wnhZoneCoordinates,
            mchZoneCoordinates,kkhZoneCoordinates,tghZoneCoordinates,bghZoneCoordinates,
            yghZoneCoordinates,hghZoneCoordinates
        ].map(c => L.polygon(c));
        const group = new L.featureGroup(all);
        const defaultBounds = group.getBounds();
        map.fitBounds(defaultBounds, { padding: [50,50] });

        // Initial labels (none until a zone is selected)
        applyZoneLabels(null);

        // Language toggle behavior
        const langArBtn = document.getElementById('langAr');
        const langEnBtn = document.getElementById('langEn');
        const langLabels = document.querySelectorAll('.topbar-stat .label span[data-lang]');

        const setLang = (lang) => {
            currentLang = lang;
            // Set text direction: RTL for Arabic, LTR for English
            const html = document.documentElement;
            const body = document.body;
            if (html) {
                html.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');
                html.setAttribute('lang', lang === 'ar' ? 'ar' : 'en');
            }
            if (body) {
                body.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');
            }
            if (langArBtn && langEnBtn) {
                langArBtn.classList.toggle('active', lang === 'ar');
                langEnBtn.classList.toggle('active', lang === 'en');
            }
            if (langLabels) {
                langLabels.forEach(span => {
                    const isAr = span.getAttribute('data-lang') === 'ar';
                    span.style.display = (lang === 'ar' && isAr) || (lang === 'en' && !isAr) ? 'inline' : 'none';
                });
            }
            // Update report button text
            if (generateReportBtn) {
                const btnSpans = generateReportBtn.querySelectorAll('span[data-lang]');
                btnSpans.forEach(span => {
                    const isAr = span.getAttribute('data-lang') === 'ar';
                    span.style.display = (lang === 'ar' && isAr) || (lang === 'en' && !isAr) ? 'inline' : 'none';
                });
            }
            applyZoneLabels(lastZoneId);
            healthcareMarkers.forEach(({ marker, center, zn }) => {
                const zoneText = currentLang === 'ar' ? `${zn.ar}` : `${zn.en}`;
                const nameText = formatPhcName(center.name_en || center.name_ar);
                marker.bindTooltip(`${nameText}<br>${zoneText}`, {
                    direction: 'top',
                    offset: [0, -4],
                    opacity: 0.95
                });
            });
            showTopbar(lastZoneId || null);
        };

        // Topbar controls
        const topbar = document.getElementById('topbar');
        const topbarTitle = document.getElementById('topbarTitle');
        const topbarSub = document.getElementById('topbarSub');
        const topbarControlled = document.getElementById('topbarControlled');
        const topbarUncontrolled = document.getElementById('topbarUncontrolled');
        const topbarPreDmNormal = document.getElementById('topbarPreDmNormal');
        const topbarPreDmStill = document.getElementById('topbarPreDmStill');
        const topbarScreened = document.getElementById('topbarScreened');
        const topbarTarget = document.getElementById('topbarTarget');
        const topbarRemaining = document.getElementById('topbarRemaining');
        const phcTopScreening = document.getElementById('phcTopScreening');
        const phcTopDm = document.getElementById('phcTopDm');
        const phcTopPreDm = document.getElementById('phcTopPreDm');
        const generateReportBtn = document.getElementById('generateReportBtn');
        let lastZoneId = null;

        const showTopbar = (zoneId) => {
            const id = zoneId || clusterId;
            lastZoneId = id;
            if (!topbar) return;
            const zn = zoneNames[id] || { ar: 'تجمع نجران الصحي', en: 'Najran Health Cluster' };
            const title = currentLang === 'ar' ? zn.ar : zn.en;
            const sub = currentLang === 'ar' ? zn.en : zn.ar;
            if (topbarTitle) topbarTitle.textContent = title;
            if (topbarSub) topbarSub.textContent = sub;
            const zoneKey = id.toUpperCase();
            const zstats = dmStatsByZone[zoneKey] || {};
            const total = (Number(zstats.controlled) || 0) + (Number(zstats.uncontrolled) || 0);
            if (topbarControlled) topbarControlled.innerHTML = formatCountPct(zstats.controlled, total);
            if (topbarUncontrolled) topbarUncontrolled.innerHTML = formatCountPct(zstats.uncontrolled, total);
            const pstats = preDmStatsByZone[zoneKey] || {};
            const ptotal = (Number(pstats.normal) || 0) + (Number(pstats.still) || 0);
            if (topbarPreDmNormal) topbarPreDmNormal.innerHTML = formatCountPct(pstats.normal, ptotal);
            if (topbarPreDmStill) topbarPreDmStill.innerHTML = formatCountPct(pstats.still, ptotal);
            const sstats = screeningStatsByZone[zoneKey] || {};
            const rawTarget = Number(sstats.target) || 0;
            const adjTarget = Math.round(rawTarget * 0.5);
            if (topbarScreened) topbarScreened.innerHTML = formatCountPct(sstats.screened, adjTarget);
            if (topbarTarget) topbarTarget.textContent = Number.isFinite(adjTarget) ? adjTarget : '--';
            if (topbarRemaining) {
                const screenedVal = Number(sstats.screened) || 0;
                const remaining = Number.isFinite(adjTarget) ? Math.max(adjTarget - screenedVal, 0) : null;
                topbarRemaining.textContent = Number.isFinite(remaining) ? remaining : '--';
            }
            buildTopPhcLists(zoneKey);
            // Show report button only for zones (not cluster)
            const isZoneSelected = id && id !== clusterId;
            if (generateReportBtn) {
                generateReportBtn.style.display = isZoneSelected ? 'block' : 'none';
            }
            topbar.classList.add('active');
        };

        const filterDmRows = (zoneKey, type) => {
            const targetZone = zoneKey && zoneKey.toUpperCase() !== clusterId.toUpperCase() ? zoneKey.toUpperCase() : null;
            return dmRaw.filter(row => {
                const z = (row.LAST_VISIT_ZONE || row.Zone || '').toUpperCase();
                if (targetZone && z !== targetZone) return false;
                const status = String(row.CONTROL_STATUS || '').trim().toLowerCase();
                if (type === 'controlled') return CONTROLLED_STATUSES.includes(status);
                if (type === 'uncontrolled') return UNCONTROLLED_STATUSES.includes(status);
                return false;
            });
        };

        const filterPreDmRows = (zoneKey, type) => {
            const targetZone = zoneKey && zoneKey.toUpperCase() !== clusterId.toUpperCase() ? zoneKey.toUpperCase() : null;
            return preDmRaw.filter(row => {
                const z = (row.LAST_VISIT_ZONE || row.Zone || '').toUpperCase();
                if (targetZone && z !== targetZone) return false;
                const status = String(row.STATUS || '').trim().toLowerCase();
                if (type === 'normal') return PRE_DM_NORMAL_STATUSES.includes(status);
                if (type === 'still') return PRE_DM_STILL_STATUSES.includes(status);
                return false;
            });
        };

        const filterScreeningRows = (zoneKey, type) => {
            const targetZone = zoneKey && zoneKey.toUpperCase() !== clusterId.toUpperCase() ? zoneKey.toUpperCase() : null;
            const rows = screeningRaw.filter(row => {
                const z = (row.Zone || row.LAST_VISIT_ZONE || '').toUpperCase();
                if (targetZone && z !== targetZone) return false;
                return true;
            });
            const isScreened = (r) => isYes(r.HAS_LAB) || (!isYes(r.REMAINING) && isYes(r.IS_TARGETED));
            const inTarget = (r) => isYes(r.IS_TARGETED);
            if (type === 'screened') return rows.filter(r => inTarget(r) && isScreened(r));
            if (type === 'target') return rows.filter(inTarget);
            if (type === 'remaining') {
                const targetList = rows.filter(inTarget);
                const screenedList = targetList.filter(isScreened);
                const rawTarget = targetList.length;
                const adjTarget = Math.round(rawTarget * 0.5);
                const remainingCount = Math.max(adjTarget - screenedList.length, 0);
                const remainingList = targetList.filter(r => !isScreened(r));
                return remainingList.slice(0, remainingCount);
            }
            return [];
        };

        const generateZoneReport = (zoneKey) => {
            const targetZone = zoneKey && zoneKey.toUpperCase() !== clusterId.toUpperCase() ? zoneKey.toUpperCase() : null;
            if (!targetZone) return; // Don't generate for cluster

            // Aggregate stats by PHC
            const reportData = [];

            // Screening stats by PHC
            const screeningByPhc = {};
            screeningRaw.forEach(r => {
                const z = (r.Zone || r.LAST_VISIT_ZONE || '').toUpperCase();
                if (z !== targetZone) return;
                const phc = (r.PHC || r.PHC_NAME || '').trim();
                if (!phc) return;
                const target = isYes(r.IS_TARGETED);
                const screened = isYes(r.HAS_LAB) || (!isYes(r.REMAINING) && target);
                if (!screeningByPhc[phc]) screeningByPhc[phc] = { screened: 0, target: 0 };
                if (target) screeningByPhc[phc].target += 1;
                if (screened) screeningByPhc[phc].screened += 1;
            });

            // DM stats by PHC
            const dmByPhc = {};
            dmRaw.forEach(r => {
                const z = (r.LAST_VISIT_ZONE || r.Zone || '').toUpperCase();
                if (z !== targetZone) return;
                const phc = (r.LAST_VISIT_PHC || r.PHC || '').trim();
                if (!phc) return;
                const status = String(r.CONTROL_STATUS || '').trim().toLowerCase();
                if (!dmByPhc[phc]) dmByPhc[phc] = { controlled: 0, uncontrolled: 0 };
                if (CONTROLLED_STATUSES.includes(status)) dmByPhc[phc].controlled += 1;
                if (UNCONTROLLED_STATUSES.includes(status)) dmByPhc[phc].uncontrolled += 1;
            });

            // Pre-DM stats by PHC
            const preDmByPhc = {};
            preDmRaw.forEach(r => {
                const z = (r.LAST_VISIT_ZONE || r.Zone || '').toUpperCase();
                if (z !== targetZone) return;
                const phc = (r.LAST_VISIT_PHC || r.PHC || '').trim();
                if (!phc) return;
                const status = String(r.STATUS || '').trim().toLowerCase();
                if (!preDmByPhc[phc]) preDmByPhc[phc] = { normal: 0, still: 0 };
                if (PRE_DM_NORMAL_STATUSES.includes(status)) preDmByPhc[phc].normal += 1;
                if (PRE_DM_STILL_STATUSES.includes(status)) preDmByPhc[phc].still += 1;
            });

            // Combine all PHCs
            const allPhcs = new Set([
                ...Object.keys(screeningByPhc),
                ...Object.keys(dmByPhc),
                ...Object.keys(preDmByPhc)
            ]);

            allPhcs.forEach(phc => {
                const scr = screeningByPhc[phc] || { screened: 0, target: 0 };
                const dm = dmByPhc[phc] || { controlled: 0, uncontrolled: 0 };
                const pre = preDmByPhc[phc] || { normal: 0, still: 0 };
                
                const scrAdjTarget = Math.round(scr.target * 0.5);
                const scrRemaining = Math.max(scrAdjTarget - scr.screened, 0);

                reportData.push({
                    PHC: phc,
                    'Total Population 35+': scr.target,
                    'Target': scrAdjTarget,
                    'Screened': scr.screened,
                    'Not Screened': scrRemaining,
                    'DM_Controlled': dm.controlled,
                    'DM_Uncontrolled': dm.uncontrolled,
                    'PreDM_Still': pre.still
                });
            });

            // Sort by PHC name
            reportData.sort((a, b) => a.PHC.localeCompare(b.PHC));
            
            downloadCsv(`zone_report_${targetZone}_${new Date().toISOString().split('T')[0]}.csv`, reportData);
        };

        const exportScreeningRemainingByPhc = (phcRaw, zoneKey, item) => {
            if (!phcRaw) return;
            const targetZone = zoneKey && zoneKey.toUpperCase() !== clusterId.toUpperCase() ? zoneKey.toUpperCase() : null;
            // Use same matching logic as display (trim, not normalizeKey for PHC)
            const phcMatch = (r) => {
                const phc = (r.PHC || r.PHC_NAME || '').trim();
                return normalizeKey(phc) === normalizeKey(phcRaw);
            };
            const targetList = screeningRaw.filter(r => {
                const z = (r.Zone || r.LAST_VISIT_ZONE || '').toUpperCase();
                if (targetZone && z !== targetZone) return false;
                if (!phcMatch(r)) return false;
                return isYes(r.IS_TARGETED);
            });
            // Use precomputed values from display if available, otherwise recalculate
            const screenedCount = item ? item.screened : (() => {
                const isScreened = (r) => {
                    const target = isYes(r.IS_TARGETED);
                    return isYes(r.HAS_LAB) || (!isYes(r.REMAINING) && target);
                };
                return targetList.filter(isScreened).length;
            })();
            const adjTarget = item ? item.adjTarget : Math.round(targetList.length * 0.5);
            const remainingCount = Math.max(adjTarget - screenedCount, 0);
            const unscreenedList = targetList.filter(r => isYes(r.REMAINING));
            const remainingList = unscreenedList.slice(0, Math.min(remainingCount, unscreenedList.length));
            downloadCsv(`screening_remaining_${slugify(phcRaw)}.csv`, remainingList);
        };

        const exportDmUncontrolledByPhc = (phcRaw, zoneKey) => {
            if (!phcRaw) return;
            const targetZone = zoneKey && zoneKey.toUpperCase() !== clusterId.toUpperCase() ? zoneKey.toUpperCase() : null;
            const phcMatch = (r) => {
                const phc = (r.LAST_VISIT_PHC || r.PHC || '').trim();
                return normalizeKey(phc) === normalizeKey(phcRaw);
            };
            const uncontrolledList = dmRaw.filter(r => {
                const z = (r.LAST_VISIT_ZONE || r.Zone || '').toUpperCase();
                if (targetZone && z !== targetZone) return false;
                if (!phcMatch(r)) return false;
                const status = String(r.CONTROL_STATUS || '').trim().toLowerCase();
                return UNCONTROLLED_STATUSES.includes(status);
            });
            downloadCsv(`dm_uncontrolled_${slugify(phcRaw)}.csv`, uncontrolledList);
        };

        const exportPreDmStillByPhc = (phcRaw, zoneKey) => {
            if (!phcRaw) return;
            const targetZone = zoneKey && zoneKey.toUpperCase() !== clusterId.toUpperCase() ? zoneKey.toUpperCase() : null;
            const phcMatch = (r) => {
                const phc = (r.LAST_VISIT_PHC || r.PHC || '').trim();
                return normalizeKey(phc) === normalizeKey(phcRaw);
            };
            const stillList = preDmRaw.filter(r => {
                const z = (r.LAST_VISIT_ZONE || r.Zone || '').toUpperCase();
                if (targetZone && z !== targetZone) return false;
                if (!phcMatch(r)) return false;
                const status = String(r.STATUS || '').trim().toLowerCase();
                return PRE_DM_STILL_STATUSES.includes(status);
            });
            downloadCsv(`predm_still_${slugify(phcRaw)}.csv`, stillList);
        };

        const exportHandlers = {
            'dm-controlled': (zone) => filterDmRows(zone, 'controlled'),
            'dm-uncontrolled': (zone) => filterDmRows(zone, 'uncontrolled'),
            'predm-normal': (zone) => filterPreDmRows(zone, 'normal'),
            'predm-still': (zone) => filterPreDmRows(zone, 'still'),
            'screening-screened': (zone) => filterScreeningRows(zone, 'screened'),
            'screening-target': (zone) => filterScreeningRows(zone, 'target'),
            'screening-remaining': (zone) => filterScreeningRows(zone, 'remaining'),
        };

        const attachExportClicks = () => {
            const buttons = document.querySelectorAll('.substat[data-export]');
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const key = btn.getAttribute('data-export');
                    const zone = (lastZoneId || clusterId).toUpperCase();
                    const fn = exportHandlers[key];
                    if (!fn) return;
                    const rows = fn(zone) || [];
                    downloadCsv(`${key}_${zone}.csv`, rows);
                });
            });
        };

        const slugify = (str) => normalizeKey(str).replace(/[^a-z0-9]+/g, '_').replace(/^_+|_+$/g, '') || 'phc';

        const renderPhcPills = (el, items, onClick) => {
            if (!el) return;
            if (!items || !items.length) {
                el.innerHTML = '';
                return;
            }
            el.innerHTML = items.map(item => {
                if (typeof item === 'string') {
                    return `<span class="phc-pill">${item}</span>`;
                }
                const { label, phc, zone } = item;
                const dataValue = phc || zone || '';
                const dataAttr = zone ? 'data-zone' : 'data-phc';
                const clickable = onClick ? ' phc-pill-clickable' : '';
                return `<span class="phc-pill${clickable}" ${dataAttr}="${dataValue}">${label}</span>`;
            }).join('');
            if (onClick) {
                el.querySelectorAll('.phc-pill-clickable').forEach(span => {
                    span.addEventListener('click', () => {
                        const value = span.getAttribute('data-phc') || span.getAttribute('data-zone') || '';
                        onClick(value);
                    });
                });
            }
        };

        const buildTopPhcLists = (zoneKey) => {
            const targetZone = zoneKey && zoneKey.toUpperCase() !== clusterId.toUpperCase() ? zoneKey.toUpperCase() : null;
            const isClusterMode = !targetZone;

            if (isClusterMode) {
                // Cluster mode: show top 5 zones
                // Screening by zone
                const screeningByZone = {};
                screeningRaw.forEach(r => {
                    const z = (r.Zone || r.LAST_VISIT_ZONE || '').toUpperCase();
                    if (!z) return;
                    const target = isYes(r.IS_TARGETED);
                    const screened = isYes(r.HAS_LAB) || (!isYes(r.REMAINING) && target);
                    if (!screeningByZone[z]) screeningByZone[z] = { screened: 0, target: 0 };
                    if (target) screeningByZone[z].target += 1;
                    if (screened) screeningByZone[z].screened += 1;
                });
                const screeningZoneList = Object.entries(screeningByZone)
                    .map(([zone, v]) => {
                        const adjTarget = Math.round((v.target || 0) * 0.5);
                        const denom = adjTarget > 0 ? adjTarget : 0;
                        const ratio = denom > 0 ? v.screened / denom : 0;
                        return { zone, ...v, adjTarget: denom, ratio };
                    })
                    .filter(x => x.adjTarget > 0 && x.ratio < 1)
                    .sort((a, b) => a.ratio - b.ratio || a.screened - b.screened)
                    .slice(0, 5)
                    .map(item => ({
                        label: `${formatZoneName(item.zone)} • ${item.screened}/${item.adjTarget} (${pctText(item.screened, item.adjTarget)})`,
                        zone: item.zone
                    }));
                renderPhcPills(phcTopScreening, screeningZoneList, (clickedZone) => {
                    showTopbar(clickedZone.toLowerCase());
                    const bounds = polygons[clickedZone.toLowerCase()]?.getBounds();
                    if (bounds && bounds.isValid()) {
                        map.fitBounds(bounds, { padding: [50, 50] });
                    }
                    applyZoneLabels(clickedZone.toLowerCase());
                });
            } else {
                // Zone mode: show top 5 PHCs
                const screeningByPhc = {};
                screeningRaw.forEach(r => {
                    const z = (r.Zone || r.LAST_VISIT_ZONE || '').toUpperCase();
                    if (targetZone && z !== targetZone) return;
                    const phc = (r.PHC || r.PHC_NAME || '').trim();
                    if (!phc) return;
                    const target = isYes(r.IS_TARGETED);
                    const screened = isYes(r.HAS_LAB) || (!isYes(r.REMAINING) && target);
                    if (!screeningByPhc[phc]) screeningByPhc[phc] = { screened: 0, target: 0 };
                    if (target) screeningByPhc[phc].target += 1;
                    if (screened) screeningByPhc[phc].screened += 1;
                });
                const screeningRawList = Object.entries(screeningByPhc)
                    .map(([phc, v]) => {
                        const adjTarget = Math.round((v.target || 0) * 0.5);
                        const denom = adjTarget > 0 ? adjTarget : 0;
                        const ratio = denom > 0 ? v.screened / denom : 0;
                        return { phc, ...v, adjTarget: denom, ratio };
                    })
                    .filter(x => x.adjTarget > 0);
                const screeningList = screeningRawList
                    .filter(x => x.ratio < 1) // exclude 100% or above
                    .sort((a, b) => a.ratio - b.ratio || a.screened - b.screened)
                    .slice(0, 5)
                    .map(item => ({
                        label: `${formatPhcName(item.phc)} • ${pctText(item.screened, item.adjTarget)}`,
                        phc: item.phc,
                        screened: item.screened,
                        adjTarget: item.adjTarget
                    }));
                renderPhcPills(phcTopScreening, screeningList, (clickedPhc) => {
                    const item = screeningList.find(i => normalizeKey(i.phc) === normalizeKey(clickedPhc));
                    exportScreeningRemainingByPhc(clickedPhc, zoneKey, item);
                });
            }

            // DM: controlled / (controlled+uncontrolled)
            if (isClusterMode) {
                const dmByZone = {};
                dmRaw.forEach(r => {
                    const z = (r.LAST_VISIT_ZONE || r.Zone || '').toUpperCase();
                    if (!z) return;
                    const status = String(r.CONTROL_STATUS || '').trim().toLowerCase();
                    if (!dmByZone[z]) dmByZone[z] = { controlled: 0, uncontrolled: 0 };
                    if (CONTROLLED_STATUSES.includes(status)) dmByZone[z].controlled += 1;
                    if (UNCONTROLLED_STATUSES.includes(status)) dmByZone[z].uncontrolled += 1;
                });
                const dmZoneList = Object.entries(dmByZone)
                    .map(([zone, v]) => {
                        const total = v.controlled + v.uncontrolled;
                        const ratio = total > 0 ? v.controlled / total : 0;
                        return { zone, ...v, total, ratio };
                    })
                    .filter(x => x.uncontrolled > 0)
                    .sort((a, b) => b.uncontrolled - a.uncontrolled)
                    .slice(0, 5)
                    .map(item => ({
                        label: `${formatZoneName(item.zone)} • ${item.controlled}/${item.total} (${pctText(item.controlled, item.total)})`,
                        zone: item.zone
                    }));
                renderPhcPills(phcTopDm, dmZoneList, (clickedZone) => {
                    showTopbar(clickedZone.toLowerCase());
                    const bounds = polygons[clickedZone.toLowerCase()]?.getBounds();
                    if (bounds && bounds.isValid()) {
                        map.fitBounds(bounds, { padding: [50, 50] });
                    }
                    applyZoneLabels(clickedZone.toLowerCase());
                });
            } else {
                const dmByPhc = {};
                dmRaw.forEach(r => {
                    const z = (r.LAST_VISIT_ZONE || r.Zone || '').toUpperCase();
                    if (targetZone && z !== targetZone) return;
                    const phc = (r.LAST_VISIT_PHC || r.PHC || '').trim();
                    if (!phc) return;
                    const status = String(r.CONTROL_STATUS || '').trim().toLowerCase();
                    if (!dmByPhc[phc]) dmByPhc[phc] = { controlled: 0, uncontrolled: 0 };
                    if (CONTROLLED_STATUSES.includes(status)) dmByPhc[phc].controlled += 1;
                    if (UNCONTROLLED_STATUSES.includes(status)) dmByPhc[phc].uncontrolled += 1;
                });
                const dmList = Object.entries(dmByPhc)
                    .map(([phc, v]) => {
                        const total = v.controlled + v.uncontrolled;
                        const ratio = total > 0 ? v.controlled / total : 0;
                        return { phc, ...v, total, ratio };
                    })
                    .filter(x => x.uncontrolled > 0) // only PHCs with uncontrolled patients
                    .sort((a, b) => b.uncontrolled - a.uncontrolled) // sort by uncontrolled count (descending)
                    .slice(0, 5)
                    .map(item => ({
                        label: `${formatPhcName(item.phc)} • ${pctText(item.controlled, item.total)}`,
                        phc: item.phc
                    }));
                renderPhcPills(phcTopDm, dmList, (clickedPhc) => {
                    exportDmUncontrolledByPhc(clickedPhc, zoneKey);
                });
            }

            // Pre-DM: back to normal / total pre-dm
            if (isClusterMode) {
                const preByZone = {};
                preDmRaw.forEach(r => {
                    const z = (r.LAST_VISIT_ZONE || r.Zone || '').toUpperCase();
                    if (!z) return;
                    const status = String(r.STATUS || '').trim().toLowerCase();
                    if (!preByZone[z]) preByZone[z] = { normal: 0, still: 0 };
                    if (PRE_DM_NORMAL_STATUSES.includes(status)) preByZone[z].normal += 1;
                    if (PRE_DM_STILL_STATUSES.includes(status)) preByZone[z].still += 1;
                });
                const preZoneList = Object.entries(preByZone)
                    .map(([zone, v]) => {
                        const total = v.normal + v.still;
                        const ratio = total > 0 ? v.normal / total : 0;
                        return { zone, ...v, total, ratio };
                    })
                    .filter(x => x.still > 0)
                    .sort((a, b) => b.still - a.still)
                    .slice(0, 5)
                    .map(item => ({
                        label: `${formatZoneName(item.zone)} • ${item.still}/${item.total} (${pctText(item.still, item.total)})`,
                        zone: item.zone
                    }));
                renderPhcPills(phcTopPreDm, preZoneList, (clickedZone) => {
                    showTopbar(clickedZone.toLowerCase());
                    const bounds = polygons[clickedZone.toLowerCase()]?.getBounds();
                    if (bounds && bounds.isValid()) {
                        map.fitBounds(bounds, { padding: [50, 50] });
                    }
                    applyZoneLabels(clickedZone.toLowerCase());
                });
            } else {
                const preByPhc = {};
                preDmRaw.forEach(r => {
                    const z = (r.LAST_VISIT_ZONE || r.Zone || '').toUpperCase();
                    if (targetZone && z !== targetZone) return;
                    const phc = (r.LAST_VISIT_PHC || r.PHC || '').trim();
                    if (!phc) return;
                    const status = String(r.STATUS || '').trim().toLowerCase();
                    if (!preByPhc[phc]) preByPhc[phc] = { normal: 0, still: 0 };
                    if (PRE_DM_NORMAL_STATUSES.includes(status)) preByPhc[phc].normal += 1;
                    if (PRE_DM_STILL_STATUSES.includes(status)) preByPhc[phc].still += 1;
                });
                const preList = Object.entries(preByPhc)
                    .map(([phc, v]) => {
                        const total = v.normal + v.still;
                        const ratio = total > 0 ? v.normal / total : 0;
                        return { phc, ...v, total, ratio };
                    })
                    .filter(x => x.still > 0) // only PHCs with still Pre-DM patients
                    .sort((a, b) => b.still - a.still) // sort by still count (descending)
                    .slice(0, 5)
                    .map(item => ({
                        label: `${formatPhcName(item.phc)} • ${pctText(item.still, item.total)}`,
                        phc: item.phc
                    }));
                renderPhcPills(phcTopPreDm, preList, (clickedPhc) => {
                    exportPreDmStillByPhc(clickedPhc, zoneKey);
                });
            }
        };

        // Zone navigation (ordered list)
        const zoneOrder = ['sgh', 'kgh', 'nngh', 'wnh', 'mch', 'kkh', 'tgh', 'bgh', 'ygh', 'hgh'];
        
        const navigateToZone = (direction) => {
            let currentZone = lastZoneId;
            // If viewing cluster or no zone selected, start from first zone
            if (!currentZone || currentZone === clusterId) {
                currentZone = zoneOrder[0];
            } else {
                const currentIndex = zoneOrder.indexOf(currentZone.toLowerCase());
                if (currentIndex === -1) {
                    currentZone = zoneOrder[0];
                } else {
                    if (direction === 'next') {
                        const nextIndex = (currentIndex + 1) % zoneOrder.length;
                        currentZone = zoneOrder[nextIndex];
                    } else {
                        const prevIndex = (currentIndex - 1 + zoneOrder.length) % zoneOrder.length;
                        currentZone = zoneOrder[prevIndex];
                    }
                }
            }
            // Navigate to the zone
            showTopbar(currentZone);
            const poly = polygons[currentZone];
            if (poly) {
                const bounds = poly.getBounds();
                if (bounds && bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
                applyZoneLabels(currentZone);
            }
        };

        // Zone navigation buttons
        const zoneNavLeft = document.getElementById('zoneNavLeft');
        const zoneNavRight = document.getElementById('zoneNavRight');
        if (zoneNavLeft) {
            zoneNavLeft.addEventListener('click', () => navigateToZone('prev'));
        }
        if (zoneNavRight) {
            zoneNavRight.addEventListener('click', () => navigateToZone('next'));
        }

        // Zone click => show topbar
        Object.entries(polygons).forEach(([id, poly]) => {
            poly.on('click', (e) => {
                L.DomEvent.stopPropagation(e); // prevent map click from closing immediately
                showTopbar(id);
                const bounds = poly.getBounds();
                if (bounds && bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
                applyZoneLabels(id);
            });
        });

        // Click outside zones: show cluster default and zoom to default
        map.on('click', () => {
            showTopbar(clusterId);
            applyZoneLabels(null);
            if (defaultBounds && defaultBounds.isValid()) {
                map.fitBounds(defaultBounds, { padding: [50, 50] });
            }
        });

        if (langArBtn) langArBtn.addEventListener('click', () => setLang('ar'));
        if (langEnBtn) langEnBtn.addEventListener('click', () => setLang('en'));
        if (generateReportBtn) {
            generateReportBtn.addEventListener('click', () => {
                const currentZone = lastZoneId || clusterId;
                if (currentZone && currentZone !== clusterId) {
                    generateZoneReport(currentZone);
                }
            });
        }
        attachExportClicks();
        // Ensure initial labels/tooltips respect the default language
        dmStatsReady = loadDmStats();
        preDmStatsReady = loadPreDmStats();
        screeningStatsReady = loadScreeningStats();
        Promise.allSettled([dmStatsReady, preDmStatsReady, screeningStatsReady]).finally(() => {
            setLang(currentLang);
            showTopbar(clusterId);
        });
    </script>
</body>
</html>

